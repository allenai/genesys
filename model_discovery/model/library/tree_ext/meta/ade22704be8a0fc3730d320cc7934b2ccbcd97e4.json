{"paperId": "ade22704be8a0fc3730d320cc7934b2ccbcd97e4", "title": "Striped Attention: Faster Ring Attention for Causal Transformers", "abstract": "To help address the growing demand for ever-longer sequence lengths in transformer models, Liu et al. recently proposed Ring Attention, an exact attention algorithm capable of overcoming per-device memory bottle- necks by distributing self-attention across multiple devices. In this paper, we study the performance characteristics of Ring Attention in the important special case of causal transformer models, and identify a key workload imbal- ance due to triangular structure of causal attention computations. We propose a simple extension to Ring Attention, which we call Striped Attention to fix this imbalance. Instead of devices having contiguous subsequences, each device has a subset of tokens distributed uniformly throughout the sequence, which we demonstrate leads to more even workloads. In experiments running Striped Attention on A100 GPUs and TPUv4s, we are able to achieve up to 1.45x end-to-end throughput improvements over the original Ring Attention algorithm on causal transformer training at a sequence length of 256k. Furthermore, on 16 TPUv4 chips, we were able to achieve 1.65x speedups at sequence lengths of 786k. We release the code for our experiments as open source", "venue": "arXiv.org", "year": 2023, "citationCount": 13, "influentialCitationCount": 1, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "This paper proposes a simple extension to Ring Attention, which it is demonstrated leads to more even workloads, and proposes Striped Attention, a subset of tokens distributed uniformly throughout the sequence, which is able to achieve up to 1.45x end-to-end throughput improvements."}, "embedding": {"model": "specter_v2", "vector": [0.47154876589775085, 0.6439018249511719, -0.7315791845321655, 0.42856255173683167, -0.030439510941505432, -0.11633113771677017, 0.6333967447280884, -0.0627749040722847, -0.002668035216629505, -0.19600310921669006, 0.5406885743141174, -0.06260214745998383, 0.20861169695854187, 0.09920251369476318, -0.17900578677654266, 0.34137317538261414, -0.7456915974617004, 0.295149564743042, 0.2806108295917511, 0.028827764093875885, 0.44991809129714966, -0.4806603491306305, -1.5413039922714233, 0.3412238657474518, 0.651764988899231, 0.7758906483650208, 0.29156002402305603, 0.7302567362785339, -0.2998337149620056, 0.8365351557731628, 0.29590296745300293, -0.038467321544885635, 0.05755147337913513, 0.029875513166189194, -0.7568110227584839, -0.22904828190803528, 0.6500573754310608, -0.27469688653945923, -0.694668710231781, 0.6206796169281006, 2.9010698199272156e-05, 0.16509002447128296, 0.11380763351917267, -0.8461997509002686, -0.18353469669818878, 0.8363394737243652, 0.34155896306037903, 0.9610598683357239, -0.33808624744415283, -0.5137693285942078, 1.2501384019851685, -1.0213149785995483, -0.04522298648953438, 1.24696683883667, 0.3766924738883972, 0.36886540055274963, -0.11017286777496338, -0.529126763343811, 0.766797661781311, 0.5998952984809875, -0.23196099698543549, -0.38527244329452515, 0.07608868181705475, -0.05658084526658058, 1.7772845029830933, -0.34516796469688416, 0.021870335564017296, 0.5334507822990417, -0.1453038603067398, 1.51419198513031, -0.04742477089166641, -0.586230456829071, 0.02040320821106434, -0.18690133094787598, 0.45612165331840515, 0.5316591262817383, -0.166473850607872, 0.1545819491147995, -1.2263998985290527, -0.309735506772995, 0.6071977019309998, 0.19806820154190063, 0.27365973591804504, -0.26434004306793213, -0.07568643987178802, 0.3733988404273987, 0.3067131042480469, 0.8769109845161438, -0.3842396140098572, 0.7547513246536255, 0.9141128659248352, 0.0018645533127710223, -0.2357579469680786, 0.6190784573554993, 0.369562566280365, -0.20438745617866516, -0.7907595634460449, 0.001158323371782899, -0.08955346792936325, 1.1441493034362793, -0.5502726435661316, 0.5351843237876892, -0.7585161328315735, -0.034292321652173996, 0.7311676740646362, 0.09368741512298584, 0.3746495246887207, -0.7002349495887756, 0.15449896454811096, -0.7004207372665405, 0.1549488604068756, -0.46253180503845215, 0.13155722618103027, -0.3264366388320923, -1.062052845954895, -1.0592507123947144, -0.6913130879402161, 0.4399528503417969, -0.5678655505180359, 0.04283733293414116, -0.6366570591926575, 0.5486131906509399, -0.4959786534309387, 0.26291367411613464, 0.37628617882728577, 0.23714882135391235, 0.27621304988861084, 0.06271453946828842, 1.0423773527145386, -1.2027080059051514, -0.5795056223869324, -1.1584904193878174, 0.01915695145726204, -0.3456614017486572, 0.08922301232814789, 0.12263470143079758, -1.5143526792526245, -1.1497970819473267, -0.9297286868095398, 0.1431078016757965, -0.2088906317949295, -0.16474628448486328, 1.015885829925537, 0.2001136988401413, -1.1804003715515137, 1.0339246988296509, -0.6147451400756836, -0.18522119522094727, 0.71315598487854, 0.20049405097961426, 0.6792469024658203, -0.23862206935882568, -1.1512984037399292, 0.07319082319736481, 0.006276844069361687, -0.7870550155639648, -0.6012091040611267, -1.0217913389205933, -0.8129677772521973, 0.12932386994361877, 0.10835754871368408, -0.0960954800248146, 1.3024396896362305, 0.08332552760839462, -0.7964831590652466, 0.6059430837631226, -0.39389169216156006, -0.04288540035486221, 0.4183462858200073, -0.30565500259399414, -0.3934706747531891, -0.18285760283470154, -0.022539297118782997, 0.1277172565460205, 0.7253798246383667, -0.15558943152427673, -0.3651542365550995, 0.1324469894170761, -0.3679374158382416, -0.2916606664657593, -0.4822223484516144, 0.8519902229309082, -0.6006304621696472, -0.036428432911634445, 0.00398661196231842, 0.6626909971237183, 0.01635783538222313, -0.5389135479927063, -0.640220046043396, -1.0900096893310547, 0.9228520393371582, 0.2775261104106903, 1.0830903053283691, -0.8175971508026123, -0.9581073522567749, -0.25834983587265015, 0.08232274651527405, 0.18407711386680603, -0.3710706830024719, 0.6060411334037781, -0.6098487377166748, 0.31797078251838684, 0.25702473521232605, -0.7898985147476196, 0.03444721922278404, -0.44859543442726135, -1.0830899477005005, -0.3846498727798462, 0.0014526151353493333, 0.8679916858673096, -1.1254537105560303, -0.07828619331121445, 0.027540093287825584, 0.2929956018924713, -0.9559375643730164, 1.5213724374771118, -0.27878549695014954, 0.15552155673503876, -0.3759007453918457, -0.3406292498111725, -0.0357055701315403, -0.7086589932441711, 0.6185548305511475, -0.4950764775276184, -0.012817475013434887, 0.6627529859542847, -0.015874560922384262, 0.9616937041282654, -0.5730658769607544, 0.5324254035949707, -0.3632234036922455, -0.7585020661354065, 0.36136120557785034, 0.4410502314567566, 0.18068236112594604, -0.8728991150856018, 0.21823471784591675, -0.022476524114608765, -0.6916941404342651, 0.09368772804737091, 1.0658137798309326, 1.3804372549057007, -0.21781453490257263, 0.3848136067390442, 0.37029772996902466, 0.02785627357661724, 0.17575614154338837, 0.4779505133628845, 1.2626246213912964, 0.4310137629508972, 0.1590241938829422, -0.21391502022743225, -0.12620657682418823, -0.6964886784553528, -0.05938251316547394, 1.0040355920791626, 0.5494828820228577, 0.6309911012649536, 0.5731049180030823, -0.9546788334846497, -0.8210707902908325, 0.1591082662343979, 0.45583391189575195, 1.2357021570205688, 0.1568203568458557, -0.15093925595283508, -0.6375022530555725, -0.3574473559856415, -0.3078005313873291, 0.1561461240053177, -0.3382458984851837, -0.38102516531944275, -0.58579021692276, -0.8980926871299744, 0.8957156538963318, 0.6564144492149353, 1.366876244544983, -1.0644766092300415, -1.0387682914733887, -0.28828442096710205, 0.44434595108032227, -0.9428715109825134, -0.4622858464717865, 0.6172264814376831, -0.37433019280433655, -0.0904826745390892, 0.37767091393470764, 0.07231180369853973, 0.12266865372657776, -0.33504679799079895, 1.0952465534210205, -0.326424777507782, -0.5280773043632507, 0.27711257338523865, 0.44231703877449036, -0.40656596422195435, -0.3363194763660431, 0.482826292514801, -0.007184498943388462, -0.3271656632423401, 0.20320521295070648, 0.11637335270643234, -0.23424726724624634, 0.11009471118450165, -0.04343539476394653, 0.012363951653242111, 0.07041417062282562, 0.00033909897319972515, 0.43044885993003845, -0.2663530707359314, -0.05040017142891884, -1.2772103548049927, 0.8338745832443237, -0.038390837609767914, -0.22813662886619568, -0.04388953745365143, -0.7760938405990601, -0.12562265992164612, 0.5470560193061829, -0.7274712324142456, -0.23164720833301544, -1.2388132810592651, 0.4088292419910431, -0.8491135835647583, -0.32342830300331116, -0.47591516375541687, 0.20686806738376617, 0.14481569826602936, 0.14171747863292694, 0.5137048959732056, -0.07989092171192169, 0.02526739425957203, 0.2289675772190094, -0.7780731320381165, 0.5813865065574646, -0.026483310386538506, -0.002200102200731635, -0.14591729640960693, 0.06898380815982819, -0.8109998106956482, -0.4458954334259033, -0.24153536558151245, -0.24762067198753357, -0.1324537694454193, 0.3305250406265259, -0.3120993673801422, -1.3775392770767212, -0.028159713372588158, -1.162023663520813, -0.6648876667022705, 0.1819019615650177, -0.6131689548492432, -0.2219667285680771, -1.239076852798462, -1.1018903255462646, -0.7820240259170532, -0.8030446767807007, -1.0728635787963867, 0.5037806630134583, 0.1086604967713356, -0.6595135927200317, -0.6913216710090637, -0.28984203934669495, -0.5750241279602051, 1.2138785123825073, -0.5841404795646667, 0.6549606323242188, -0.19544717669487, -0.6016465425491333, -0.23209881782531738, -0.04543639346957207, -0.03447890654206276, -0.03673451766371727, -0.10879968106746674, -1.1282466650009155, 0.2745361328125, -0.34441253542900085, -0.2379409372806549, 0.07859224826097488, -0.05409109964966774, 1.2944358587265015, 0.031115522608160973, -0.8273243308067322, 0.06281737983226776, 1.410202980041504, -0.26725831627845764, 0.37064892053604126, 0.22429035604000092, 1.4342459440231323, -0.085357666015625, -0.022758515551686287, 0.7567598819732666, 0.08780086785554886, 0.5793401598930359, 0.39659643173217773, -0.24773375689983368, -0.010038793087005615, -0.47227945923805237, 0.2433769255876541, 1.0451525449752808, 0.392234206199646, 0.005529794842004776, -1.0671610832214355, 0.822542130947113, -1.2592439651489258, -1.080952763557434, 0.5214693546295166, 0.8862802982330322, 0.0325806625187397, -0.30360254645347595, -0.2643473446369171, 0.03772697225213051, 0.6239227056503296, 0.44752857089042664, -0.7350733280181885, -0.8351140022277832, 0.2639210820198059, 0.7874215841293335, 0.4946751594543457, 0.4440092444419861, -0.24076397716999054, 0.38000333309173584, 15.040701866149902, 0.8326154351234436, -0.15543857216835022, 0.6521345376968384, 0.8929582834243774, 0.17161695659160614, -0.3759455680847168, -0.18895269930362701, -1.1348423957824707, 0.25987765192985535, 1.1867387294769287, 0.04213299974799156, 0.5567786693572998, 0.2933425009250641, -0.002860479988157749, 0.26748543977737427, -0.6739585399627686, 0.425606369972229, 0.2818647623062134, -1.3599317073822021, 0.24100247025489807, 0.2389804869890213, 0.4270089566707611, 0.3788169026374817, 0.9578347206115723, 0.3575133979320526, 0.7978593707084656, -0.5396497249603271, 0.3779629170894623, 0.13154852390289307, 1.209752082824707, -0.17425714433193207, 0.1865440309047699, 0.1487821489572525, -0.995781660079956, -0.01816137135028839, -0.3343401253223419, -1.1186374425888062, 0.030600370839238167, -0.04731408879160881, -0.6724850535392761, -0.4337959587574005, 0.19234569370746613, 0.7592613101005554, 0.2929913401603699, 0.3018781244754791, -0.2624068558216095, 0.5769907236099243, 0.4320439398288727, 0.060246627777814865, 0.10790060460567474, 1.0848559141159058, -0.17244505882263184, -0.03718222305178642, -0.163945734500885, -0.18288357555866241, 0.1685558706521988, 0.27390724420547485, -0.3144071102142334, -0.49899181723594666, -0.4747973382472992, 0.05495420843362808, 0.4253949224948883, 0.834148108959198, 0.5499734878540039, 0.1873430609703064, -0.29303300380706787, 0.43081000447273254, 0.4977622628211975, -0.19153626263141632, -0.46989789605140686, -0.01038808561861515, 0.3422110080718994, -0.21119466423988342, 0.02019956149160862, 0.8747357130050659, -0.5929990410804749, -0.15702103078365326, -0.9620990753173828, -0.5665678381919861, 0.5246606469154358, -0.997835099697113, -0.6375870704650879, 1.062201976776123, -0.28185904026031494, -0.3386477828025818, 0.23528775572776794, -0.5790175199508667, -0.5355753302574158, 0.23811359703540802, -0.9639293551445007, -0.5447267293930054, -0.153874933719635, -0.356719970703125, -0.32252082228660583, 0.19313491880893707, 1.2126189470291138, 0.3006340265274048, -0.10752971470355988, 0.3035358786582947, -0.15175257623195648, -0.09907360374927521, -0.09966328740119934, -0.9423876404762268, 1.2315977811813354, 0.18057486414909363, -0.5114471316337585, 0.07032863050699234, 0.2461612969636917, 0.16982395946979523, -0.9095470309257507, -0.4402630031108856, 0.4505235552787781, -0.9271857738494873, -0.033814702183008194, -0.7749871015548706, -0.976828932762146, 0.5180825591087341, 0.930066704750061, -0.07838601619005203, 0.011396413668990135, 0.21316887438297272, -0.5242682695388794, -0.16925205290317535, -0.6924446225166321, -0.01272729691118002, 0.7646918892860413, -0.8782474994659424, -0.19041039049625397, -0.3039197623729706, 0.5110002160072327, -0.9312242269515991, -0.5984580516815186, -0.46566322445869446, 0.18801841139793396, -0.4127762019634247, 1.0256553888320923, -0.18712753057479858, 1.0167338848114014, 1.1027488708496094, 0.34074726700782776, -0.6042822003364563, -0.27590620517730713, -1.018145203590393, 0.021022124215960503, 0.4347609877586365, 0.22367066144943237, -0.28816667199134827, 0.6339134573936462, 0.5993844866752625, 0.157536119222641, -0.4247004985809326, -0.3802768886089325, -0.09330897778272629, -0.11512148380279541, -0.6040987372398376, 0.48902538418769836, 0.21261350810527802, 0.3001512885093689, 0.057712092995643616, 0.0891760066151619, 0.3141520917415619, 0.3248341381549835, -0.5432102084159851, 0.1979152262210846, -0.0914430245757103, -0.09874255955219269, -0.49583807587623596, -0.532699465751648, -1.2143882513046265, 0.045807983726263046, -0.7749391794204712, 0.06234755367040634, -0.6007071137428284, -0.5337861180305481, -0.20846804976463318, -0.3010078966617584, 0.18435557186603546, 0.19339092075824738, -0.21865160763263702, -0.5378040671348572, -0.539356529712677, -0.8339622616767883, 0.5422130823135376, 0.9663246870040894, -0.5963587760925293, 0.23861105740070343, -0.3018934428691864, -0.16226951777935028, 0.12129650264978409, 0.5726026892662048, -0.35617193579673767, -0.675190269947052, -1.1484184265136719, 0.12451143562793732, 0.1808190792798996, 0.11605177819728851, -0.7729939818382263, 1.0481942892074585, 0.545503556728363, -0.17060424387454987, 0.05921301245689392, 0.11441805213689804, -0.8021150827407837, -0.5594221353530884, 0.4637102782726288, -0.9221429228782654, 0.36971762776374817, 0.5010172128677368, -0.8162702918052673, 0.043205417692661285, 0.9330537915229797, -0.08196710795164108, -0.8007903695106506, -0.953857958316803, 0.5133718848228455, -0.5072871446609497, 0.4575895369052887, -0.1817844808101654, -0.11192348599433899, -1.5353413820266724, -0.21680375933647156, 0.15244390070438385, 0.3230559229850769, -0.3218460977077484, 1.150024175643921, 0.18547895550727844, -1.1110259294509888, 0.24938830733299255, 0.23076274991035461, -0.1063784509897232, 0.013166181743144989, 0.8660770058631897, 0.5598273277282715, -0.08092031627893448, 0.4918135404586792, -0.1785038560628891, 0.2566865384578705, -0.6490290760993958, 0.482223242521286, 0.7617788314819336, -0.5582767724990845, -0.1339990794658661, 0.7426963448524475, -0.406395822763443, -0.43648016452789307, 0.03915584459900856, -0.8078210353851318, -0.608289897441864, -0.35588568449020386, 0.7944573760032654, 0.46862003207206726, -0.07693780213594437, 0.2841080129146576, -0.8983609080314636, 0.2528362572193146, -0.31656375527381897, -0.17546382546424866, 0.35720109939575195, 0.32435163855552673, -0.40443655848503113, 0.4865556061267853, 0.44456738233566284, -0.5341203212738037, -0.7061570286750793, -0.7086554765701294, -0.2950820326805115, 0.017283858731389046, 0.24511870741844177, -0.18068058788776398, -0.6843395829200745, 1.014461874961853, 0.47018301486968994, 0.867604672908783, 0.21049664914608002, -0.021935172379016876, 0.026009559631347656, -0.012454124167561531, 0.4201660752296448, -0.18210557103157043, -0.3622187077999115, 1.1521350145339966, 0.9068472981452942, -0.3668873608112335, 0.047253336757421494, -0.21925769746303558, -0.6276984810829163, 0.534771740436554, 0.5677070617675781, -0.34592771530151367, 0.518947958946228, 0.23523926734924316, -0.27292653918266296, 0.19388417899608612, -1.364107608795166, -0.07549886405467987, 0.5071568489074707, 1.155250072479248, 0.6066311597824097, 0.13111937046051025, 0.5267625451087952, 0.6123748421669006, 0.25677841901779175, 0.052740003913640976, 0.43267402052879333, 0.29843848943710327, 0.013180526904761791, -0.09235576540231705, -0.06262555718421936, 0.6270886659622192, -0.6487959623336792, -0.7532349824905396, 0.2812032699584961, 0.4706042408943176, 0.12580004334449768, 0.6771394610404968, 1.261071801185608, -0.14170975983142853, 0.6311469674110413, -0.36457154154777527, 0.544434666633606, -0.3326720893383026, -0.42500561475753784, -0.3574322760105133, -0.7126327753067017, -0.3713712692260742, 0.023016922175884247, -0.7117892503738403, -0.4310014247894287, -0.5409437417984009, 0.7535302639007568, 0.23963308334350586, -0.05535290390253067, 0.9219154119491577, 1.01118803024292, 1.2862205505371094, -0.2039811760187149, -0.7794297337532043, -0.0722876787185669, -0.8718094229698181, 0.20434120297431946, -0.5558209419250488, -0.10586438328027725, -0.2270277738571167, 0.025271786376833916, -0.33684447407722473]}, "authors": [{"authorId": "2266839598", "name": "William Brandon"}, {"authorId": "1383116857", "name": "Aniruddha Nrusimha"}, {"authorId": "2266839564", "name": "Kevin Qian"}, {"authorId": "2172356226", "name": "Zachary Ankner"}, {"authorId": "2266840179", "name": "Tian Jin"}, {"authorId": "2267224350", "name": "Zhiye Song"}, {"authorId": "2266838975", "name": "Jonathan Ragan-Kelley"}], "references": [{"paperId": "dedcfd974eb7a8ab3d02b42561e4448883f0215a", "title": "System Optimizations for Enabling Training of Extreme Long Sequence Transformer Models"}, {"paperId": "02ad9f3fefe33cb9ca546591bec65dbdf7766c80", "title": "Ring Attention with Blockwise Transformers for Near-Infinite Context"}, {"paperId": "104b0bb1da562d53cbda87aec79ef6a2827d191a", "title": "Llama 2: Open Foundation and Fine-Tuned Chat Models"}, {"paperId": "823ca4778e1027f2f0b356df051d762dcecaaba0", "title": "FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning"}, {"paperId": "57e849d0de13ed5f91d086936296721d4ff75a75", "title": "LLaMA: Open and Efficient Foundation Language Models"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "bc8b82e8eb0b0714892e4ec7a54ebdf47c4fde96", "title": "Reducing Activation Recomputation in Large Transformer Models"}, {"paperId": "53c3940f35b8b45d55ed49056282e1961954513d", "title": "Self-attention Does Not Need $O(n^2)$ Memory"}, {"paperId": "66c10bf1f11bc1b2d92204d8f8391d087f6de1c4", "title": "RoFormer: Enhanced Transformer with Rotary Position Embedding"}, {"paperId": "90abbc2cf38462b954ae1b772fac9532e2ccd8b0", "title": "Language Models are Few-Shot Learners"}, {"paperId": "8323c591e119eb09b28b29fd6c7bc76bd889df7a", "title": "Megatron-LM: Training Multi-Billion Parameter Language Models Using Model Parallelism"}, {"paperId": "21da617a0f79aabf94272107184606cefe90ab75", "title": "Generating Long Sequences with Sparse Transformers"}, {"paperId": "d79a26226393f687ddbc375e32055b40b8ad8d38", "title": "GPipe: Efficient Training of Giant Neural Networks using Pipeline Parallelism"}, {"paperId": "204e3073870fae3d05bcbc2f6a8e263d9b72e776", "title": "Attention is All you Need"}, {"paperId": null, "title": "Fully sharded data parallel: Faster ai training with fewer gpus"}, {"paperId": "9405cc0d6169988371b2755e573cc28650d14dfe", "title": "Language Models are Unsupervised Multitask Learners"}, {"paperId": "cd18800a0fe0b668a1cc19f2ec95b5003d0a5035", "title": "Improving Language Understanding by Generative Pre-Training"}, {"paperId": null, "title": "JAX: composable transformations of Python+NumPy programs"}, {"paperId": null, "title": "Ima-genet classification with deep convolutional neural networks"}, {"paperId": null, "title": "Sequence level parallelism for distributed training of long context"}, {"paperId": null, "title": "Model Size: We investigate 1B, 3B, and 7B model configurations which are used in the original Ring Attention implementation"}, {"paperId": null, "title": "Striped Attention"}]}