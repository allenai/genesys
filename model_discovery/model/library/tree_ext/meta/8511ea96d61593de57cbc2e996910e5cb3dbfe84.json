{"paperId": "8511ea96d61593de57cbc2e996910e5cb3dbfe84", "title": "DISTFLASHATTN: Distributed Memory-efficient Attention for Long-context LLMs Training", "abstract": "FlashAttention (Dao, 2023) effectively reduces the quadratic peak memory usage to linear in training transformer-based large language models (LLMs) on a single GPU. In this paper, we introduce DISTFLASHATTN, a distributed memory-efficient attention mechanism optimized for long-context LLMs training. We propose three key techniques: token-level workload balancing, overlapping key-value communication, and a rematerialization-aware gradient checkpointing algorithm. We evaluate DISTFLASHATTN on Llama-7B and variants with sequence lengths from 32K to 512K. DISTFLASHATTN achieves 8x longer sequences, 4.45 - 5.64x speedup compared to Ring Self-Attention, 2 - 8x longer sequences, 1.24 - 2.01x speedup compared to Megatron-LM with FlashAttention. It achieves 1.67x and 1.26 - 1.88x speedup compared to recent Ring Attention and DeepSpeed-Ulysses. Code is available at https://github.com/RulinShao/LightSeq.", "venue": "", "year": 2023, "citationCount": 4, "influentialCitationCount": 1, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "DISTFLASHATTN, a distributed memory-efficient attention mechanism optimized for long-context LLMs training, is introduced and three key techniques are proposed: token-level workload balancing, overlapping key-value communication, and a rematerialization-aware gradient checkpointing algorithm."}, "embedding": {"model": "specter_v2", "vector": [0.3060550391674042, 0.7192647457122803, -0.5435795783996582, 0.08562811464071274, -0.4847722351551056, -0.1133226528763771, 0.8793676495552063, 0.11796081066131592, -0.6268876194953918, -0.1366128921508789, 0.5107110142707825, -0.13134576380252838, 0.671299397945404, 0.11704183369874954, -0.26024675369262695, -0.11792384833097458, -0.8791348934173584, 0.21128541231155396, 0.06554923206567764, 0.08571236580610275, 0.07321757078170776, -0.3572545647621155, -1.0887559652328491, 0.22262465953826904, 0.4250609874725342, 0.7303892970085144, 0.4483833909034729, 0.9927203059196472, -0.5837535858154297, 0.4761415421962738, 0.20011383295059204, -0.049671344459056854, -0.0019285520538687706, -0.10494180023670197, -0.8749470114707947, -0.33696314692497253, 0.7175920605659485, -0.23858943581581116, -0.38482043147087097, 0.700896143913269, 0.25123679637908936, 0.45101186633110046, 0.13121335208415985, -0.45089900493621826, -0.07221008837223053, 0.6530827879905701, 0.25429731607437134, 0.8044810891151428, -0.42326945066452026, -0.42245787382125854, 1.095392107963562, -1.3625565767288208, 0.014031445607542992, 1.3215123414993286, 0.4395754039287567, 0.3362705111503601, -0.19695767760276794, -0.13927200436592102, 0.7122159004211426, 0.28590649366378784, -0.4912716746330261, -0.5106936097145081, -0.24443089962005615, 0.11289406567811966, 2.0936686992645264, -0.2287188172340393, 0.332457572221756, 0.6454598903656006, 0.1266842484474182, 1.5512731075286865, -0.1385359764099121, -0.8209494352340698, -0.165007084608078, -0.1607680767774582, 0.5708150863647461, 0.5531599521636963, -0.35264214873313904, 0.09883555769920349, -0.6632089018821716, -0.2935836911201477, 0.1324208527803421, 0.18052814900875092, 0.6149172782897949, -0.1778915375471115, -0.4750235378742218, 0.6423494815826416, 0.28862354159355164, 0.8117112517356873, -0.2288377285003662, 0.7411829829216003, 0.5628224611282349, -0.0006290375022217631, 0.30432116985321045, 0.15903638303279877, 0.17446060478687286, 0.08374156057834625, -1.155055284500122, 0.24785970151424408, -0.2972572445869446, 0.7621791958808899, -0.05900225788354874, 0.37811973690986633, -0.8724726438522339, 0.28541111946105957, 1.1013363599777222, 0.54338538646698, 0.5243910551071167, -0.7280744314193726, -0.09040229022502899, -0.8649778962135315, -0.3145444095134735, -0.5287842154502869, -0.23280727863311768, -0.15895837545394897, -1.0073884725570679, -1.090966820716858, -0.5550115704536438, 0.06856413185596466, -0.41182851791381836, 0.7658510804176331, -0.007376357913017273, 0.4386104941368103, 0.12184847146272659, 0.532910168170929, 0.39292892813682556, 0.6685035824775696, 0.19117163121700287, 0.1708855777978897, 0.9478705525398254, -1.327689528465271, -0.32897457480430603, -1.3064863681793213, 0.5479487180709839, -0.2117871344089508, 0.408902645111084, -0.06530890613794327, -1.3856667280197144, -0.963729977607727, -0.7927941679954529, -0.32484447956085205, -0.2315807044506073, -0.09959326684474945, 1.0715655088424683, 0.0906628668308258, -1.036559820175171, 0.613263726234436, -0.4249793589115143, -0.15909214317798615, 0.35660701990127563, -0.005160192493349314, 0.6197916865348816, -0.40042802691459656, -1.4427051544189453, 0.28455668687820435, -0.05839131027460098, -0.4874790608882904, -0.5260044932365417, -0.5597777366638184, -0.7405596971511841, -0.0866503044962883, 0.10622917860746384, -0.25500667095184326, 1.4741541147232056, -0.44624418020248413, -1.1513365507125854, 0.7790037989616394, -0.14771178364753723, -0.15751950442790985, 0.2672288417816162, -0.14025945961475372, -0.4110150933265686, -0.33154430985450745, -0.2896236777305603, 0.8075916767120361, 0.49372997879981995, 0.33128848671913147, -0.13334807753562927, 0.043282296508550644, -0.4086551368236542, 0.08246026188135147, -0.27272263169288635, 0.591212809085846, -0.45716750621795654, -0.059525176882743835, -0.12959976494312286, 0.3771456778049469, -0.22553379833698273, -0.4166743755340576, -0.2575143277645111, -1.0220798254013062, 0.9501972794532776, 0.31828102469444275, 0.7947438955307007, -1.0289993286132812, -0.8874580264091492, -0.23518067598342896, -0.004223094787448645, 0.10593030601739883, -0.6175699830055237, 0.37350791692733765, -0.23173671960830688, -0.20008115470409393, -0.17957313358783722, -1.1108325719833374, 0.18039463460445404, -0.061869535595178604, -0.6935683488845825, -0.20777517557144165, -0.2156783640384674, 0.9526193737983704, -0.9551026225090027, -0.1138499453663826, -0.30445802211761475, 0.3382279872894287, -1.093601107597351, 1.2225159406661987, -0.7165391445159912, 0.11258652061223984, 0.04069744423031807, -0.503075897693634, 0.2974476218223572, -0.36886754631996155, 0.6852201819419861, -0.07108088582754135, -0.12911051511764526, 0.5582260489463806, -0.2416905164718628, 1.8010469675064087, -0.5399789810180664, 0.7368259429931641, 0.012650493532419205, -0.38333502411842346, 0.34098154306411743, -0.11311937123537064, -0.35382765531539917, -0.7294603586196899, -0.0668683797121048, 0.3285084068775177, -0.7105460166931152, 0.11037316918373108, 1.1836509704589844, 1.1703159809112549, -0.4415894150733948, 0.3671889305114746, 0.2988397479057312, -0.06599348783493042, 0.13654734194278717, 0.7501252889633179, 0.4978240430355072, 0.364236980676651, 0.19213245809078217, -0.31918707489967346, 0.13930268585681915, -0.86664217710495, -0.39976295828819275, 0.5281614065170288, 0.6035429239273071, 0.4526292085647583, 0.6404085159301758, -0.9616159796714783, -0.7065147161483765, 0.35991501808166504, 0.5554580092430115, 1.5140252113342285, -0.26545459032058716, 0.2501194179058075, -1.151153326034546, -0.36781057715415955, -0.17923825979232788, 0.06560515612363815, -0.11325971782207489, -0.20800934731960297, -0.602164626121521, -0.8888691663742065, 0.9949364066123962, 0.2874155640602112, 0.9433988332748413, -1.0837773084640503, -0.6467636823654175, -0.6064110994338989, 0.36843210458755493, -0.8560338616371155, -0.8831320405006409, 0.3995341658592224, -0.24868904054164886, 0.14959895610809326, -0.08729258179664612, -0.263403058052063, 0.06696651130914688, -0.2669697105884552, 1.1935757398605347, -0.7156116962432861, -0.3191841244697571, 0.09171239286661148, 0.767100989818573, -0.23652566969394684, -0.5488172769546509, 0.5761337876319885, 0.1694861501455307, -0.07969660311937332, 0.11811807006597519, 0.31067994236946106, -0.25237759947776794, -0.39790865778923035, -0.2739796042442322, 0.10334938764572144, 0.2640872895717621, -0.14951585233211517, 0.7848845720291138, -0.8286513090133667, 0.07998967170715332, -1.1983174085617065, 0.8395060896873474, 0.004307193215936422, -0.4539910852909088, 0.15506209433078766, -0.8913472890853882, -0.03463218733668327, 0.30945125222206116, -0.7560301423072815, -0.30223947763442993, -1.0145477056503296, 0.0778217613697052, -0.571938157081604, -0.3374614715576172, -0.1863487809896469, 0.35442277789115906, 0.29693397879600525, 0.3806074559688568, 0.5492925643920898, 0.3242246210575104, 0.14692026376724243, 0.6787563562393188, -0.5780968070030212, 0.671288788318634, -0.11868754774332047, -0.5722614526748657, -0.35530343651771545, 0.06967116892337799, -0.9411723613739014, -0.44179007411003113, -0.10178464651107788, -0.06154072657227516, -0.23022092878818512, 0.42745962738990784, -0.46431294083595276, -1.1330397129058838, 0.2699047029018402, -1.2305307388305664, -0.808864414691925, -0.05654391273856163, -0.343431293964386, -0.2467382550239563, -0.9910664558410645, -1.2884953022003174, -0.6233532428741455, -1.1746102571487427, -0.9699597954750061, 0.3209932744503021, 0.11173676699399948, -0.4166594445705414, -0.7657006978988647, 0.22133862972259521, -0.6809335350990295, 1.0655667781829834, -0.6425541043281555, 0.4374070465564728, -0.046416908502578735, -0.28250667452812195, 0.02079680562019348, 0.14506226778030396, 0.28918030858039856, -0.5986292362213135, 0.058791063725948334, -1.1599960327148438, 0.18376144766807556, -0.674367368221283, -0.6958678960800171, 0.3015984892845154, 0.5256248116493225, 0.7456331253051758, -0.07635398954153061, -0.5066656470298767, 0.39895135164260864, 1.1897419691085815, -0.7026673555374146, 0.3602951765060425, -0.026114797219634056, 1.0651699304580688, -0.27096375823020935, -0.19675885140895844, 0.7351715564727783, 0.38249796628952026, 0.3948277235031128, 0.27844876050949097, -0.4495545029640198, -0.1413198858499527, -0.2963845133781433, 0.5362781882286072, 1.47128164768219, 0.8381746411323547, 0.09622041136026382, -1.0778462886810303, 0.5072291493415833, -1.1034795045852661, -0.8610044121742249, 0.5332642197608948, 0.864979088306427, 0.36756187677383423, -0.35111284255981445, 0.07819461822509766, -0.4246741235256195, 0.35869500041007996, 0.7865431308746338, -0.6344830989837646, -1.2238390445709229, -0.0904606282711029, 0.44609734416007996, 0.059244491159915924, 0.8818535804748535, -0.030943049117922783, 0.5924888849258423, 14.968562126159668, 1.0426933765411377, -0.21138601005077362, 0.7796310782432556, 1.2690027952194214, -0.026008689776062965, -0.49214011430740356, -0.22621916234493256, -1.1682829856872559, -0.020803043618798256, 1.574983835220337, 0.5524601936340332, 0.5617879629135132, 0.3827248811721802, -0.1583830565214157, 0.03911742568016052, -0.45771563053131104, 0.73038250207901, 0.5798259377479553, -1.224234938621521, -0.011640696786344051, 0.0012646970571950078, 0.5654257535934448, 0.7602634429931641, 1.058577537536621, 0.6295044422149658, 0.5992763042449951, -0.11118623614311218, 0.5349977612495422, 0.6049746870994568, 1.1840908527374268, -0.3894456624984741, 0.0014158147387206554, 0.4159851670265198, -0.614246666431427, 0.10903766751289368, -0.5649723410606384, -0.985993504524231, -0.19018377363681793, 0.28974398970603943, -0.41911569237709045, -0.6296741366386414, -0.26409438252449036, 0.4395410120487213, 0.25038206577301025, 0.04458250105381012, 0.04999535530805588, 0.34461164474487305, 0.0737348198890686, -0.12552319467067719, 0.489582359790802, 0.5564119815826416, -0.03032863512635231, 0.4060087502002716, -0.07175189256668091, -0.2270464450120926, 0.21551454067230225, 0.49877992272377014, -0.39034929871559143, -0.3283945620059967, -0.06028616800904274, -0.05665145814418793, 0.1278744637966156, 1.0445400476455688, 0.6320315003395081, 0.1997692584991455, -0.44115737080574036, 0.5733500123023987, 0.6783940196037292, 0.010703649371862411, -0.3183704614639282, -0.09980682283639908, 0.48391851782798767, -0.5922581553459167, -0.18977361917495728, 0.5265163779258728, -0.048938002437353134, -0.31709393858909607, -0.9473864436149597, -0.6664267182350159, 0.25917255878448486, -0.8066987991333008, -0.47218143939971924, 0.9693475365638733, -0.4436391294002533, -0.026695309206843376, 0.15124142169952393, -0.4292740523815155, -0.42199525237083435, 0.5508922934532166, -1.2723040580749512, -0.6029016375541687, 0.36657461524009705, -0.2120339721441269, -0.3887338638305664, 0.12961390614509583, 1.221441388130188, 0.24814681708812714, -0.39644482731819153, 0.2213914543390274, 0.1876717507839203, -0.30596810579299927, -0.019946113228797913, -0.742524266242981, 1.369502067565918, 0.323179692029953, -0.31891512870788574, -0.1961539089679718, -0.17479443550109863, 0.39587029814720154, -0.8386862874031067, -0.060087934136390686, 0.6574162840843201, -0.7120181322097778, -0.3546953797340393, -0.9508451223373413, -0.6497353911399841, 0.5033121109008789, 0.7923797965049744, 0.33464542031288147, 0.21340252459049225, 0.06919104605913162, -0.4608078598976135, -0.3280211091041565, -0.5469675064086914, -0.0864810049533844, 0.332420289516449, -0.895911455154419, 0.09383755177259445, -0.1577257364988327, 0.6017632484436035, -1.1967170238494873, -0.45919784903526306, -0.7761346697807312, 0.26342615485191345, -0.20587389171123505, 0.8408607244491577, -0.22894181311130524, 0.5202507376670837, 1.251630425453186, 0.003690899582579732, -0.6809772849082947, 0.11596694588661194, -1.0274368524551392, -0.30948173999786377, 0.29738500714302063, 0.3999393582344055, -0.4027128219604492, 0.4388447403907776, 0.5475752353668213, 0.08772191405296326, -0.768980860710144, -0.5249413847923279, -0.07688985764980316, 0.24499580264091492, -0.4916294813156128, 0.6044297814369202, 0.2763046622276306, 0.269308477640152, 0.32849931716918945, 0.257485955953598, 0.2560826241970062, -0.1256895810365677, -0.499953031539917, 0.3866465985774994, 0.19783905148506165, -0.17417408525943756, -0.6983125805854797, -0.46933114528656006, -1.7265979051589966, -0.1255878359079361, -1.0621246099472046, -0.12554188072681427, -0.48810040950775146, -0.1974392831325531, -0.28683900833129883, -0.2119709551334381, 0.12966129183769226, 0.21882781386375427, -0.5789835453033447, -0.45073410868644714, -0.685596764087677, -0.9285106658935547, 0.8323954939842224, 0.8565630316734314, -0.6307012438774109, 0.28986677527427673, -0.2796478271484375, 0.2830171287059784, 0.017748456448316574, 0.30379730463027954, -0.3262772262096405, -0.7538737058639526, -1.2468374967575073, 0.31706735491752625, 0.2066795825958252, -0.2148512899875641, -0.9582033157348633, 0.5324066281318665, 0.28162330389022827, -0.16498157382011414, 0.013417554087936878, -0.019770463928580284, -0.5944413542747498, -0.69536292552948, 0.4089002013206482, -0.9702076315879822, 0.4441227316856384, 0.476278156042099, -0.8018439412117004, 0.010513375513255596, 0.7106563448905945, 0.023041104897856712, -0.8208058476448059, -0.6534937024116516, 0.6165897846221924, -0.6099007725715637, 0.5236668586730957, -0.44197359681129456, 0.1343899816274643, -1.3760958909988403, -0.23481273651123047, -0.11615891754627228, 0.2164878398180008, -0.3553878664970398, 0.8133044838905334, 0.1468847244977951, -1.2136796712875366, 0.19102832674980164, 0.37270689010620117, -0.48205137252807617, 0.3805558681488037, 1.0150898694992065, 0.693858802318573, -0.26998454332351685, 0.41610127687454224, 0.1604820042848587, 0.13820141553878784, -0.6791359186172485, 0.4031771421432495, 0.8696172833442688, -0.6662796139717102, -0.0771498754620552, 0.9579392075538635, -0.3520808219909668, -0.9199921488761902, -0.006202589254826307, -1.1515612602233887, -0.20945918560028076, -0.3552328944206238, 0.7696657776832581, 0.324034720659256, 0.05541132390499115, 0.1275845319032669, -0.6965749263763428, -0.007664948236197233, -0.13820511102676392, -0.4912666082382202, 0.49519601464271545, -0.023969316855072975, -0.44546782970428467, 0.5879618525505066, 0.9105730652809143, -0.3284028172492981, -0.9573131203651428, -0.9189603328704834, -0.43384405970573425, 0.36170461773872375, 0.40733879804611206, -0.29247158765792847, -0.6531912684440613, 1.0394784212112427, 0.7503941059112549, 0.40081340074539185, 0.08970799297094345, -0.1890040636062622, 0.4189209043979645, 0.5120782852172852, -0.11173900216817856, -0.5159211158752441, -0.29810187220573425, 1.4389305114746094, 0.9389712810516357, -0.5785839557647705, 0.06932717561721802, 0.41284242272377014, -0.8177711367607117, 0.6109943985939026, 0.47239425778388977, 0.07370932400226593, 0.44474807381629944, 0.15889441967010498, -0.07422927021980286, 0.21850982308387756, -1.2022429704666138, -0.09219741821289062, 0.6163763403892517, 0.7383609414100647, 0.6595783233642578, 0.2557520568370819, 0.461066335439682, 0.6515759229660034, 0.47368529438972473, -0.2647910714149475, 0.025898750871419907, 0.5380569100379944, -0.2076551616191864, -0.13623225688934326, -0.12244061380624771, 0.25757917761802673, -0.6218348741531372, -0.7833209037780762, 0.28109532594680786, 0.08054641634225845, 0.12426164746284485, 0.30538782477378845, 1.3623851537704468, 0.2782842218875885, 0.188845694065094, -0.02030324377119541, 0.7479982972145081, -0.17279163002967834, -0.2757302522659302, -0.13285328447818756, -0.6440131664276123, -0.16458243131637573, 0.05717788264155388, -0.623548150062561, -0.6447913646697998, -0.656252384185791, 0.6555035710334778, 0.07654955983161926, 0.14904481172561646, 0.9676975607872009, 0.9691736102104187, 0.6673146486282349, -0.31309857964515686, -0.7545881867408752, -0.3056184947490692, -0.9219999313354492, 0.1457795947790146, -0.6027536988258362, -0.025941047817468643, 0.31574133038520813, 0.2446867972612381, -0.574492335319519]}, "authors": [{"authorId": "2117961435", "name": "Dacheng Li"}, {"authorId": "2254264970", "name": "Rulin Shao"}, {"authorId": "2254221083", "name": "Anze Xie"}, {"authorId": "2243336934", "name": "Eric P. Xing"}, {"authorId": "2378954", "name": "Xuezhe Ma"}, {"authorId": "2055174324", "name": "Ion Stoica"}, {"authorId": "2254681613", "name": "Joseph E. Gonzalez"}, {"authorId": "2257340589", "name": "Hao Zhang"}], "references": [{"paperId": "2c0312c604f9f7638bb4533b39e0ae81e7f6ab12", "title": "The Falcon Series of Open Language Models"}, {"paperId": "02ad9f3fefe33cb9ca546591bec65dbdf7766c80", "title": "Ring Attention with Blockwise Transformers for Near-Infinite Context"}, {"paperId": "a51ac7a5e8f6454268ac16ecdc52ecac98ce54d9", "title": "DeepSpeed Ulysses: System Optimizations for Enabling Training of Extreme Long Sequence Transformer Models"}, {"paperId": "823ca4778e1027f2f0b356df051d762dcecaaba0", "title": "FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning"}, {"paperId": "a0a79dad89857a96f8f71b14238e5237cbfc4787", "title": "Judging LLM-as-a-judge with MT-Bench and Chatbot Arena"}, {"paperId": "5ae6fb6b5a3c7df515ff4a82ac9673bae6a8e200", "title": "GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints"}, {"paperId": "a0e7c31d723608e03f30fc92ffc2a604a7a039da", "title": "PyTorch FSDP: Experiences on Scaling Fully Sharded Data Parallel"}, {"paperId": "57e849d0de13ed5f91d086936296721d4ff75a75", "title": "LLaMA: Open and Efficient Foundation Language Models"}, {"paperId": "9575afb5702bc33d7df14c48feeee5901ea00369", "title": "A Length-Extrapolatable Transformer"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "bc8b82e8eb0b0714892e4ec7a54ebdf47c4fde96", "title": "Reducing Activation Recomputation in Large Transformer Models"}, {"paperId": "53c3940f35b8b45d55ed49056282e1961954513d", "title": "Self-attention Does Not Need $O(n^2)$ Memory"}, {"paperId": "f0993e68c76d940763ef7f8106db86cdc97b3a49", "title": "Multi-head or Single-head? An Empirical Comparison for Transformer Training"}, {"paperId": "044e13d7dd4e0655eb76f0bd00b2c1bdb44e2be3", "title": "Big Bird: Transformers for Longer Sequences"}, {"paperId": "925ad2897d1b5decbea320d07e99afa9110e09b2", "title": "Longformer: The Long-Document Transformer"}, {"paperId": "3c8a456509e6c0805354bd40a35e3f2dbf8069b1", "title": "PyTorch: An Imperative Style, High-Performance Deep Learning Library"}, {"paperId": "c95383f251a62c63217586059c67f63507c3e839", "title": "HuggingFace's Transformers: State-of-the-art Natural Language Processing"}, {"paperId": "fd431005d26100f5453590080683cbae9dc1189f", "title": "Checkmate: Breaking the Memory Wall with Optimal Tensor Rematerialization"}, {"paperId": "70fe1f854bc59092ded4bf2939a6624a80e5e4c3", "title": "ZeRO: Memory Optimization Towards Training A Trillion Parameter Models"}, {"paperId": "8323c591e119eb09b28b29fd6c7bc76bd889df7a", "title": "Megatron-LM: Training Multi-Billion Parameter Language Models Using Model Parallelism"}, {"paperId": "d79a26226393f687ddbc375e32055b40b8ad8d38", "title": "GPipe: Efficient Training of Giant Neural Networks using Pipeline Parallelism"}, {"paperId": "ec1f582446aa24f3f0920123ee6f05feea0b5e0a", "title": "Online normalizer calculation for softmax"}, {"paperId": "942deb7d865b7782c03176d95e3a0d56cb71009e", "title": "Training Deep Nets with Sublinear Memory Cost"}, {"paperId": "28682682ce59cf90de9da7d62d1c17513fdac09a", "title": "Sequence Parallelism: Making 4D Parallelism Possible"}, {"paperId": "9405cc0d6169988371b2755e573cc28650d14dfe", "title": "Language Models are Unsupervised Multitask Learners"}, {"paperId": null, "title": ": A modular and hackable transformer modelling library"}]}