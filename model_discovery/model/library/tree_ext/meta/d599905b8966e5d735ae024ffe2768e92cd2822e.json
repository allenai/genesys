{"paperId": "d599905b8966e5d735ae024ffe2768e92cd2822e", "title": "CoCA: Fusing Position Embedding with Collinear Constrained Attention in Transformers for Long Context Window Extending", "abstract": "Self-attention and position embedding are two key modules in transformer-based Large Language Models (LLMs). However, the potential relationship between them is far from well studied, especially for long context window extending. In fact, anomalous behaviors harming long context extrapolation exist between Rotary Position Embedding (RoPE) and vanilla self-attention unveiled by our work. To address this issue, we propose a novel attention mechanism, CoCA (Collinear Constrained Attention). Specifically, we enforce a collinear constraint between $Q$ and $K$ to seamlessly integrate RoPE and self-attention. While only adding minimal computational and spatial complexity, this integration significantly enhances long context window extrapolation ability. We provide an optimized implementation, making it a drop-in replacement for any existing transformer-based models. Extensive experiments show that CoCA performs extraordinarily well in extending context windows. A CoCA-based GPT model, trained with a context length of 512, can seamlessly extend the context window up to 32K (60$\\times$), without any fine-tuning. Additionally, by dropping CoCA in LLaMA-7B, we achieve extrapolation up to 32K within only 2K training length. Our code is publicly available at: https://github.com/codefuse-ai/Collinear-Constrained-Attention", "venue": "", "year": 2023, "citationCount": 1, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "This work proposes a novel attention mechanism, CoCA (Collinear Constrained Attention), which enforces a collinear constraint between Q and K to seamlessly integrate RoPE and self-attention, and provides an optimized implementation, making it a drop-in replacement for any existing transformer-based models."}, "embedding": {"model": "specter_v2", "vector": [0.32113534212112427, 0.6506949663162231, -0.4605976343154907, 0.181244894862175, -0.5298700928688049, -0.34134113788604736, 0.6564322113990784, -0.019588416442275047, -0.4884033203125, -0.3818153142929077, 0.5944927930831909, -0.13536286354064941, 0.7376005053520203, 0.11415613442659378, -0.2607545256614685, 0.022761983796954155, -0.8785482048988342, 0.044467151165008545, 0.3578001856803894, -0.38807767629623413, -0.25600963830947876, -0.9007038474082947, -0.5832372307777405, 0.19246579706668854, 0.6568185091018677, 0.422970712184906, 0.5851730108261108, 0.7332937717437744, -0.4225824475288391, 0.16600091755390167, 0.41517654061317444, -0.32614317536354065, 0.29017359018325806, 0.23776498436927795, -0.001061770599335432, -0.31134945154190063, 0.26168832182884216, -0.3008817136287689, -0.5011114478111267, 0.7657585144042969, -0.19722430408000946, 0.0848553478717804, -0.046903349459171295, -0.8174557685852051, -0.8087889552116394, 1.1665258407592773, 0.6225114464759827, 0.7184511423110962, -0.6040582656860352, -0.7948809862136841, 1.563473105430603, -1.543467402458191, 0.13951419293880463, 1.2697570323944092, 0.4565434753894806, 0.42683330178260803, -0.2531629800796509, -0.46465280652046204, 1.1543073654174805, 0.21572555601596832, -0.6829246878623962, -0.36575809121131897, 0.19247527420520782, 0.21980269253253937, 2.174762010574341, -0.33342307806015015, 0.5876681804656982, 0.6622410416603088, 0.1055077463388443, 1.4225777387619019, -0.13058046996593475, -1.1144287586212158, -0.396879106760025, 0.10358200967311859, 0.11439361423254013, 0.6826199889183044, -0.5238450765609741, 0.5903164744377136, -0.5797668695449829, -0.40603816509246826, 0.3118997812271118, 0.0040762657299637794, 0.284440279006958, -0.2628761827945709, -0.3658748269081116, 0.5709074139595032, 0.2829820215702057, 1.0350357294082642, 0.17905236780643463, 1.0223069190979004, 0.39496785402297974, 0.10669033974409103, 0.2175123244524002, 0.32858744263648987, -0.34374070167541504, 0.361429899930954, -1.1105997562408447, 0.3104904592037201, -0.439420610666275, 1.0004346370697021, -0.1257975548505783, 0.15702968835830688, -0.7905936241149902, 0.06522233039140701, 1.3168731927871704, 0.49862077832221985, 0.5242533087730408, -0.6243844032287598, 0.23683135211467743, -0.6419466733932495, -0.1297290176153183, -0.5917049646377563, 0.19665376842021942, -0.5007623434066772, -0.22788050770759583, -1.4445374011993408, -0.33792439103126526, 0.35658183693885803, -0.6468340158462524, 1.05581796169281, -0.06698907166719437, 0.06511425971984863, 0.0999148041009903, -0.03387366235256195, 0.10525364428758621, 0.7670893669128418, 0.280440092086792, -0.06196119263768196, 1.114457368850708, -1.240900993347168, -0.7219756245613098, -1.3103022575378418, 0.9446039199829102, -0.2880830466747284, 0.4989655315876007, -0.330128937959671, -1.0186532735824585, -0.8164700865745544, -1.2015730142593384, -0.24258309602737427, -0.8945695757865906, 0.2197003960609436, 0.5539647936820984, 0.6149568557739258, -1.110207200050354, 0.7034128308296204, -0.45014968514442444, 0.04571004956960678, 0.41809791326522827, -0.040557995438575745, 0.39946651458740234, -0.34847670793533325, -1.7449042797088623, 0.2879401743412018, 0.2779333293437958, -0.404183954000473, -0.09457574784755707, -0.7662040591239929, -1.2537152767181396, -0.07862401008605957, 0.693241536617279, -0.0945265144109726, 1.1640944480895996, 0.09624240547418594, -1.1780292987823486, 0.49744927883148193, -0.6370278596878052, -0.03147105127573013, 0.05958762392401695, -0.43866777420043945, -0.6197851896286011, -0.703891396522522, -0.05550193414092064, 0.4619889557361603, 0.5776566863059998, -0.06881414353847504, -0.2150564193725586, -0.014207398518919945, -0.3820919692516327, 0.08491625636816025, -0.2854909300804138, 0.8821892738342285, -0.5011357069015503, -0.2766057550907135, 0.15524950623512268, 0.33162784576416016, -0.07614849507808685, -0.28541088104248047, -0.3786912262439728, -1.2975598573684692, 1.0417355298995972, 0.15852069854736328, 1.3553540706634521, -0.9360520839691162, -0.7571141123771667, -0.293213814496994, -0.05945659801363945, -0.07706582546234131, -0.7591196298599243, 0.7282021641731262, -0.3700430691242218, 0.43545278906822205, -0.041760317981243134, -1.204655647277832, 0.24691496789455414, -0.20907804369926453, -0.8647765517234802, -0.47374776005744934, 0.07353324443101883, 1.3625762462615967, -1.116647720336914, -0.12516124546527863, -0.07548093050718307, 0.45464852452278137, -0.9851407408714294, 0.9373243451118469, -0.6373386979103088, -0.03831614553928375, 0.03841042146086693, -0.1327449530363083, -0.2823895514011383, -0.12532587349414825, 0.40542179346084595, -0.1888437122106552, -0.1584477573633194, 0.5066788792610168, -0.07626230269670486, 1.1901955604553223, -0.4468536674976349, 0.6179789304733276, -0.354152649641037, -0.32520806789398193, 0.03763815015554428, 0.3596597909927368, -0.1918100267648697, -0.32751959562301636, 0.03552469238638878, 0.46497613191604614, -0.6022449731826782, 0.45802566409111023, 1.086019515991211, 0.8055540919303894, -0.5107445120811462, -0.1503230780363083, 0.2977547347545624, -0.12997689843177795, 0.22954879701137543, 0.4389508366584778, 0.4392797648906708, 0.6399309635162354, 0.6090479493141174, -0.31551286578178406, 0.22743092477321625, -0.9623382687568665, 0.04001167044043541, 0.2495708018541336, 0.3569682538509369, 0.6644614338874817, 0.6150763034820557, -0.6157177686691284, -0.5856700539588928, 0.3758034110069275, 0.5211350321769714, 1.6725541353225708, -0.6069254875183105, -0.5236340165138245, -0.8410176038742065, -0.3997395932674408, -0.35196569561958313, 0.158199280500412, -0.510776162147522, -0.09149515628814697, -0.7115967273712158, -0.830859899520874, 0.6425092220306396, 0.33246031403541565, 0.6147480010986328, -0.5799724459648132, -0.38649484515190125, 0.19785170257091522, 0.2739805281162262, -1.1243863105773926, -0.8645890951156616, 0.5854640007019043, -0.5459355115890503, 0.038570962846279144, 0.1380472034215927, -0.1444643884897232, -0.0770149752497673, -0.8263446688652039, 0.6102204918861389, -0.5871983766555786, 0.024409502744674683, 0.1576213538646698, 0.4174496829509735, -0.7638646364212036, -0.6108582019805908, 0.708533763885498, 0.17321524024009705, -0.241304412484169, 0.524568498134613, 0.6577831506729126, -0.13613635301589966, -0.10902098566293716, -0.20142753422260284, 0.0656798928976059, 0.019899453967809677, -0.03283459320664406, 0.8849692940711975, -0.38748395442962646, 0.016131581738591194, -1.3525443077087402, 0.7690011262893677, 0.2869577705860138, -0.6575347781181335, 0.3197794258594513, -0.8843573331832886, -0.5036388039588928, 0.44702351093292236, -0.86557537317276, -0.011009261012077332, -0.9692254066467285, 0.5188719034194946, -0.29873886704444885, 0.08801314979791641, 0.1414814293384552, -0.024238770827651024, 0.48095735907554626, 0.04058360680937767, 0.6329458951950073, 0.07535789161920547, 0.2759515941143036, 0.8414730429649353, -0.9943714737892151, 0.2263236790895462, 0.012888193130493164, 0.09103884547948837, -0.13975319266319275, -0.23532143235206604, -0.8830543160438538, -0.36640581488609314, -0.27273210883140564, -0.28674936294555664, -0.03893551230430603, 0.34117355942726135, -0.5699000358581543, -0.45763298869132996, 0.05019499361515045, -0.8031479120254517, -0.4187827706336975, 0.003429373726248741, -0.6496599912643433, -0.171922504901886, -0.9972769618034363, -1.0820515155792236, -0.5138157606124878, -0.6339383721351624, -1.1077388525009155, 0.5481289029121399, -0.03641071543097496, -0.26679202914237976, -0.9277191162109375, 0.003040911164134741, -0.5389332175254822, 1.293999433517456, -0.6678695678710938, 0.9594815969467163, -0.18727070093154907, -0.5507996678352356, -0.3334585428237915, 0.384563684463501, 0.5015344023704529, -0.24710507690906525, 0.16509519517421722, -0.9452369213104248, 0.14058104157447815, -0.3309580087661743, 0.05939887836575508, 0.19570039212703705, 0.42076852917671204, 0.6183905601501465, -0.14002485573291779, -0.9811710715293884, 0.33931300044059753, 1.4646811485290527, -0.31983980536460876, 0.300128698348999, 0.26244011521339417, 1.0446518659591675, -0.006308271083980799, -0.1681692898273468, 0.1408696174621582, 0.5270267724990845, 0.40426525473594666, 0.35813629627227783, 0.08853833377361298, 0.2365211844444275, -0.7810332775115967, 0.6033775806427002, 1.824894666671753, 0.401700884103775, 0.0711359977722168, -1.0184590816497803, 0.9502236247062683, -1.2261803150177002, -0.5530719757080078, 0.8993541598320007, 0.6368427872657776, 0.3559145927429199, -0.3678306043148041, -0.5504384636878967, -0.27434873580932617, 0.26027145981788635, 0.7668706178665161, -0.3901267647743225, -0.6836615204811096, 0.02690112590789795, 0.18432095646858215, 0.01326932292431593, 0.9943475723266602, -0.4574424624443054, 1.1173912286758423, 14.619335174560547, 0.8689257502555847, 0.01338402833789587, 0.6977083086967468, 0.5960655212402344, 0.24615336954593658, -0.4906558096408844, 0.317970871925354, -1.5008330345153809, -0.04133081063628197, 1.1680631637573242, 0.26744508743286133, 0.5214464664459229, 0.011159747838973999, -0.19045521318912506, 0.36713436245918274, -0.6900174021720886, 0.28418174386024475, 0.5904731154441833, -1.0791434049606323, 0.21563862264156342, 0.2755434215068817, 0.3686417043209076, 0.5155584216117859, 0.9916423559188843, 0.9081184267997742, 0.40527641773223877, -0.2363574355840683, 0.4952867031097412, 0.09275420755147934, 1.0487040281295776, -0.026160500943660736, 0.056604526937007904, 0.2558642625808716, -1.0742138624191284, -0.32547152042388916, -0.867072343826294, -1.1086013317108154, 0.01689663901925087, 0.2615007162094116, -0.18430952727794647, -0.8172978758811951, -0.1910703331232071, 0.7664713263511658, -0.12546201050281525, 0.0539301298558712, -0.15489695966243744, 0.5896304845809937, 0.0032409087289124727, -0.1423414796590805, 0.6281975507736206, 0.38128533959388733, 0.4112171232700348, -0.20832757651805878, 0.442658394575119, -0.034365929663181305, 0.100311279296875, 0.511864960193634, -0.1887706071138382, 0.023840386420488358, -0.29571059346199036, -0.16853834688663483, 0.15477393567562103, 0.7782522439956665, 0.6358335018157959, 0.10155971348285675, -0.4134244918823242, 0.3010784685611725, 0.7534828186035156, 0.3227408528327942, -0.34153759479522705, 0.07458481192588806, 0.39550554752349854, -0.3915511667728424, 0.19843222200870514, 0.5439320802688599, 0.23667852580547333, -0.4828772246837616, -0.600121021270752, -0.2780139148235321, 0.05249708890914917, -0.720589816570282, -0.31347963213920593, 1.0156726837158203, -0.28564661741256714, -0.36421799659729004, 0.292627215385437, -0.7910279631614685, -0.2690516412258148, 0.341722697019577, -1.4555195569992065, -1.0558393001556396, 0.7999827265739441, -0.42558950185775757, -0.4421595633029938, 0.1289975643157959, 1.3472015857696533, 0.06154261901974678, -0.5120167136192322, 0.3379884362220764, 0.2577621638774872, 0.04461035504937172, -0.17904087901115417, -1.0605024099349976, 1.1900584697723389, 0.22182458639144897, -0.056570712476968765, 0.3654312789440155, -0.03693496808409691, 0.1532490849494934, -0.5105940699577332, -0.2447361797094345, 0.978992223739624, -1.3476414680480957, -0.31605827808380127, -1.0670816898345947, -0.7922453284263611, 0.6455017924308777, 0.8933513164520264, 0.03594307601451874, 0.4170737862586975, 0.2248651534318924, -0.6070196628570557, -0.2665586471557617, -0.4415969252586365, 0.23541097342967987, 0.4593692421913147, -0.8617168664932251, -0.19056090712547302, -0.3065202534198761, 0.9017876386642456, -1.2245330810546875, -0.4853455722332001, -0.36579659581184387, 0.32459500432014465, -0.021972045302391052, 0.9609378576278687, -0.1623823344707489, 0.580891489982605, 0.8496271967887878, -0.3482601046562195, -0.9032699465751648, -0.1748693436384201, -0.969585657119751, -0.26517632603645325, 0.4421423077583313, 0.8444811105728149, -0.5156528949737549, 0.2256471812725067, 0.7207484245300293, 0.3069157600402832, -0.92317134141922, -0.712264895439148, -0.32259535789489746, 0.6772009134292603, -0.7914604544639587, 0.6567010283470154, 0.013850288465619087, 0.11597469449043274, 0.09443721920251846, 0.3015247583389282, 0.6906987428665161, -0.01877962052822113, -0.9153224229812622, -0.05654659494757652, 0.11904061585664749, -0.031159233301877975, -0.37738123536109924, -0.5019768476486206, -1.3590933084487915, -0.19438867270946503, -1.1974235773086548, -0.2321004718542099, -0.7578685879707336, -0.40766412019729614, -0.31897982954978943, -0.5626199841499329, -0.015278209932148457, 0.03758501634001732, -0.42691823840141296, -0.29317936301231384, -0.7555241584777832, -0.4068375527858734, 0.9215226173400879, 0.9043115973472595, -0.580885112285614, 0.298821359872818, -0.12289050221443176, -0.15700611472129822, 0.0954059287905693, 0.36929070949554443, -0.41230782866477966, -0.7286999225616455, -1.474403738975525, 0.6859931349754333, -0.29081761837005615, -0.20410475134849548, -0.6523279547691345, 0.5366705060005188, 0.41624322533607483, -0.08750370144844055, -0.11677344143390656, 0.3739890158176422, -1.127628207206726, -0.8511060476303101, 0.2823857069015503, -0.7121403217315674, 0.36993712186813354, 0.3181357979774475, -0.32636523246765137, -0.1535869985818863, 0.8304793834686279, -0.22753581404685974, -1.1331191062927246, -0.7236284613609314, 0.6709033250808716, -0.6283376812934875, 0.220039501786232, -0.2412460446357727, -0.21353578567504883, -1.3104933500289917, -0.29094651341438293, -0.16327796876430511, 0.3707103729248047, -0.18167990446090698, 1.239058256149292, 0.2737604081630707, -1.358062982559204, 0.30268895626068115, 0.6003201007843018, 0.18031080067157745, 0.1546534299850464, 0.5254454016685486, 0.21605801582336426, -0.08799275755882263, 0.8225771188735962, 0.6983833312988281, 0.1781182587146759, -0.9743549823760986, 0.45055294036865234, 0.7038232088088989, -0.7332665324211121, -0.1785152703523636, 1.0588102340698242, -0.19775256514549255, -1.3050320148468018, -0.01300808135420084, -1.7380268573760986, -0.44605889916419983, -0.27846941351890564, 0.5841368436813354, 0.11687271296977997, -0.3568495810031891, -0.0375763475894928, -0.48343104124069214, 0.550274133682251, -0.2372431606054306, -0.5837574005126953, 0.42118415236473083, -0.286449670791626, -0.5642591118812561, 0.7141854763031006, 0.9019704461097717, -0.4212048649787903, -0.8894243836402893, -1.0435519218444824, -0.44799497723579407, 0.028546124696731567, 0.34172993898391724, -0.21844567358493805, -0.2591490149497986, 0.8936232924461365, 0.6077967286109924, 0.5418183207511902, -0.08952547609806061, -0.021750396117568016, 0.34806644916534424, 0.5513042211532593, 0.1878795474767685, -0.7041366100311279, -0.48520731925964355, 1.4373129606246948, 1.2004672288894653, -0.7673230171203613, -0.033045921474695206, -0.1760222166776657, -0.6261476874351501, 0.4887731969356537, 0.41696175932884216, 0.03830919787287712, 1.1320819854736328, -0.16513240337371826, 0.31386712193489075, 0.3905200958251953, -1.3978270292282104, -0.029895778745412827, 0.6940659880638123, 0.9894221425056458, 0.6211247444152832, 0.36257466673851013, 0.400773286819458, 0.700843095779419, 0.01055914256721735, -0.34456372261047363, 0.31078794598579407, 0.5768777132034302, -0.3253595232963562, -0.2658122181892395, -0.012544258497655392, 0.5660671591758728, -0.8666499853134155, -1.1076831817626953, 0.24434053897857666, 0.39575955271720886, 0.33440670371055603, 0.5413421392440796, 0.7843947410583496, 0.24796126782894135, 0.2350660264492035, 0.5138469338417053, 0.5600594282150269, -0.4998225271701813, -0.07675416767597198, -0.08401817828416824, -0.9675067663192749, -0.1184658631682396, 0.10897313058376312, -0.6167984008789062, -0.17926360666751862, 0.25961625576019287, -0.013474835082888603, -0.15468445420265198, 0.2474565953016281, 1.0473990440368652, 0.506837010383606, 0.7009291052818298, -0.2892777919769287, -0.13770785927772522, -0.22987811267375946, -0.9658483862876892, 0.07979605346918106, -0.8840861916542053, -0.00519263930618763, 0.2567424774169922, 0.18389368057250977, -0.5568509697914124]}, "authors": [{"authorId": "2243808364", "name": "Shiyi Zhu"}, {"authorId": "2260831276", "name": "Jingting Ye"}, {"authorId": "2243775310", "name": "Wei Jiang"}, {"authorId": "2287922278", "name": "Siqiao Xue"}, {"authorId": "2256972664", "name": "Qi Zhang"}, {"authorId": "2243304520", "name": "Yifan Wu"}, {"authorId": "2223080664", "name": "Jianguo Li"}], "references": [{"paperId": "4ea5ca620122e6a9a2b000444d36491cebf49c7c", "title": "Advancing Transformer Architecture in Long-Context Large Language Models: A Comprehensive Survey"}, {"paperId": "fdc53c2c10742464087c0525f77e32604827a21d", "title": "Efficient Streaming Language Models with Attention Sinks"}, {"paperId": "c12db2c60e8989f646a29ad4f4d24475e860ad91", "title": "LongNet: Scaling Transformers to 1, 000, 000, 000 Tokens"}, {"paperId": "f5afaccfe90268485a9961c5771ec5e71e9b806c", "title": "Extending Context Window of Large Language Models via Positional Interpolation"}, {"paperId": "60b35c6d68acced19b0c66edcfc0ee0a2c11efed", "title": "Landmark Attention: Random-Access Infinite Context Length for Transformers"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "d6c5aab433d9871cabc01ffb1e5e1ea89141155b", "title": "KERPLE: Kernelized Relative Positional Embedding for Length Extrapolation"}, {"paperId": "e37018d3cfab9cfc29a7b78404e6c86ea18a907e", "title": "GPT-NeoX-20B: An Open-Source Autoregressive Language Model"}, {"paperId": "9ca329408813d209b1dcb36936f7f9cba82506bd", "title": "Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation"}, {"paperId": "66c10bf1f11bc1b2d92204d8f8391d087f6de1c4", "title": "RoFormer: Enhanced Transformer with Rotary Position Embedding"}, {"paperId": "db1afe3b3cd4cd90e41fbba65d3075dd5aebb61e", "title": "The Pile: An 800GB Dataset of Diverse Text for Language Modeling"}, {"paperId": "925ad2897d1b5decbea320d07e99afa9110e09b2", "title": "Longformer: The Long-Document Transformer"}, {"paperId": "f51497f463566581874c941353dd9d80069c5b77", "title": "Compressive Transformers for Long-Range Sequence Modelling"}, {"paperId": "157a7ae44613a1fcf34e2be8c1e19a4f6e3c50e3", "title": "Transfer Learning in Natural Language Processing"}, {"paperId": "b5246fa284f86b544a7c31f050b3bd0defd053fd", "title": "SentencePiece: A simple and language independent subword tokenizer and detokenizer for Neural Text Processing"}, {"paperId": "d3ecb512bc5c91fccfb50003b5094ad1e043b5bb", "title": "opt\\_einsum - A Python package for optimizing contraction order for einsum-like expressions"}, {"paperId": "45dfef0cc1ed96558c1c650432ce39d6a1050b6a", "title": "Fixing Weight Decay Regularization in Adam"}, {"paperId": "204e3073870fae3d05bcbc2f6a8e263d9b72e776", "title": "Attention is All you Need"}, {"paperId": null, "title": "OpenCompass Contributors"}, {"paperId": null, "title": "Wikimedia Foundation"}, {"paperId": null, "title": "utilizing slide window attention, and models such as StreamingLLM (Xiao et al., 2023) and LM-Infinite (Han et al., 2023), which leverage a global-local attention mechanism. These"}, {"paperId": null, "title": "2023. Dynamically scaled rope further increases performance of long context llama with zero fine-tuning"}, {"paperId": null, "title": "have achieved success to a certain face issues we unveiled in this work RoPE as their positional encoding A.2 Extrapolative Position Embedding Methods Extrapolative position embedding"}, {"paperId": null, "title": "2023. Yarn: Efficient context window extension of large language models"}, {"paperId": null, "title": "to enhance the length generalization capability of LLMs"}, {"paperId": null, "title": "bloc97. 2023. Ntk-aware scaled rope allows llama models to have extended (8k+) context size without any fine-tuning and minimal perplexity degradation"}, {"paperId": null, "title": "2023. A length-extrapolatable transformer"}]}