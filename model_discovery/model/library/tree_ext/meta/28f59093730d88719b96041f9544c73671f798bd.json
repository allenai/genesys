{"paperId": "28f59093730d88719b96041f9544c73671f798bd", "title": "USP: A Unified Sequence Parallelism Approach for Long Context Generative AI", "abstract": "Sequence parallelism (SP), which divides the sequence dimension of input tensors across multiple computational devices, is becoming key to unlocking the long-context capabilities of generative AI models. This paper investigates the state-of-the-art SP approaches, i.e. DeepSpeed-Ulysses and Ring-Attention, and proposes a unified SP approach, which is more robust to transformer model architectures and network hardware topology. This paper compares the communication and memory cost of SP and existing parallelism, including data/tensor/zero/pipeline parallelism, and discusses the best practices for designing hybrid 4D parallelism involving SP. We achieved 47% MFU on two 8xA800 nodes using SP for the LLAMA3-8B model training using sequence length 208K. Our code is publicly available at https://github.com/feifeibear/long-context-attention.", "venue": "arXiv.org", "year": 2024, "citationCount": 3, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "This paper compares the communication and memory cost of SP and existing parallelism, including data/tensor/zero/pipeline parallelism, and discusses the best practices for designing hybrid 4D parallelism involving SP."}, "embedding": {"model": "specter_v2", "vector": [0.532160758972168, 0.27553892135620117, 0.14223513007164001, 0.050534024834632874, 0.0019519475754350424, -0.16244050860404968, 1.2141283750534058, -0.4064711034297943, -0.3898044228553772, -0.3750406801700592, 0.560198187828064, 0.17962557077407837, 0.25764185190200806, 0.016664056107401848, -0.252246230840683, -0.3503214120864868, -0.8378294706344604, 0.40737706422805786, 0.01583147421479225, -0.4519510567188263, 0.4111575782299042, -0.19577543437480927, -1.2827166318893433, 0.13769520819187164, 0.13024644553661346, 0.8312272429466248, 0.43624362349510193, 1.318533182144165, -0.30210089683532715, 0.32526931166648865, 0.32300063967704773, -0.46279680728912354, 0.3966212868690491, -0.09022881090641022, -0.5633803606033325, -0.3358965516090393, 0.6734229326248169, -0.5716729760169983, -0.44517332315444946, 0.6499218940734863, -0.06233345344662666, 0.06027667969465256, 0.46317723393440247, -0.7933322191238403, 0.0031800067517906427, 0.7544016242027283, 0.35206130146980286, 1.1136397123336792, -0.42268165946006775, -0.503365695476532, 1.3957396745681763, -1.2074023485183716, 0.1339537799358368, 1.3134454488754272, 0.1706349402666092, 0.47845515608787537, -0.21526406705379486, -0.3432582914829254, 0.5427408218383789, 0.21091561019420624, -0.36908507347106934, -0.2506735622882843, 0.44789308309555054, 0.03811413422226906, 1.8525737524032593, -0.4560422897338867, 0.6118534803390503, 0.8580529689788818, 0.14299806952476501, 1.9242607355117798, -0.2612956464290619, -0.9776637554168701, 0.2070854902267456, -0.7201641798019409, 0.31691402196884155, 0.5348283648490906, -0.3925866186618805, 0.4270384609699249, -1.0885939598083496, -0.11686316877603531, 1.0297715663909912, -0.0061893584206700325, 0.5236186981201172, -0.002266672905534506, -0.7360270023345947, 0.5953033566474915, 0.5040008425712585, 1.1270737648010254, -0.2872885465621948, 1.0970488786697388, 0.5321915745735168, -0.2221447229385376, -0.3305783271789551, 0.527857780456543, 0.3745279908180237, 0.18393047153949738, -0.9057855010032654, 0.5643293857574463, -0.06786438822746277, 0.9133402109146118, -0.23856353759765625, 0.6326205134391785, -0.5130457282066345, 0.1596548706293106, 1.348988652229309, 0.2579445540904999, 0.6047914028167725, -0.715384304523468, 0.09317657351493835, -0.9338820576667786, -0.15037155151367188, -0.8280912041664124, -0.027656037360429764, -0.6091506481170654, -0.7875098586082458, -1.180009365081787, -0.5064563155174255, 0.1911696493625641, -0.8823404908180237, 0.4376138746738434, -0.31725481152534485, 0.5891696214675903, 0.19400084018707275, 0.7573927640914917, 0.20033016800880432, 0.6302977204322815, 0.36156225204467773, 0.6693646907806396, 1.0124106407165527, -1.1211107969284058, -0.3239894509315491, -1.3616657257080078, 0.3727172911167145, -0.045077208429574966, 0.20360393822193146, -0.11959317326545715, -1.6276025772094727, -0.9601215124130249, -1.2830899953842163, -0.07412034273147583, -0.2307891994714737, -0.04318348690867424, 1.5124287605285645, -0.012010152451694012, -0.9250872135162354, 0.8132558465003967, -0.5277455449104309, 0.014765184372663498, 0.5981466770172119, 0.16547270119190216, 0.6124464869499207, -0.14482367038726807, -1.1986321210861206, -0.08016317337751389, 0.28360092639923096, -0.23966604471206665, -0.3686233460903168, -0.3773690164089203, -0.7248919606208801, 0.42164942622184753, 0.23725247383117676, -0.7867674231529236, 1.2929961681365967, 0.025313720107078552, -0.9885302186012268, 0.30824723839759827, -0.10089952498674393, 0.060372717678546906, -0.48237714171409607, 0.09812383353710175, -0.18890675902366638, -0.11901357024908066, -0.20700879395008087, 0.8603751063346863, 0.5807687044143677, 0.1129247173666954, -0.40593376755714417, -0.46886345744132996, -0.16760078072547913, 0.27419185638427734, -0.29015621542930603, 0.7969537973403931, -0.31493863463401794, -0.47224584221839905, 0.4535992741584778, 0.18046636879444122, -0.21790142357349396, -0.5807232856750488, -0.1799045354127884, -1.2305861711502075, 0.7671101689338684, 0.4927069842815399, 0.4816735088825226, -0.9973646998405457, -0.44922056794166565, -0.4805900454521179, -0.045543964952230453, -0.18015749752521515, -0.5234034657478333, 0.3540869653224945, -0.35923585295677185, 0.17050080001354218, -0.39964401721954346, -0.7137598395347595, -0.07498038560152054, 0.1083405390381813, -0.6668062806129456, -0.7185743451118469, 0.32259777188301086, 1.181477427482605, -1.179320216178894, -0.058615803718566895, -0.4184960722923279, 0.10844825208187103, -1.4150220155715942, 1.0591052770614624, -0.7578459978103638, 0.16360394656658173, -0.18651482462882996, -0.17495810985565186, -0.32068032026290894, -0.6244319081306458, 0.516031801700592, -0.4125876724720001, 0.2282864898443222, 0.5491342544555664, -0.48708677291870117, 2.0302071571350098, -0.07096444070339203, 0.39454662799835205, -0.3908546566963196, -0.5770024657249451, 0.11307710409164429, 0.34274929761886597, -0.346260130405426, -0.3516349792480469, 0.20179210603237152, 0.7091860175132751, -0.27129918336868286, 0.3460550308227539, 0.8509564995765686, 1.041955828666687, -0.47865405678749084, 0.3297233283519745, 0.9186068773269653, -0.6711349487304688, 0.7948171496391296, 0.6365359425544739, 0.46555671095848083, 0.635607898235321, 0.046955615282058716, -0.4051918089389801, 0.17464330792427063, -0.9065700769424438, -0.30379414558410645, 0.4456855356693268, 0.4398440420627594, 0.6887417435646057, 0.3377901613712311, -1.1784135103225708, -0.8701457977294922, 0.303213894367218, 0.5151215195655823, 1.2019145488739014, -0.10066991299390793, -0.18688957393169403, -0.7882534265518188, -0.12125393003225327, -0.6410525441169739, -0.05776463821530342, -0.15737172961235046, 0.20042654871940613, -0.6670302152633667, -1.0133068561553955, 0.7709086537361145, 0.39488399028778076, 1.2206343412399292, -0.8100939393043518, -0.6641448736190796, -0.2664126753807068, 0.3308350145816803, -0.7832816243171692, -0.6682434678077698, 0.25267598032951355, -0.4589941203594208, 0.3574783504009247, -0.014064637012779713, -0.040225204080343246, -0.08817118406295776, -0.5708521008491516, 0.9174145460128784, -0.7322837710380554, -0.27866318821907043, 0.10445482283830643, 0.8136560320854187, -0.7782612442970276, -0.5104843378067017, 0.28999441862106323, 0.05980934947729111, -0.19095589220523834, 0.3187728226184845, -0.03143347054719925, -0.13214221596717834, -0.08810977637767792, -0.5106751322746277, 0.21077562868595123, 0.037753380835056305, 0.16369538009166718, 0.8783694505691528, -0.5845866203308105, 0.003384823678061366, -0.7280357480049133, 0.5600920915603638, 0.35295602679252625, -0.3345833122730255, 0.18525345623493195, -0.34451091289520264, 0.027529774233698845, 0.44339507818222046, -0.5146539211273193, -0.41085734963417053, -0.8499184846878052, 0.3559844493865967, -0.5350107550621033, -0.5394249558448792, -0.21521033346652985, 0.4887424111366272, 0.1190117821097374, 0.6391828060150146, 0.5244448781013489, 0.19123327732086182, 0.26415154337882996, 0.5577303767204285, -0.8557960987091064, 0.8385624885559082, -0.06988959014415741, -0.343190997838974, 0.0001874151057563722, 0.4231607913970947, -0.6922385692596436, -0.6437652707099915, -0.22785426676273346, -0.6620990633964539, -0.28650814294815063, 0.4743320047855377, -0.16129617393016815, -0.9784067273139954, 0.20673733949661255, -1.1604405641555786, 0.07659171521663666, 0.14295072853565216, -0.227011039853096, -0.53541100025177, -0.9886864423751831, -1.3583765029907227, -0.362545371055603, -1.0041333436965942, -1.1307824850082397, 0.5843360424041748, 0.3009134829044342, -0.16056759655475616, -0.5557435750961304, 0.08650302141904831, -0.3518218398094177, 0.9768905639648438, -0.517195999622345, 0.404936820268631, -0.07345694303512573, -0.4184025526046753, 0.018334195017814636, 0.2408783882856369, 0.03279013931751251, -0.6359816789627075, 0.18740998208522797, -1.0118964910507202, 0.5080708861351013, -0.1273362934589386, -0.4551869034767151, 0.05424872785806656, 0.27352848649024963, 0.6773200035095215, 0.046989116817712784, -0.3864503502845764, 0.38706088066101074, 1.2783393859863281, -0.22979356348514557, 0.2572488486766815, -0.20734721422195435, 1.3643251657485962, 0.03185116872191429, -0.44850489497184753, 0.6142524480819702, 0.26287052035331726, 0.3459899425506592, 0.3817436993122101, 0.21519160270690918, -0.22825397551059723, -0.4583496153354645, 0.10277832299470901, 1.443556785583496, 0.09369801729917526, 0.2980930805206299, -1.1004563570022583, 0.701022744178772, -1.0485870838165283, -0.9116319417953491, 0.9136047959327698, 0.45184624195098877, 0.10594134032726288, -0.43254354596138, -0.22712640464305878, -0.047616228461265564, 0.35870879888534546, 0.4519089162349701, -0.45711252093315125, -0.8216536641120911, 0.026260394603013992, 0.32072311639785767, -0.16942225396633148, 0.44013240933418274, -0.13563232123851776, 0.5311871767044067, 14.838759422302246, 0.9332551956176758, -0.015312794595956802, 0.2845081090927124, 0.9031080007553101, 0.23298503458499908, -0.6587027907371521, -0.14697030186653137, -1.341064214706421, -0.14359524846076965, 1.5999315977096558, 0.43397998809814453, 0.8263006806373596, 0.26767289638519287, -0.8037630319595337, 0.4223727285861969, -0.7103399634361267, 0.7690606713294983, 0.7069348692893982, -1.6869057416915894, 0.19096678495407104, 0.2042923867702484, 0.3532765507698059, 0.9789891242980957, 0.45471489429473877, 0.5393350124359131, 0.5360193252563477, 0.018111439421772957, 0.3981197476387024, 0.28242695331573486, 0.6233169436454773, -0.2331373393535614, -0.030187638476490974, 0.28775012493133545, -0.736318826675415, -0.16777242720127106, -0.4301812946796417, -1.0773693323135376, 0.008470225147902966, -0.2348785102367401, -0.7863941788673401, -0.3256164789199829, -0.08062797784805298, 0.7581189870834351, 0.2002142071723938, 0.10910536348819733, -0.23445144295692444, 0.39170798659324646, -0.4149472415447235, -0.10509541630744934, 0.5311291217803955, 0.36382347345352173, 0.30437570810317993, -0.31784752011299133, -0.012621406465768814, 0.1745382696390152, 0.06988807767629623, 0.673733651638031, -0.16236846148967743, -0.5034950971603394, -0.38763415813446045, -0.5379453897476196, -0.09231196343898773, 0.915976345539093, 0.29990705847740173, 0.2681531608104706, -0.1847527027130127, 0.32284149527549744, 0.42818483710289, -0.038748376071453094, -0.13825535774230957, -0.07308042049407959, -0.19951489567756653, -1.153548002243042, 0.11541980504989624, 0.2514413595199585, -0.5194635987281799, -0.49100878834724426, -0.785317063331604, -0.31971144676208496, 0.49592193961143494, -1.0314494371414185, -0.5635338425636292, 1.2064151763916016, -0.04987388849258423, -0.16553524136543274, -0.31563231348991394, -0.7667895555496216, -0.21739277243614197, 0.2695762515068054, -1.1074894666671753, -1.139705777168274, 0.4855296313762665, -0.13142623007297516, -0.22554698586463928, -0.1137562021613121, 1.4154632091522217, -0.03184384107589722, -0.2825634479522705, -0.08330430090427399, -0.4726962745189667, -0.21209271252155304, -0.7271232604980469, -0.9460269212722778, 1.2436528205871582, 0.6201497912406921, 0.38502803444862366, -0.05941469967365265, -0.07579623907804489, 0.23595815896987915, -1.004671335220337, 0.5951687693595886, 0.4270242750644684, -0.956530749797821, -0.196808323264122, -0.768656313419342, -0.6577880382537842, 0.3456239104270935, 0.7311880588531494, -0.031544897705316544, 0.06674771010875702, 0.05760703608393669, -0.5571964383125305, -0.20695443451404572, -0.586828887462616, 0.45427319407463074, 0.4926314949989319, -0.6943942308425903, -0.20624591410160065, -0.2643086910247803, 0.6511631011962891, -1.024338722229004, -0.8452519774436951, -0.31108200550079346, 0.3612336814403534, 0.022096306085586548, 0.9709711670875549, 0.08786078542470932, 0.8441439867019653, 0.7588903307914734, -0.23609188199043274, -0.3928353488445282, -0.11532485485076904, -1.0655715465545654, -0.03700723126530647, 0.07563632726669312, 0.4044850766658783, -0.047751687467098236, 0.3247225880622864, 0.8961211442947388, 0.041353147476911545, -0.3930426836013794, -0.5540928840637207, 0.07528333365917206, -0.049562904983758926, -0.616184413433075, 0.6005699634552002, -0.1590016633272171, 0.056592393666505814, 0.5797014236450195, 0.4125695824623108, 0.5803008079528809, -0.0806509330868721, -0.3871161639690399, 0.15310081839561462, 0.09911118447780609, -0.2864568829536438, -0.6661481857299805, -0.677001953125, -1.3947503566741943, -0.4956945478916168, -1.0748865604400635, -0.31609830260276794, -0.5300365090370178, -0.6925897002220154, -0.05926933139562607, -0.18279032409191132, 0.20370778441429138, 0.34800252318382263, -0.3663673400878906, -0.21290433406829834, -0.22926969826221466, -0.2416205108165741, 0.9087315797805786, 0.9648423790931702, -0.6113629937171936, 0.17030061781406403, -0.45044347643852234, 0.10481442511081696, -0.012043548747897148, 0.2785087525844574, -0.04013993963599205, -0.9241002202033997, -1.397980809211731, 0.3899778425693512, 0.14306345582008362, -0.14046934247016907, -1.274660348892212, 0.7153714895248413, 0.490831196308136, -0.2079516053199768, -0.10746394097805023, 0.4558619558811188, -0.9016006588935852, -0.7662500143051147, 0.22385109961032867, -0.8544273376464844, 0.09941737353801727, 0.408523291349411, -0.5060670971870422, 0.05707414448261261, 0.6132144331932068, -0.36756381392478943, -1.0708208084106445, -0.8266341686248779, 0.4846038818359375, -0.2019764930009842, -0.07247605174779892, -0.5114269256591797, -0.09596841782331467, -1.0775145292282104, 0.0573728084564209, 0.1305067390203476, 0.1256578266620636, -0.5201414823532104, 0.7997869849205017, 0.42209020256996155, -1.0154491662979126, 0.002425701357424259, 0.41598373651504517, -0.2170538306236267, 0.5435866117477417, 0.6727074980735779, 0.23714540898799896, -0.050895169377326965, 0.6467193365097046, -0.15649312734603882, -0.23958717286586761, -0.3412179946899414, 0.1513279527425766, 0.7518776059150696, -0.4352843463420868, -0.0581001378595829, 1.0677393674850464, -0.17913465201854706, -0.9504472613334656, -0.19078847765922546, -0.7968178987503052, -0.7465846538543701, -0.4626147747039795, 0.838240385055542, -0.08319338411092758, -0.3476983904838562, 0.24931499361991882, -0.47598811984062195, 0.23521678149700165, -0.3116093575954437, -0.9354190826416016, 0.5582131743431091, 0.17648649215698242, -0.32573753595352173, 0.6775184273719788, 0.5167445540428162, -0.9409893751144409, -0.974931538105011, -0.7279695272445679, -0.33236032724380493, -0.19819261133670807, 0.531071126461029, -0.46554118394851685, -0.5324877500534058, 1.2012131214141846, 0.4380144774913788, 0.4039159417152405, 0.10580036789178848, -0.11545486003160477, 0.3628205358982086, 0.5790587663650513, 0.06538030505180359, -0.2972530126571655, -0.14284637570381165, 1.514737606048584, 1.471186637878418, -0.5245845317840576, 0.002879959996789694, 0.07188145816326141, -0.886570930480957, 0.8512986302375793, 0.4690612852573395, -0.43659278750419617, 0.38264042139053345, 0.07191457599401474, -0.4052322506904602, -0.18779771029949188, -1.0690665245056152, 0.0735994353890419, 0.7190428376197815, 0.8954338431358337, 0.5096466541290283, 0.09079143404960632, 0.16675853729248047, 0.5990796685218811, 0.053886089473962784, 0.03300663083791733, 0.3407701849937439, 0.5870735049247742, 0.05722081661224365, 0.14531542360782623, 0.07150483876466751, 0.3737598955631256, -0.7312957048416138, -0.6619230508804321, 0.49917519092559814, 0.11518868058919907, -0.10645371675491333, 0.3895685374736786, 1.1993770599365234, 0.24243411421775818, 0.07497590035200119, 0.03649776801466942, 1.0463539361953735, -0.19185936450958252, -0.21127678453922272, 0.30445393919944763, -0.6664342284202576, 0.00699688820168376, -0.4257759153842926, -0.6832715272903442, -0.7577020525932312, 0.10191447287797928, 0.2625747323036194, -0.19741599261760712, 0.7567445039749146, 1.1011024713516235, 0.9327739477157593, 0.45305851101875305, -0.2052427977323532, -0.9376281499862671, -0.2664946913719177, -0.9719698429107666, 0.35108304023742676, -0.311225563287735, -0.5191232562065125, -0.07127556204795837, 0.07830758392810822, -0.11240211129188538]}, "authors": [{"authorId": "2301458823", "name": "Jiarui Fang"}, {"authorId": "2301166902", "name": "Shangchun Zhao"}], "references": [{"paperId": "6dc5c6190dfbe55c8b45b7b23800614c21e5b51c", "title": "MegaScale: Scaling Large Language Model Training to More Than 10, 000 GPUs"}, {"paperId": "ade22704be8a0fc3730d320cc7934b2ccbcd97e4", "title": "Striped Attention: Faster Ring Attention for Causal Transformers"}, {"paperId": "02ad9f3fefe33cb9ca546591bec65dbdf7766c80", "title": "Ring Attention with Blockwise Transformers for Near-Infinite Context"}, {"paperId": "a51ac7a5e8f6454268ac16ecdc52ecac98ce54d9", "title": "DeepSpeed Ulysses: System Optimizations for Enabling Training of Extreme Long Sequence Transformer Models"}, {"paperId": "5ae6fb6b5a3c7df515ff4a82ac9673bae6a8e200", "title": "GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints"}, {"paperId": "2e700ff36108119f5ed19a53bd2eaa22b42ec3d8", "title": "Tutel: Adaptive Mixture-of-Experts at Scale"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "bc8b82e8eb0b0714892e4ec7a54ebdf47c4fde96", "title": "Reducing Activation Recomputation in Large Transformer Models"}, {"paperId": "ee8984a6712791d4e0f2c776dad8119a3b893dd9", "title": "Colossal-AI: A Unified Deep Learning System For Large-Scale Parallel Training"}, {"paperId": "10c0a1d3519dcc7b876d21d614f49d82467c9dc3", "title": "Parallel Training of Pre-Trained Models via Chunk-Based Dynamic Memory Management"}, {"paperId": "66c10bf1f11bc1b2d92204d8f8391d087f6de1c4", "title": "RoFormer: Enhanced Transformer with Rotary Position Embedding"}, {"paperId": "12b71736392209b4292471b7da0aed71ba2aa545", "title": "ZeRO-Offload: Democratizing Billion-Scale Model Training"}, {"paperId": "dc52b09089704ebd6f471177474bc29741c50023", "title": "Fast Transformer Decoding: One Write-Head is All You Need"}, {"paperId": "00c957711b12468cb38424caccdf5291bb354033", "title": "ZeRO: Memory optimizations Toward Training Trillion Parameter Models"}, {"paperId": "8323c591e119eb09b28b29fd6c7bc76bd889df7a", "title": "Megatron-LM: Training Multi-Billion Parameter Language Models Using Model Parallelism"}, {"paperId": "942deb7d865b7782c03176d95e3a0d56cb71009e", "title": "Training Deep Nets with Sublinear Memory Cost"}, {"paperId": "5e424004958853f4e366e7a86a1c3a56a76cb2a4", "title": "LightSeq: Sequence Level Parallelism for Distributed Training of Long Context Transformers"}, {"paperId": "28682682ce59cf90de9da7d62d1c17513fdac09a", "title": "Sequence Parallelism: Making 4D Parallelism Possible"}, {"paperId": null, "title": "Introducing meta llama 3: The most capable openly available llm to date"}, {"paperId": null, "title": "Based on the above analysis, under the same model and input configurations 1, simply switching parallelism from TP-sp to SP-Unified does"}, {"paperId": null, "title": "of memory cost"}, {"paperId": null, "title": "Tip 4: We suggest that SP may have an advantage over TP when employing MQA in terms of communication cost, as MQA can reduce the communication cost of SP without affecting TP"}]}