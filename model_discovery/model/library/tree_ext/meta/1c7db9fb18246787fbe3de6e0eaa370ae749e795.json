{"paperId": "1c7db9fb18246787fbe3de6e0eaa370ae749e795", "title": "Quest: Query-Aware Sparsity for Efficient Long-Context LLM Inference", "abstract": "As the demand for long-context large language models (LLMs) increases, models with context windows of up to 128K or 1M tokens are becoming increasingly prevalent. However, long-context LLM inference is challenging since the inference speed decreases significantly as the sequence length grows. This slowdown is primarily caused by loading a large KV cache during self-attention. Previous works have shown that a small portion of critical tokens will dominate the attention outcomes. However, we observe the criticality of a token highly depends on the query. To this end, we propose Quest, a query-aware KV cache selection algorithm. Quest keeps track of the minimal and maximal Key values in KV cache pages and estimates the criticality of a given page using Query vectors. By only loading the Top-K critical KV cache pages for attention, Quest significantly speeds up self-attention without sacrificing accuracy. We show that Quest can achieve up to 2.23x self-attention speedup, which reduces inference latency by 7.03x while performing well on tasks with long dependencies with negligible accuracy loss. Code is available at http://github.com/mit-han-lab/Quest .", "venue": "arXiv.org", "year": 2024, "citationCount": 3, "influentialCitationCount": 1, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "This work proposes Quest, a query-aware KV cache selection algorithm that can achieve up to 2.23x self-attention speedup, which reduces inference latency by 7.03x while performing well on tasks with long dependencies with negligible accuracy loss."}, "embedding": {"model": "specter_v2", "vector": [-0.19951586425304413, 0.05194592848420143, -0.8023278713226318, -0.08826974779367447, -0.4623892307281494, -0.2048015296459198, 0.4606441855430603, -0.0011809013085439801, -0.6836904883384705, -0.1707206517457962, 0.7757860422134399, 0.11575446277856827, 0.6739181280136108, 0.4235957860946655, -0.21093644201755524, 0.15395793318748474, -1.1006850004196167, 0.04006579890847206, 0.2878587245941162, -0.1307019144296646, 0.05741710588335991, -0.9228002429008484, -1.1138999462127686, 0.19262662529945374, 0.5107751488685608, 0.6097135543823242, 0.6334956288337708, 1.0035122632980347, -0.7092759609222412, 0.2023991495370865, 0.535477876663208, -0.17302846908569336, -0.07244502753019333, 0.11271078139543533, -0.43567967414855957, -0.4905944764614105, 0.6019198894500732, -0.2823217213153839, -0.28811419010162354, 0.7920163869857788, -0.014492793940007687, 0.17628522217273712, 0.29880115389823914, -0.819879412651062, -0.16104814410209656, 0.8127228021621704, 0.40238335728645325, 0.7837291955947876, -0.4446391463279724, -0.7536088824272156, 1.8537174463272095, -1.6719688177108765, 0.2301016002893448, 1.2730224132537842, 0.3265054523944855, 0.37988054752349854, -0.17928048968315125, -0.4600895643234253, 1.0790770053863525, 0.5874001383781433, -0.9402278065681458, -0.4893704950809479, -0.21254286170005798, 0.010831027291715145, 2.333594799041748, -0.0962098240852356, 0.2177577167749405, 0.7137013077735901, 0.2477777600288391, 1.614380121231079, -0.34415099024772644, -0.7581048607826233, -0.0022669476456940174, -0.018934160470962524, 0.44643038511276245, 0.7141404151916504, -0.4254041016101837, -0.029177485033869743, -1.0839186906814575, -0.5805665254592896, 0.2794831097126007, -0.32094329595565796, 0.34805724024772644, -0.22333405911922455, -0.1123574748635292, 0.8087469339370728, 0.05588238686323166, 0.9437227249145508, -0.03201812133193016, 0.8856685757637024, 0.5404812693595886, -0.01862316206097603, 0.18374210596084595, 0.28123071789741516, -0.300362229347229, 0.08774343878030777, -1.3370013236999512, 0.5712670087814331, 0.29523104429244995, 0.7456967830657959, -0.1720844954252243, 0.08468922972679138, -0.7975277900695801, 0.26597684621810913, 1.2133398056030273, 0.24085582792758942, 0.6022042632102966, -0.6433477401733398, 0.20472164452075958, -0.8601222634315491, -0.05063978210091591, -0.5130918622016907, -0.29179587960243225, -0.4363705813884735, -0.4898131489753723, -1.3617898225784302, -0.629172682762146, 0.07865659147500992, -0.1631728708744049, 0.8300815224647522, 0.17474308609962463, 0.444347083568573, 0.023502547293901443, 0.42989885807037354, 0.37471532821655273, 0.6298626065254211, 0.4213647246360779, 0.0513804592192173, 1.2003120183944702, -1.208223819732666, -0.5182523131370544, -1.2485644817352295, 1.0771125555038452, -0.21393905580043793, 0.5339664816856384, -0.3018743395805359, -1.025891900062561, -0.8723312616348267, -0.870320200920105, -0.22387909889221191, -0.6379616856575012, 0.3268711268901825, 0.9943752288818359, 0.05576601251959801, -0.8203384280204773, 0.48894861340522766, -0.09354377537965775, -0.13210713863372803, 0.07221131026744843, -0.16860660910606384, 0.36163240671157837, -0.4023110270500183, -1.9420921802520752, 0.21728269755840302, 0.15887334942817688, -0.47098150849342346, -0.3121786117553711, -0.8817903399467468, -1.1291261911392212, -0.08391405642032623, 0.7675042152404785, -0.21608762443065643, 1.275935173034668, 0.0535881482064724, -0.8955208659172058, 0.6511948704719543, -0.6061341166496277, 0.10964903980493546, 0.2027563601732254, -0.5357479453086853, -0.7014138698577881, -0.6137906312942505, 0.045136794447898865, 0.48376065492630005, 0.7296209931373596, -0.021815627813339233, -0.6943975687026978, 0.0015145285287871957, -0.37247222661972046, 0.19397035241127014, -0.19214722514152527, 0.612682580947876, -1.037665843963623, -0.3357584476470947, 0.08201885968446732, 0.6046238541603088, -0.06978890299797058, -0.36594945192337036, -0.3043127655982971, -1.3749189376831055, 0.7629116773605347, 0.025573378428816795, 1.3475825786590576, -0.6974985599517822, -0.9610368013381958, -0.17682461440563202, 0.022653674706816673, 0.012909741140902042, -0.8337896466255188, 0.9785533547401428, -0.08427722752094269, 0.15749432146549225, 0.17657241225242615, -1.1120885610580444, 0.2129162847995758, -0.31446123123168945, -0.8877660036087036, -0.44661667943000793, -0.124701589345932, 1.1589477062225342, -1.1922470331192017, -0.3980060815811157, -0.2813855707645416, 0.3415274918079376, -1.103235125541687, 1.1732158660888672, -0.8948906064033508, -0.08471976220607758, -0.3099032938480377, -0.3106692135334015, -0.09723223745822906, -0.4504539966583252, 0.6668978929519653, -0.45743924379348755, -0.09765462577342987, 0.518489420413971, -0.42417237162590027, 1.290877342224121, -0.7197522521018982, 0.40483400225639343, -0.1706487238407135, -0.12597212195396423, -0.36663174629211426, 0.18342776596546173, -0.2603662312030792, -0.4821487069129944, -0.32680681347846985, 0.19019131362438202, -0.9551447629928589, -0.08899541199207306, 0.9168639779090881, 1.3157325983047485, -0.29612889885902405, 0.20569537580013275, 0.28729045391082764, 0.1316090226173401, 0.4479333758354187, 0.7042085528373718, 0.7143547534942627, 0.5102142691612244, 0.5437082052230835, -0.18290522694587708, 0.5528148412704468, -0.5954312682151794, -0.11102338135242462, 0.7743474245071411, 0.9880236387252808, 0.144938662648201, 0.43844056129455566, -0.6040177345275879, -0.4623173773288727, 0.5268027186393738, 0.46541956067085266, 1.8574198484420776, -0.16069261729717255, -0.6581798195838928, -0.8893864154815674, -0.4671030640602112, -0.11049528419971466, 0.21669332683086395, -0.34590595960617065, 0.10148576647043228, -0.502792477607727, -0.8694087266921997, 0.7601414322853088, 0.3700566589832306, 0.8464104533195496, -0.7272143959999084, -0.3209420144557953, 0.0804896205663681, 0.13452982902526855, -1.1576117277145386, -0.7126067280769348, 0.4462798237800598, -0.4948071837425232, 0.014643942005932331, 0.16801008582115173, -0.10306143015623093, -0.09644749015569687, -0.7349874377250671, 1.2671030759811401, -0.4320186674594879, -0.5179445147514343, 0.10629668086767197, 0.36903974413871765, -0.13484898209571838, -0.356997549533844, 0.5975950360298157, 0.3254040479660034, -0.3144369125366211, 0.6777148842811584, 0.4173429310321808, -0.11633405834436417, -0.19143269956111908, -0.15890012681484222, 0.24637088179588318, 0.13261649012565613, -0.12331501394510269, 0.7474477887153625, -0.23977287113666534, 0.01117206271737814, -1.2709109783172607, 0.7958838939666748, -0.03699762374162674, -0.5387575626373291, 0.2820170223712921, -1.0401142835617065, -0.30402469635009766, 0.5613458156585693, -0.8873016834259033, -0.15866033732891083, -0.8330934643745422, 0.14165814220905304, -0.38937175273895264, -0.06411789357662201, 0.16159702837467194, 0.05134695768356323, 0.4728129804134369, 0.08782970905303955, 0.7391838431358337, -0.08090455085039139, -0.45736992359161377, 0.8149303197860718, -0.7772027850151062, 0.6212603449821472, 0.01508628111332655, -0.01985343173146248, -0.18461142480373383, -0.06513654440641403, -1.1317381858825684, -0.5358250737190247, -0.8351414203643799, -0.3085205554962158, 0.11179361492395401, 0.2819381654262543, -0.6847595572471619, -0.9337074160575867, -0.23764115571975708, -0.7668583989143372, -0.5302768349647522, 0.6429182887077332, -0.10343857109546661, -0.11230526119470596, -0.7809355854988098, -1.2404247522354126, -0.7020904421806335, -0.9368808269500732, -0.6382951140403748, 0.5849493145942688, -0.2741711139678955, -0.549905002117157, -0.8297580480575562, -8.823043754091486e-05, -0.5492264032363892, 0.9699879884719849, -1.06881844997406, 0.9228699803352356, 0.083848737180233, -0.347472220659256, -0.17643195390701294, 0.07045795023441315, 0.18730884790420532, -0.3569733202457428, -0.2222938984632492, -0.9993123412132263, 0.04324491322040558, -0.3531830906867981, -0.2806507349014282, 0.28784093260765076, 0.3992534875869751, 0.8666094541549683, -0.14437083899974823, -1.0165989398956299, 0.46643486618995667, 1.7997854948043823, -1.0587610006332397, -0.10130494832992554, -0.1400073915719986, 1.153657078742981, -0.014403440058231354, 0.2428836077451706, 0.6495206356048584, 0.5979466438293457, 0.4127514064311981, 0.3448585569858551, 0.011880917474627495, 0.3299219012260437, -0.7330453991889954, 0.5491090416908264, 1.6659438610076904, 0.5860174894332886, 0.18852104246616364, -0.7592743635177612, 0.9019597172737122, -1.3297877311706543, -0.5237522125244141, 0.5987628698348999, 0.6494349241256714, 0.5515965223312378, -0.4845321476459503, -0.2844030559062958, -0.6585689187049866, -0.08567771315574646, 0.5753604173660278, -0.699808657169342, -0.600032389163971, 0.17112576961517334, 0.07760439068078995, 0.24616141617298126, 0.7680208086967468, -0.5966617465019226, 1.1075645685195923, 14.368690490722656, 1.2218267917633057, 0.11453598737716675, 0.7212927937507629, 0.5172695517539978, 0.14960050582885742, -0.34708812832832336, -0.19867068529129028, -2.0594546794891357, -0.21703557670116425, 1.228524923324585, 0.3761197626590729, 0.4222583770751953, 0.3580586612224579, 0.17624713480472565, -0.11419966071844101, -0.5993281006813049, 0.6003590226173401, 0.6833629012107849, -1.1989635229110718, 0.22840173542499542, 0.07064742594957352, 0.10892318934202194, 0.624134361743927, 0.6753156781196594, 0.9478980898857117, 0.6928098797798157, -0.2177661955356598, 0.23038706183433533, 0.2043108195066452, 0.9962482452392578, -0.07362259924411774, 0.06758259236812592, 0.7055028676986694, -1.0530184507369995, -0.09815694391727448, -0.9411022067070007, -0.7998657822608948, -0.0874270498752594, 0.43222522735595703, -0.6228011846542358, -0.6331828832626343, 0.03476567938923836, 0.419192910194397, -0.1392914205789566, 0.12313555181026459, -0.016689486801624298, 0.6623364090919495, 0.16587290167808533, -0.1988845318555832, 0.58448326587677, 0.7708215713500977, 0.3129201829433441, 0.26260852813720703, -0.03787459805607796, -0.19324682652950287, 0.20704658329486847, 0.389339804649353, -0.16672587394714355, 0.3132381737232208, -0.0600876584649086, -0.07726335525512695, 0.03113778866827488, 0.9761295914649963, 0.8570153713226318, 0.1956378072500229, -0.40597063302993774, 0.7823658585548401, 0.8105199933052063, 0.28618666529655457, -0.31968018412590027, 0.3738373816013336, 0.7398749589920044, -0.7696666121482849, 0.36879241466522217, 0.4549233317375183, 0.33925876021385193, -0.7314987182617188, -0.5895177125930786, -0.39010438323020935, 0.575342059135437, -0.5379411578178406, -0.8536209464073181, 0.6389421224594116, -0.14097952842712402, -0.35112273693084717, -0.34958934783935547, -0.6326848268508911, -0.07131648808717728, 0.49586164951324463, -1.2858651876449585, -0.7417809963226318, 0.7291083931922913, -0.48242267966270447, -0.08005669713020325, 0.4580845236778259, 1.5395417213439941, 0.07828956842422485, -0.2179589867591858, 0.32989609241485596, 0.4838418960571289, -0.18714062869548798, -0.20129114389419556, -0.7939401268959045, 1.2185828685760498, 0.25968706607818604, 0.01853090524673462, 0.45439884066581726, -0.06719334423542023, -0.23032964766025543, -1.1080741882324219, -0.4250381290912628, 0.9017799496650696, -1.1259567737579346, -0.4799071252346039, -1.1404197216033936, -0.8226905465126038, 0.10855051130056381, 0.438039630651474, -0.07209405303001404, 0.3449164628982544, 0.2144956737756729, -0.7673208117485046, -0.09970483928918839, -0.31727471947669983, 0.30928975343704224, 0.6730086803436279, -0.7138727903366089, 0.09278995543718338, -0.25002583861351013, 0.425179660320282, -0.9173715114593506, -0.7432457208633423, -0.5143523812294006, 0.44453105330467224, 0.1684991419315338, 1.0397483110427856, -0.5199317932128906, 0.7383909821510315, 0.8852943181991577, -0.34746667742729187, -0.6974287033081055, 0.01164380181580782, -0.6956139802932739, -0.6519479155540466, 0.20826490223407745, 0.809456467628479, -0.17411111295223236, 0.3770388662815094, 0.7620815634727478, 0.9781449437141418, -0.8990335464477539, -0.3990858197212219, -0.5278023481369019, 0.15766571462154388, -0.6832600235939026, 0.3841804265975952, 0.22868897020816803, -0.07134716212749481, 0.3260571360588074, 0.09888003021478653, 0.8366904854774475, 0.2566722333431244, -0.5764725804328918, 0.4777982532978058, 0.1200404092669487, -0.2510337233543396, -0.08148297667503357, -0.15524432063102722, -1.3978326320648193, 0.12497465312480927, -0.9535046815872192, -0.22872108221054077, -0.7675812244415283, -0.4156531095504761, -0.059757351875305176, -0.28331270813941956, -0.24292269349098206, -0.052661363035440445, -0.44036757946014404, -0.5920237898826599, -0.6495726108551025, -0.7200860381126404, 0.4436318874359131, 0.563279390335083, -0.35297635197639465, 0.21061328053474426, 0.06609214097261429, 0.18927839398384094, 0.1500394344329834, 0.40687084197998047, -0.24305970966815948, -0.7690543532371521, -1.1133912801742554, 0.9680561423301697, -0.24789364635944366, -0.14799855649471283, -0.5644923448562622, 0.739677906036377, 0.21794945001602173, 0.17177096009254456, -0.5012279152870178, 0.3725613057613373, -0.9452843070030212, -0.5982210040092468, 0.2769552171230316, -0.9566367268562317, 0.17248645424842834, 0.000453685293905437, -0.4478834569454193, -0.18870286643505096, 0.4796391427516937, -0.48304682970046997, -1.3099390268325806, -1.259191870689392, 0.4986734390258789, -0.43557530641555786, 0.4746586084365845, -0.7655046582221985, 0.28368067741394043, -0.9061324596405029, -0.6327059268951416, 0.16824288666248322, 0.7488930821418762, -0.40176063776016235, 1.274104356765747, 0.28372734785079956, -1.1383683681488037, 0.10575809329748154, 0.24213740229606628, 0.23716555535793304, 0.02148689515888691, 0.8903871774673462, 0.31317251920700073, 0.07259882986545563, 0.7183257937431335, 0.6362058520317078, 0.16653141379356384, -1.1677242517471313, 0.38043397665023804, 0.510074257850647, -0.8505752086639404, -0.24531503021717072, 0.9389745593070984, -0.05488152429461479, -0.8292863965034485, 0.1492537260055542, -1.3199490308761597, -0.6863398551940918, -0.26563721895217896, 0.9599161148071289, 0.12960471212863922, -0.07325535267591476, 0.031147651374340057, -0.7929070591926575, 0.272605299949646, -0.22615954279899597, -0.6362108588218689, 0.5163243412971497, -0.38082700967788696, -0.5520016551017761, 0.7988628149032593, 1.2722588777542114, -0.38332971930503845, -0.6475820541381836, -0.8715381622314453, -0.275321900844574, -0.07280302047729492, 0.5842863917350769, -0.36731207370758057, -0.16475269198417664, 0.6090204119682312, 0.4834233820438385, 0.3195710778236389, -0.2596370279788971, -0.04564271122217178, 0.4821108877658844, 0.963766872882843, 0.003920000046491623, -0.9748867154121399, -0.7655887603759766, 1.2369210720062256, 1.1646219491958618, -0.7922290563583374, 0.14425595104694366, -0.054308053106069565, -0.7775261402130127, 0.5146033763885498, 0.6616443991661072, 0.17774511873722076, 0.9691362977027893, -0.1481480747461319, 0.22184620797634125, 0.08005070686340332, -1.6152386665344238, -0.39130523800849915, 1.0918926000595093, 0.8369082808494568, 0.639803946018219, 0.19367259740829468, 0.18630021810531616, 0.6544715166091919, 0.19642435014247894, -0.07642392069101334, -0.041427355259656906, 0.23573124408721924, -0.20955127477645874, -0.022278377786278725, 0.11393014341592789, 0.7243035435676575, -0.9629368185997009, -1.1128748655319214, 0.3896409273147583, 0.4614065885543823, 0.006674293428659439, 0.33233851194381714, 0.8252696990966797, 0.2313528209924698, 0.01608848385512829, 0.41706982254981995, 0.43673834204673767, -0.3792809247970581, -0.013565531931817532, -0.16458572447299957, -0.5773463249206543, -0.3381792902946472, 0.20959651470184326, -0.41377758979797363, -0.327699214220047, 0.052207037806510925, 0.38634151220321655, 0.008604304865002632, 0.4522824287414551, 1.0320961475372314, 0.6182927489280701, 0.2604725658893585, -0.29736146330833435, 0.02242784947156906, -0.6558064818382263, -0.9227856397628784, -0.05561988055706024, -0.8133137822151184, -0.2155187875032425, 0.24551545083522797, 0.08658459782600403, -0.502364456653595]}, "authors": [{"authorId": "2214687479", "name": "Jiaming Tang"}, {"authorId": "2263892209", "name": "Yilong Zhao"}, {"authorId": "2283850199", "name": "Kan Zhu"}, {"authorId": "2046958974", "name": "Guangxuan Xiao"}, {"authorId": "3178312", "name": "Baris Kasikci"}, {"authorId": "2249530374", "name": "Song Han"}], "references": [{"paperId": "db7498f569be9852a04b2bb5bd68bd2885820bea", "title": "World Model on Million-Length Video And Language With Blockwise RingAttention"}, {"paperId": "aa59cf5b16970bd47f92c9da854246c01d482c58", "title": "Parallel Top-K Algorithms on GPU: A Comprehensive Study and New Methods"}, {"paperId": "9529e50807f36acf3d2e4af994b5803c47e4746a", "title": "Atom: Low-bit Quantization for Efficient and Accurate LLM Serving"}, {"paperId": "fdc53c2c10742464087c0525f77e32604827a21d", "title": "Efficient Streaming Language Models with Attention Sinks"}, {"paperId": "83b90f4a0ae4cc214eb3cc140ccfef9cd99fac05", "title": "Efficient Memory Management for Large Language Model Serving with PagedAttention"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "4e3935ef7da6bcbb202ec7f8b285c313cadcd044", "title": "A Dataset of Information-Seeking Questions and Answers Anchored in Research Papers"}, {"paperId": "9dc624d7258d1a56117ca720aea953ce46b66b21", "title": "Efficient Attentions for Long Document Summarization"}, {"paperId": "f51497f463566581874c941353dd9d80069c5b77", "title": "Compressive Transformers for Long-Range Sequence Modelling"}, {"paperId": "22655979df781d222eaf812b0d325fa9adf11594", "title": "HotpotQA: A Dataset for Diverse, Explainable Multi-hop Question Answering"}, {"paperId": "d91043f0d48b9b2c8ff7ee321abb8fd7efafff7a", "title": "The NarrativeQA Reading Comprehension Challenge"}, {"paperId": "f010affab57b5fcf1cd6be23df79d8ec98c7289c", "title": "TriviaQA: A Large Scale Distantly Supervised Challenge Dataset for Reading Comprehension"}, {"paperId": null, "title": "Cascade inference: Memory bandwidth efficient shared pre-fix batch decoding"}, {"paperId": "8edcb4e7f69885fd979fd54299dbefa84498860a", "title": "Cache"}, {"paperId": null, "title": "Trans-formers are multi-state"}, {"paperId": null, "title": "H 2 o: Heavy-hitter oracle for efficient generative inference of large language models"}, {"paperId": null, "title": "Efficient context window extension of large language models"}, {"paperId": null, "title": "How long can open-source llms truly promise on context length?"}, {"paperId": null, "title": "Nvbench: Nvidia\u2019s benchmarking tool for gpus"}, {"paperId": null, "title": "Enhanced"}, {"paperId": null, "title": "New models and developer products announced at devday"}, {"paperId": null, "title": "Bandwidth-efficient"}, {"paperId": null, "title": "Introducing the next generation of Claude"}, {"paperId": null, "title": "Introducing gpt-4o: our fastest and most affordable flagship model"}, {"paperId": null, "title": "Nvidia ada lovelace professional gpu architecture"}]}