{"paperId": "f6440a16ccc5c13d2a86af91b76e078685abfd16", "title": "LongHeads: Multi-Head Attention is Secretly a Long Context Processor", "abstract": "Large language models (LLMs) have achieved impressive performance in numerous domains but often struggle to process lengthy inputs effectively and efficiently due to limited length generalization and attention's quadratic computational demands. Many sought to mitigate this by restricting the attention window within the pre-trained length. However, these methods introduce new issues such as ignoring the middle context and requiring additional training. To address these problems, we propose LongHeads, a training-free framework that enhances LLM's long context ability by unlocking multi-head attention's untapped potential. Instead of allowing each head to attend to the full sentence, which struggles with generalizing to longer sequences due to out-of-distribution (OOD) issues, we allow each head to process in-distribution length by selecting and attending to important context chunks. To this end, we propose a chunk selection strategy that relies on the inherent correlation between the query and the key representations, efficiently distributing context chunks to different heads. In this way, each head ensures it can effectively process attended tokens within the trained length, while different heads in different layers can collectively process longer contexts. LongHeads works efficiently in linear time, fits seamlessly with many LLMs that use relative positional encoding. LongHeads achieves 100% accuracy at the 128k length on passkey retrieval task, verifying LongHeads's efficacy in extending the usable context window for existing models. We release our code at https://github.com/LuLuLuyi/LongHeads .", "venue": "arXiv.org", "year": 2024, "citationCount": 2, "influentialCitationCount": 2, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "LongHeads is a training-free framework that enhances LLM's long context ability by unlocking multi-head attention's untapped potential, and achieves 100% accuracy at the 128k length on passkey retrieval task, verifying LongHeads's efficacy in extending the usable context window for existing models."}, "embedding": {"model": "specter_v2", "vector": [-0.3593815863132477, 0.14217859506607056, -0.7316521406173706, -0.3139950931072235, -0.6728442907333374, -0.16042593121528625, 0.5667040348052979, 0.15823721885681152, -0.7840927839279175, -0.16791945695877075, 0.7944367527961731, 0.13127198815345764, 0.37715238332748413, 0.2408623993396759, -0.16364823281764984, 0.15256142616271973, -1.2556395530700684, -0.0719880759716034, 0.06481316685676575, 0.009580329991877079, 0.07547327131032944, -0.8063268661499023, -0.8203780055046082, 0.5031149983406067, 0.15030845999717712, 0.2969639301300049, 0.31240466237068176, 0.9185479879379272, -0.3770296275615692, 0.3514951765537262, 0.10655086487531662, -0.46320879459381104, -0.04353034868836403, 0.086003877222538, -0.7010243535041809, -0.6399151086807251, 0.5573136806488037, -0.4588513970375061, -0.25514721870422363, 0.39480990171432495, 0.19921663403511047, 0.45252561569213867, -0.061897166073322296, -0.3537927567958832, -0.4278649389743805, 1.4639639854431152, 0.7480647563934326, 0.6385462284088135, -0.1507522165775299, -0.8108485341072083, 1.8035204410552979, -1.7340787649154663, 0.1386232078075409, 1.4955406188964844, 0.3486623466014862, 0.34441009163856506, -0.04110126942396164, -0.5194061994552612, 1.3184411525726318, 0.5011434555053711, -0.8167494535446167, -0.5713529586791992, -0.4326852560043335, 0.38952556252479553, 1.9216883182525635, -0.28016382455825806, 0.2579731047153473, 0.42709940671920776, 0.045172229409217834, 1.9686650037765503, -0.4102135896682739, -1.0053398609161377, -0.18107803165912628, -0.4546351134777069, 0.7003521919250488, 0.31425681710243225, -0.5268433690071106, 0.13989362120628357, -1.091822862625122, -0.08898796141147614, -0.018975120037794113, 0.0632803663611412, -0.024779554456472397, 0.2761589586734772, -0.45023980736732483, 0.6236181855201721, 0.6076886057853699, 0.6467642188072205, -0.23837201297283173, 0.5970466136932373, 0.3792297840118408, 0.1852579116821289, 0.19546039402484894, 0.3017258048057556, -0.34303128719329834, 0.2501838803291321, -1.1237380504608154, 0.6629942059516907, 0.05238862335681915, 0.942821741104126, -0.31815534830093384, -0.021083425730466843, -0.8534960150718689, 0.07318869233131409, 1.1394615173339844, 0.16788162291049957, 0.4149188697338104, -0.3178122639656067, 0.11926195025444031, -0.6140123009681702, -0.12554627656936646, -0.2512037754058838, -0.3486155569553375, -0.22729381918907166, -0.2862008213996887, -1.5221500396728516, -0.3492749333381653, 0.14006173610687256, -0.40893828868865967, 0.9557530879974365, -0.01854698546230793, 0.10452055931091309, 0.13510188460350037, 0.3982408940792084, 0.565865695476532, 0.808610200881958, 0.8423562049865723, 0.18584486842155457, 0.788053572177887, -1.0498031377792358, -0.4161393940448761, -1.0992387533187866, 1.0445102453231812, -0.4679306149482727, 0.5875054001808167, -0.22139964997768402, -1.1999399662017822, -0.8328620195388794, -0.7044504880905151, -0.10384853184223175, -0.8033431768417358, 0.3461814522743225, 0.8520083427429199, -0.04237739369273186, -0.9294304847717285, 0.9251798391342163, -0.03653566166758537, -0.1240871474146843, 0.15432727336883545, 0.36258190870285034, 0.03595082461833954, -0.7551872134208679, -1.507352590560913, -0.03715689852833748, 0.29662320017814636, -0.31828591227531433, -0.033040907233953476, -0.6566872596740723, -1.1937147378921509, -0.17275558412075043, 0.40967124700546265, -0.24577462673187256, 1.3914235830307007, -0.029035963118076324, -0.9211360216140747, 0.6624523401260376, -0.42706072330474854, 0.359394371509552, -0.10401242226362228, -0.8904955983161926, -0.39821869134902954, -0.5511736869812012, -0.05351094901561737, 0.39048853516578674, 0.7157819867134094, 0.3175288140773773, -0.5016393065452576, -0.14437299966812134, -0.35781970620155334, 0.13454684615135193, 0.0027453347574919462, 0.9769731760025024, -0.546474814414978, -0.18494202196598053, 0.45106935501098633, 0.6208280324935913, 0.4134552478790283, -0.6469206809997559, -0.3559176027774811, -1.4959222078323364, 0.7023283839225769, 0.12056560814380646, 1.326615333557129, -0.8949294686317444, -0.568888247013092, -0.42329877614974976, -0.4520120918750763, 0.08563116937875748, -0.857609748840332, 1.0046690702438354, -0.21026010811328888, 0.2233799546957016, 0.12202466279268265, -1.473982810974121, 0.1703309267759323, -0.22079895436763763, -0.5238290429115295, -0.04316926375031471, -0.031402092427015305, 1.1145275831222534, -0.9233554601669312, 0.01117870956659317, -0.4693480134010315, 0.2055026739835739, -1.147398591041565, 1.3580176830291748, -0.3826903998851776, -0.09938488155603409, -0.07401300221681595, 0.0068568335846066475, -0.08024369925260544, -0.09777919948101044, 0.16951407492160797, -0.13398495316505432, -0.18028859794139862, 0.587700366973877, -0.48453289270401, 1.5305142402648926, -0.21569299697875977, 0.14244888722896576, 0.021346667781472206, -0.3084411025047302, -0.4810998737812042, 0.31113681197166443, -0.5500012040138245, -0.38501647114753723, -0.0031383701134473085, 0.38337385654449463, -0.7081289291381836, 0.18172000348567963, 1.107951045036316, 1.1015909910202026, -0.4840630888938904, 0.05869681015610695, 0.536078691482544, 0.14341720938682556, 0.28280165791511536, 0.7234656810760498, 0.3739515244960785, 0.6014204621315002, 0.3332245647907257, -0.3626205027103424, 0.27851563692092896, -1.106413722038269, 0.14626722037792206, 0.5659043192863464, 0.6530455946922302, 0.7866194844245911, 0.3763120174407959, -0.6805297136306763, -0.329310804605484, 0.41022491455078125, 0.6312634348869324, 2.176706075668335, 0.026119789108633995, -0.4272099435329437, -0.7029162645339966, -0.3487471640110016, 0.024235563352704048, -0.22646062076091766, -0.5257866382598877, 0.004197551403194666, -0.7407267689704895, -0.6474069356918335, 0.5909162163734436, 0.5084547400474548, 0.6586108207702637, -0.9847533106803894, -0.11217927932739258, -0.13419921696186066, 0.4245394170284271, -0.8129574656486511, -0.9706205725669861, 0.23038749396800995, -0.3156731128692627, -0.2861998975276947, -0.0681687593460083, -0.17808417975902557, -0.07859627157449722, -0.623754620552063, 1.1979440450668335, -0.18708091974258423, -0.18990226089954376, 0.31990113854408264, -0.06737358123064041, -0.6415795087814331, -0.12501542270183563, 0.4988269805908203, 0.4426664710044861, -0.2900753915309906, 0.5560191869735718, 0.8039562702178955, -0.2800704836845398, -0.08140312880277634, -0.33770129084587097, 0.12214231491088867, 0.46586692333221436, 0.19036200642585754, 0.7758022546768188, -0.7011844515800476, 0.6235066652297974, -1.2750071287155151, 0.7768020033836365, 0.08184798061847687, -0.24900443851947784, 0.30470964312553406, -0.6501479148864746, -0.6415794491767883, 0.48693057894706726, -0.4157276451587677, 0.052187398076057434, -0.9707056879997253, 0.16291910409927368, -0.15983320772647858, -0.19398562610149384, 0.3414285480976105, -0.08397910743951797, 0.5322607755661011, -0.06343616545200348, 0.3821604549884796, 0.2250944972038269, -0.24390673637390137, 0.6651159524917603, -0.790818989276886, 0.5272884368896484, 0.017855752259492874, -0.362954705953598, -0.3566795289516449, -0.41436293721199036, -0.9109784960746765, -0.38241592049598694, -0.9308387637138367, -0.4974564015865326, 0.1728559285402298, 0.1681201457977295, -0.7567743062973022, -0.9224575161933899, 0.13540147244930267, -1.1856683492660522, -0.6457542777061462, 0.2119089663028717, 0.031041836366057396, 0.03417970985174179, -1.1811639070510864, -1.5796631574630737, -0.24500449001789093, -1.0557293891906738, -0.7394384145736694, 0.45895516872406006, 0.104772187769413, -0.634647786617279, -0.5189324021339417, -0.17946673929691315, -0.8198233246803284, 0.9970666766166687, -1.107182502746582, 0.7034137845039368, -0.12819959223270416, -0.2238166630268097, -0.7038124203681946, 0.21628160774707794, 0.43181487917900085, -0.3740975558757782, 0.10383135080337524, -1.0011987686157227, 0.07285647094249725, -0.7903745174407959, -0.3848506212234497, 0.2777208089828491, 0.570815920829773, 0.5709503889083862, -0.16771027445793152, -0.387579083442688, 0.3595079183578491, 1.0954397916793823, -0.6604666709899902, 0.0914982259273529, -0.1425028145313263, 1.000543236732483, 0.4201682507991791, -0.11418981850147247, 0.6256773471832275, 0.4234016239643097, -0.004995531868189573, 0.14167940616607666, 0.01611493155360222, -0.10563037544488907, -0.7101734280586243, 0.5607886910438538, 1.6722973585128784, 0.47676363587379456, 0.1278272569179535, -0.7843308448791504, 0.8470494151115417, -1.0807344913482666, -0.7275155186653137, 0.8094364404678345, 0.9249061346054077, 0.3460872173309326, -0.7701436877250671, -0.11546286195516586, -0.5221065878868103, 0.0039515928365290165, 0.44173938035964966, -0.21134082973003387, -0.5827183723449707, -0.004253443796187639, 0.3053915500640869, 0.020203549414873123, 0.8038321137428284, -0.6562012434005737, 1.085016131401062, 14.614583969116211, 0.5975507497787476, 0.046440210193395615, 0.3523184061050415, 0.3896445631980896, -0.010998637415468693, -0.25163817405700684, -0.018199428915977478, -1.836127519607544, -0.14460691809654236, 1.1634255647659302, 0.1493852287530899, 0.1908419281244278, 0.34168288111686707, 0.1379387378692627, -0.15988105535507202, -0.9715534448623657, 0.7101531028747559, 0.8127310872077942, -1.072313904762268, 0.36877143383026123, 0.02086234651505947, 0.12070155888795853, 0.5574386715888977, 0.6041999459266663, 1.0663270950317383, 0.26556357741355896, -0.3601480722427368, 0.7541987299919128, 0.05256960913538933, 0.6136099696159363, -0.18545232713222504, 0.31461459398269653, 0.5379956364631653, -0.7219273447990417, -0.48568835854530334, -0.6568074822425842, -1.0727074146270752, 0.1888233870267868, -0.08241252601146698, -0.3748268187046051, -0.5213747620582581, 0.012431568466126919, 0.829548180103302, -0.18589411675930023, 0.6123452186584473, -0.26937589049339294, 0.6623739004135132, -0.025585981085896492, -0.05447954311966896, 0.4124780297279358, 0.7518145442008972, 0.14864492416381836, 0.45860469341278076, -0.16041310131549835, 0.31250637769699097, 0.41476690769195557, 0.1631767600774765, -0.6230590343475342, 0.3155479431152344, -0.027145929634571075, 0.002549558412283659, 0.21715660393238068, 0.44889166951179504, 0.6945436596870422, 0.04063301533460617, -0.2843073308467865, 0.27366092801094055, 0.5277660489082336, 0.3506677746772766, 0.3385010063648224, -0.10537731647491455, 0.46708816289901733, -0.44157519936561584, -0.16386941075325012, 0.4576314687728882, -0.009050777181982994, -0.4674234986305237, -0.5347165465354919, -0.01714811846613884, 0.5464887619018555, -0.508023738861084, -0.5509588122367859, 0.7653689384460449, -0.007460786495357752, -0.26049312949180603, 0.11077802628278732, -0.5211394429206848, -0.5292345881462097, 0.7823386192321777, -1.4694744348526, -1.0158798694610596, 0.33279526233673096, -0.11583162099123001, 0.022566435858607292, 0.4433799088001251, 1.5340688228607178, 0.38657817244529724, -0.669716477394104, 0.26680800318717957, 0.024657875299453735, 0.03541495278477669, 0.20188608765602112, -0.7610255479812622, 0.7025129795074463, 0.5428687930107117, -0.4923343360424042, 0.5196452140808105, -0.2248036116361618, 0.07411902397871017, -1.031477928161621, 0.04117994010448456, 1.1177668571472168, -0.895750105381012, -0.7083302140235901, -0.631713330745697, -0.9619300365447998, 0.41584479808807373, 0.6913910508155823, 0.023837294429540634, 0.5990033745765686, 0.5636141896247864, -0.5721771121025085, -0.33467596769332886, -0.11060323566198349, -0.1872975081205368, 0.12988393008708954, -0.8614721298217773, -0.373369961977005, -0.31959429383277893, 0.6195821166038513, -0.9600651264190674, -0.16863472759723663, -0.5499393343925476, 0.1587018072605133, 0.06037138029932976, 0.7544337511062622, -0.617205023765564, 0.5732450485229492, 1.0870683193206787, -0.3092259466648102, -0.8802710771560669, 0.04962153360247612, -0.8721147775650024, -0.014971447177231312, 0.29127058386802673, 0.609279453754425, -0.1469695121049881, 0.21549859642982483, 0.9880741834640503, 0.034376971423625946, -0.7930829524993896, -0.4250636100769043, -0.26052290201187134, 0.3981950879096985, -0.6844245791435242, 0.4222813546657562, 0.19184090197086334, 0.26512590050697327, 0.0784858763217926, 0.5825007557868958, 0.6514682769775391, -0.03070131689310074, -0.6643016338348389, 0.4304223358631134, -0.0013544547837227583, -0.058710068464279175, -0.34629517793655396, -0.5879524350166321, -1.3260449171066284, 0.1618368923664093, -0.9648492932319641, -0.01399474497884512, -0.8215886354446411, -0.635010302066803, -0.39983677864074707, -0.13627539575099945, 0.11641537398099899, -0.1932547241449356, -0.7457830309867859, -0.25749698281288147, -0.5105894207954407, -0.8081300854682922, 0.6642947793006897, 0.584276020526886, -0.36662426590919495, -0.10741127282381058, 0.05765377730131149, 0.19423308968544006, 0.12990665435791016, 0.3362134099006653, -0.11046978086233139, -0.6392458081245422, -1.6535166501998901, 0.4607009291648865, -0.33193129301071167, -0.11957225948572159, -0.6411609649658203, 0.7636016607284546, 0.4730866551399231, -0.06760095059871674, -0.250675767660141, 0.3761829435825348, -0.4810173809528351, -1.0140395164489746, 0.023251663893461227, -0.9196836948394775, 0.40223121643066406, 0.16956357657909393, -0.6971244215965271, -0.46669483184814453, 0.868909478187561, -0.3501664400100708, -1.161118984222412, -1.2291024923324585, 0.5176942944526672, -0.27803418040275574, 0.10197442024946213, -0.4935002624988556, 0.2866809666156769, -1.1612399816513062, -0.2041321098804474, -0.09155146777629852, 0.5868117213249207, -0.3457806706428528, 0.8715497851371765, 0.6811841130256653, -0.8820996284484863, -0.11606885492801666, 0.6347877383232117, 0.10055208206176758, 0.5954893231391907, 0.9143885970115662, 0.41133829951286316, -0.3178631663322449, 0.5233080387115479, 0.7422142028808594, 0.29625874757766724, -1.0386619567871094, 0.13547383248806, 0.39442208409309387, -0.3100346326828003, -0.18761958181858063, 1.3941494226455688, -0.5134690403938293, -0.836016833782196, 0.4701875150203705, -1.4182707071304321, -0.47665685415267944, -0.06849155575037003, 1.425443410873413, -0.0018633482977747917, 0.17964188754558563, -0.2507764399051666, -0.5126182436943054, 0.14525899291038513, -0.3278724253177643, -0.21632084250450134, 0.5155147910118103, -0.27913475036621094, -0.4321017563343048, 0.527808666229248, 1.1772629022598267, -0.5803013443946838, -0.40996357798576355, -0.8906004428863525, -0.30114853382110596, 0.10111438482999802, 0.3045121133327484, -0.2987637221813202, -0.15046048164367676, 0.7204370498657227, 0.11320995539426804, 0.13679994642734528, -0.2394789755344391, 0.10393018275499344, 0.3505335748195648, 0.6591266393661499, -0.03416958078742027, -0.6854806542396545, -0.7323299646377563, 1.4484477043151855, 1.2054330110549927, -0.8422242403030396, 0.20857661962509155, 0.1683816760778427, -0.7006304264068604, 0.6728695631027222, 0.45095309615135193, 0.026412975043058395, 1.0166984796524048, -0.46718961000442505, 0.25208422541618347, 0.19805362820625305, -1.2131282091140747, -0.21410445868968964, 0.7614667415618896, 0.6927841901779175, 1.0028690099716187, 0.6347668170928955, 0.07093141973018646, 1.0343226194381714, 0.08822520077228546, -0.05318748205900192, 0.21282367408275604, 0.7032334804534912, -0.22757115960121155, -0.26550838351249695, -0.004572730511426926, 0.3771941363811493, -1.1321913003921509, -0.8443840146064758, 0.1797036975622177, 0.34193018078804016, -0.010790134780108929, 0.445637047290802, 0.8098902106285095, 0.24543817341327667, 0.7290446162223816, 0.5391596555709839, 0.20355455577373505, -0.7990942001342773, -0.35366398096084595, -0.26317110657691956, -0.7743479013442993, -0.5356020331382751, -0.01665535382926464, -0.2783729135990143, -0.4521344304084778, -0.2336660921573639, 0.27840590476989746, 0.05343479663133621, 0.3085727095603943, 1.0091716051101685, 0.6172266602516174, 0.17290695011615753, -0.3963909447193146, -0.8782206177711487, -0.5698838233947754, -0.782559871673584, -0.4124414622783661, -0.18802762031555176, 0.10067658126354218, 0.27224084734916687, -0.05890471488237381, -0.3191587030887604]}, "authors": [{"authorId": "2143773562", "name": "Yi Lu"}, {"authorId": "2148927523", "name": "Xin Zhou"}, {"authorId": "2241408708", "name": "Wei He"}, {"authorId": "2257315251", "name": "Jun Zhao"}, {"authorId": "2279023445", "name": "Tao Ji"}, {"authorId": "2067331064", "name": "Tao Gui"}, {"authorId": "2257376355", "name": "Qi Zhang"}, {"authorId": "2257129989", "name": "Xuanjing Huang"}], "references": [{"paperId": "a9468d8bfa6bd016dfd3128c4e8408e30eb8549b", "title": "LLM Maybe LongLM: Self-Extend LLM Context Window Without Tuning"}, {"paperId": "46f9f7b8f88f72e12cbdb21e3311f995eb6e65c5", "title": "Retrieval-Augmented Generation for Large Language Models: A Survey"}, {"paperId": "fdc53c2c10742464087c0525f77e32604827a21d", "title": "Efficient Streaming Language Models with Attention Sinks"}, {"paperId": "b31a5884a8ebe96b6300839b28608b97f8f8ef76", "title": "LongBench: A Bilingual, Multitask Benchmark for Long Context Understanding"}, {"paperId": "104b0bb1da562d53cbda87aec79ef6a2827d191a", "title": "Llama 2: Open Foundation and Fine-Tuned Chat Models"}, {"paperId": "f5afaccfe90268485a9961c5771ec5e71e9b806c", "title": "Extending Context Window of Large Language Models via Positional Interpolation"}, {"paperId": "60b35c6d68acced19b0c66edcfc0ee0a2c11efed", "title": "Landmark Attention: Random-Access Infinite Context Length for Transformers"}, {"paperId": "30c0cdc414f68211d5d0514df027cec22e005174", "title": "A Survey on In-context Learning"}, {"paperId": "f75d05e759447c2aedb7097728f29f9a520d9bc1", "title": "Do Long-Range Language Models Actually Use Long-Range Context?"}, {"paperId": "9ca329408813d209b1dcb36936f7f9cba82506bd", "title": "Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation"}, {"paperId": "f51497f463566581874c941353dd9d80069c5b77", "title": "Compressive Transformers for Long-Range Sequence Modelling"}, {"paperId": null, "title": ". Rectified rotary position embeddings"}, {"paperId": "d77d03fb7ae5572ad0d9e728ff05c73263852278", "title": "& Computer"}, {"paperId": null, "title": "2023. Lm-infinite: Simple on-the-fly length generalization for large language models"}, {"paperId": null, "title": "2023. Dynamically Scaled RoPE further increases performance of long context LLaMA with zero fine-tuning"}, {"paperId": null, "title": "2023. Tool learning with foundation models"}, {"paperId": null, "title": "retrieval task, the results are shown in"}, {"paperId": null, "title": "Bloc97. 2023b. NTK-Aware Scaled RoPE allows LLaMA models to have extended (8k+) context size without any fine-tuning and minimal perplexity degradation"}, {"paperId": null, "title": "2022. A length-extrapolatable transformer"}, {"paperId": null, "title": "Bloc97. 2023a. Add NTK-Aware interpolation \"by parts\" correction"}, {"paperId": null, "title": "2023. Things i \u00b4m learning while training superhot"}, {"paperId": null, "title": "2023b. Lon-glora: Efficient fine-tuning of long-context large language models"}]}