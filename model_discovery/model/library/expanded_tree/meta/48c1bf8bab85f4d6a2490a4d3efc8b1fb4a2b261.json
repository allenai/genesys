{"paperId": "48c1bf8bab85f4d6a2490a4d3efc8b1fb4a2b261", "abstract": "Training large-scale machine learning models poses distinct system challenges, given both the size and complexity of today's workloads. Recently, many organizations training state-of-the-art Generative AI models have reported cases of instability during training, often taking the form of loss spikes. Numeric deviation has emerged as a potential cause of this training instability, although quantifying this is especially challenging given the costly nature of training runs. In this work, we develop a principled approach to understanding the effects of numeric deviation, and construct proxies to put observations into context when downstream effects are difficult to quantify. As a case study, we apply this framework to analyze the widely-adopted Flash Attention optimization. We find that Flash Attention sees roughly an order of magnitude more numeric deviation as compared to Baseline Attention at BF16 when measured during an isolated forward pass. We then use a data-driven analysis based on the Wasserstein Distance to provide upper bounds on how this numeric deviation impacts model weights during training, finding that the numerical deviation present in Flash Attention is 2-5 times less significant than low-precision training.", "venue": "arXiv.org", "year": 2024, "citationCount": 2, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "A principled approach to understanding the effects of numeric deviation is developed, and proxies are constructed to put observations into context when downstream effects are difficult to quantify, to analyze the widely-adopted Flash Attention optimization."}, "embedding": {"model": "specter_v2", "vector": [0.1923530101776123, 0.6225834488868713, -0.1924125999212265, -0.27729660272598267, -0.4169932007789612, -0.1097462922334671, 0.6354302763938904, -0.3331042528152466, -0.28119802474975586, -0.31136295199394226, 0.13511279225349426, 0.12565316259860992, 0.22060078382492065, 0.2285987138748169, -0.5842840075492859, 0.03445001319050789, -0.8120384812355042, 0.6630730032920837, -0.1940956562757492, -0.3460178077220917, -0.3034151494503021, -0.3156946301460266, -1.529737949371338, -0.05720127001404762, 0.4945809841156006, 1.003134846687317, -0.19746439158916473, 1.2507696151733398, -0.12482503801584244, 0.4556337594985962, 0.3173893690109253, -0.29267144203186035, 0.5841577053070068, 0.012934348545968533, -0.6828569173812866, -0.05475471541285515, 0.6534921526908875, -0.2149350792169571, -0.8335081934928894, 0.49175503849983215, -0.11538172513246536, 0.5232332348823547, 0.43548616766929626, -0.746738851070404, -0.3761877119541168, 0.4574047923088074, 0.5171789526939392, 0.9690672755241394, -0.4061550199985504, 0.07007335871458054, 1.3067076206207275, -1.096547245979309, 0.1923138052225113, 1.5425084829330444, 0.45701780915260315, 0.2486819326877594, -0.464153915643692, -0.5301098823547363, 0.8423635363578796, -0.26619473099708557, -0.6795725226402283, -0.289375364780426, -0.17536795139312744, -0.07135948538780212, 1.6091747283935547, -0.22949469089508057, 0.18756383657455444, 0.5906985998153687, 0.26182010769844055, 1.706275224685669, -0.26012328267097473, -0.887943685054779, 0.06806758791208267, -0.02177254669368267, 0.5181966423988342, 0.7161874175071716, -0.32910457253456116, 0.30085381865501404, -1.0518399477005005, 0.02208942174911499, 0.16618289053440094, -0.12916746735572815, 0.3447971045970917, -0.06536506861448288, 0.28959760069847107, 0.544475793838501, 0.723665714263916, 0.7088808417320251, -0.5323963761329651, 1.2690852880477905, 0.15012529492378235, 0.4574345350265503, 0.16956362128257751, 0.2737917900085449, 0.26795393228530884, 0.02509080059826374, -0.8334493041038513, 0.2636615037918091, -0.24260427057743073, 1.1753557920455933, 0.04506240040063858, 0.36116233468055725, -1.1362367868423462, -0.1119469404220581, 1.3586305379867554, 0.07089772820472717, 0.41705188155174255, -0.759166955947876, 0.38103312253952026, -0.4782240390777588, 0.06684502214193344, -0.860304057598114, 0.019895950332283974, -0.5413147807121277, -0.7528389692306519, -0.9180976748466492, -0.5528171062469482, 0.08535519987344742, -0.9271551370620728, 0.4831886291503906, -0.44045290350914, -0.03442366048693657, -0.22454054653644562, 0.8223838210105896, 0.43880605697631836, 0.6875746846199036, 0.36362820863723755, 0.44256219267845154, 0.017640409991145134, -0.8016831278800964, -0.3821467459201813, -1.6005765199661255, 0.6947499513626099, 0.01597665064036846, 0.4432336986064911, -0.16919931769371033, -1.679978370666504, -0.9055148363113403, -1.1496530771255493, 0.03856257349252701, -0.15114809572696686, 0.1108262836933136, 1.350050449371338, 0.22862911224365234, -0.9936054348945618, 1.0454517602920532, -0.5882997512817383, 0.06288811564445496, 0.8240251541137695, 0.44312340021133423, 0.4873555302619934, -0.8142343759536743, -0.9208172559738159, 0.16652600467205048, 0.20673459768295288, -0.33388492465019226, -0.2056961953639984, -0.47549909353256226, -0.858157217502594, 0.2512678802013397, 0.48301801085472107, -0.38935625553131104, 1.4583263397216797, -0.6621102690696716, -0.8263236284255981, 0.2868278920650482, -0.1703367978334427, 0.3950994312763214, 0.5449473261833191, 0.005209504161030054, -0.2972160875797272, -0.662603497505188, -0.7170679569244385, 0.8884705305099487, 0.45135927200317383, -0.23331832885742188, 0.19835837185382843, 0.1602100133895874, -0.3021802306175232, -0.2685086131095886, -0.4154469072818756, 0.33506906032562256, -0.44011539220809937, 0.2611459791660309, 0.24211061000823975, 0.3587993085384369, 0.038556501269340515, -0.2904154062271118, -0.06695006042718887, -1.4023795127868652, 0.5056896805763245, 0.2976217269897461, 1.1256283521652222, -0.9029998779296875, -0.8200210332870483, 0.10702410340309143, -0.13531960546970367, -0.16432227194309235, -0.7179341316223145, 0.42922091484069824, -0.20972900092601776, 0.5013967752456665, -0.1538291573524475, -1.0532350540161133, 0.37387606501579285, -0.13513852655887604, -0.4059562385082245, -0.12701547145843506, 0.49397578835487366, 1.3265161514282227, -0.7748150825500488, 0.07763895392417908, -0.34730613231658936, 0.11266268044710159, -1.1611665487289429, 1.350871205329895, -0.6154955625534058, -0.10767065733671188, -0.17105188965797424, -0.22488321363925934, 0.21829941868782043, -0.8146524429321289, 0.4634484350681305, -0.4612848460674286, 0.21991486847400665, 0.3025912046432495, -0.28500592708587646, 1.465298056602478, -0.16178472340106964, 0.5805986523628235, -0.5470547080039978, -0.6155164241790771, 0.25358346104621887, 0.01231238804757595, -0.32825377583503723, -0.6769601702690125, 0.5348025560379028, 0.29935890436172485, -0.3413059711456299, 0.4996245801448822, 0.9550447463989258, 0.8497607111930847, -0.29392489790916443, 0.38574057817459106, 0.8848994970321655, -0.29333949089050293, 0.47266632318496704, 0.6031804084777832, 0.9262962937355042, 0.500500500202179, -0.07116580754518509, -0.3046298623085022, -0.22690239548683167, -0.7597581148147583, -0.31198376417160034, 0.7846061587333679, 0.5391995906829834, 0.9240483641624451, 0.42005351185798645, -1.1580575704574585, -0.5254412889480591, 0.20105165243148804, 0.7032442092895508, 1.5047682523727417, -0.16669580340385437, -0.2412867248058319, -0.7685897946357727, -0.3954939842224121, -0.0745411068201065, 0.2999173700809479, -0.687164306640625, -0.6451799273490906, -0.48145395517349243, -1.1512717008590698, 0.31664150953292847, 0.44494307041168213, 0.7489141225814819, -0.8525009751319885, -0.5575976967811584, -0.45933017134666443, 0.5840944051742554, -0.28974655270576477, -0.5560181736946106, 0.6414232850074768, -0.2908293306827545, 0.356704443693161, 0.11379290372133255, 0.40234777331352234, 0.07244119048118591, -0.48603498935699463, 1.2239954471588135, 0.05125855654478073, -0.31082382798194885, 0.33875006437301636, 0.9122974276542664, -0.6173731684684753, -0.4941866099834442, 0.4696556031703949, -0.01602809876203537, -0.18922829627990723, 0.14046049118041992, 0.6810487508773804, -0.16631363332271576, 0.28063493967056274, -0.5108537673950195, -0.017386553809046745, 0.35871532559394836, -0.05180433392524719, 0.6506737470626831, -0.5742189288139343, 0.03458462655544281, -0.8734768629074097, 0.8199660181999207, -0.18794861435890198, -0.3845016062259674, 0.5994309782981873, -1.0519589185714722, 0.024841399863362312, 0.30505818128585815, -0.5674225687980652, -0.25769904255867004, -1.052554965019226, 0.5195270776748657, -0.6126111149787903, -0.13780538737773895, 0.0637194812297821, 0.5983954071998596, 0.03493766486644745, 0.7121281027793884, 0.1819090098142624, 0.2704182267189026, 0.1725931316614151, 0.3823325037956238, -0.8494738936424255, 0.4109504520893097, 0.03446105867624283, -0.14084413647651672, -0.5600864291191101, 0.02690286934375763, -0.42793139815330505, -0.6443329453468323, 0.0425221212208271, -0.05943785607814789, -0.6919984221458435, -0.11558956652879715, -0.2621332108974457, -1.0421442985534668, -0.2393815815448761, -0.7671836018562317, -0.6692892909049988, -0.046662528067827225, -0.4893626868724823, -0.22723951935768127, -1.53755784034729, -1.0423768758773804, -0.5681777000427246, -0.4954482913017273, -1.232312798500061, 0.41075941920280457, 0.3749305307865143, -0.5909205079078674, -0.5564992427825928, -0.028693705797195435, -0.5098376870155334, 1.141670823097229, -0.49294471740722656, 0.564306914806366, 0.23314213752746582, -0.38203954696655273, -0.28580403327941895, 0.33129844069480896, 0.12270615249872208, -0.6066523790359497, 0.6688900589942932, -1.1950628757476807, -0.04273482784628868, -0.6536681056022644, -0.9507131576538086, 0.07021325081586838, 0.28007614612579346, 0.7302691340446472, -0.06125844269990921, -0.4459518790245056, 0.2739197015762329, 1.0874918699264526, -0.7165391445159912, 0.06937798112630844, 0.245977520942688, 1.020337700843811, 0.07968569546937943, -0.11817799508571625, 0.5199602842330933, -0.13191136717796326, 0.3838379681110382, 0.27257803082466125, 0.2196625918149948, -0.042856212705373764, -0.7275351881980896, 0.39214950799942017, 1.2234385013580322, 0.43034055829048157, -0.4535236358642578, -1.2152043581008911, 0.12866568565368652, -1.3212525844573975, -0.49616965651512146, 0.7907359600067139, 0.7616897225379944, 0.15579496324062347, -0.2539089024066925, -0.11435521394014359, -0.27972978353500366, 0.1680799275636673, 0.2938050925731659, -0.7162013053894043, -0.6327187418937683, 0.17105215787887573, 0.4680189788341522, 0.15177392959594727, 0.47616031765937805, 0.08776938170194626, 0.5329834818840027, 14.970036506652832, 1.0210585594177246, -0.15924875438213348, 0.4711368680000305, 1.2460969686508179, -0.10473201423883438, -0.6095378398895264, -0.6539745926856995, -1.053044319152832, -0.04597391560673714, 1.5895090103149414, 0.27115628123283386, 0.790837824344635, 0.22439852356910706, -0.5501366853713989, 0.1525810807943344, -0.6022663116455078, 0.7081021070480347, 0.39131981134414673, -1.2938071489334106, 0.18159671127796173, 0.09488251060247421, 0.5062463879585266, 0.6934030652046204, 1.0530961751937866, 0.9363901615142822, 0.6990184783935547, -0.7216203808784485, 0.8531225919723511, 0.6644947528839111, 0.9260680675506592, -0.5304906368255615, 0.31775861978530884, 0.36768630146980286, -0.5074998140335083, -0.05257769301533699, -0.4016892910003662, -0.9734731316566467, -0.019849196076393127, -0.2569776177406311, -0.3789733052253723, -0.5258278250694275, -0.04537736251950264, 0.40666431188583374, -0.3075083792209625, 0.20345808565616608, 0.20025186240673065, 0.711179792881012, -0.07979792356491089, 0.10522247850894928, 0.6000807285308838, 0.6141175627708435, -0.29544511437416077, -0.1797172725200653, -0.056258466094732285, -0.118316151201725, 0.14651711285114288, 0.6262896060943604, -0.6688261032104492, -0.2755759656429291, -0.3164549469947815, -0.38071224093437195, -0.22248604893684387, 0.6996618509292603, 0.3185541033744812, 0.4533466398715973, -0.0503060407936573, 0.07186701148748398, 1.0017204284667969, 0.08877053111791611, -0.08363604545593262, 0.36573517322540283, -0.05235988646745682, -0.6101201772689819, -0.19314584136009216, 0.6772664189338684, -0.2743186950683594, -0.18665826320648193, -0.6886875629425049, -0.533490777015686, 0.22829975187778473, -0.8959066271781921, -0.7877713441848755, 1.0054211616516113, -0.3151719570159912, 0.1092124730348587, -0.031566694378852844, -0.4887283444404602, -0.2065168172121048, 0.3952370285987854, -0.9070267081260681, -0.4701845645904541, -0.055184006690979004, -0.6242473721504211, -0.5060355067253113, -0.062434229999780655, 0.961971640586853, 0.18039727210998535, -0.6024197936058044, 0.6058761477470398, 0.07062449306249619, -0.4083048701286316, -0.22266080975532532, -0.8485820889472961, 1.079142451286316, 0.14426803588867188, -0.03157598897814751, 0.14224396646022797, 0.0840897411108017, 0.15758349001407623, -0.9027224183082581, -0.038708608597517014, 0.44086191058158875, -1.0427125692367554, -0.6806524395942688, -0.5780337452888489, -1.0238202810287476, 0.46928754448890686, 0.46459484100341797, 0.03050464577972889, 0.05398380011320114, 0.4204379618167877, -0.2852455675601959, -0.34130653738975525, -0.782100260257721, -0.014559702947735786, 0.5745283961296082, -0.4182111918926239, 0.03758089616894722, 0.021075960248708725, 0.2877150774002075, -1.2044390439987183, -0.4415779113769531, -0.4795125126838684, 0.3154516816139221, -0.33292633295059204, 0.784909188747406, -0.5504195094108582, 0.7402575612068176, 1.1472620964050293, -0.07979562133550644, -0.7415597438812256, -0.4612182080745697, -0.799072265625, 0.11001009494066238, 0.3576238751411438, 0.5040950179100037, -0.1898895800113678, 0.6348348259925842, 1.3574906587600708, 0.14766643941402435, -0.40639227628707886, -0.428093820810318, -0.27299830317497253, 0.1295100897550583, -0.46713876724243164, 0.4984362721443176, -0.26511964201927185, -0.3992847204208374, -0.06887520849704742, 0.1738104522228241, 0.15908107161521912, -0.377373069524765, -0.6855153441429138, 0.3103451728820801, -0.2673012912273407, -0.3009290397167206, -0.4476507604122162, -0.36370211839675903, -1.2940089702606201, -0.13691575825214386, -1.127346396446228, 0.2697952687740326, -0.6398422718048096, -0.6672692894935608, -0.29972314834594727, -0.2767743468284607, -0.08880289644002914, 0.5386472940444946, -0.2605598270893097, -0.16486428678035736, -0.37146875262260437, -0.7681863307952881, 0.9496721625328064, 0.8301584720611572, -0.7268213033676147, 0.15718352794647217, -0.15644198656082153, -0.027474738657474518, -0.03738405182957649, 0.36872923374176025, -0.7433478236198425, -0.6619527339935303, -1.2082916498184204, 0.4965416491031647, -0.10281594097614288, -0.3260035514831543, -1.0487892627716064, 0.7131711840629578, 0.16066670417785645, 0.1523095965385437, 0.18559445440769196, 0.25788262486457825, -1.097224235534668, -0.15242622792720795, 0.24931219220161438, -0.9709218144416809, 0.5759871602058411, 0.4673735201358795, -0.5382454991340637, 0.11808184534311295, 0.3902343511581421, 0.18144087493419647, -0.6328476667404175, -0.2840462625026703, 0.5647672414779663, -0.46150973439216614, 0.389201819896698, -0.3590279221534729, -0.004833305720239878, -1.1827689409255981, -0.3675072193145752, 0.06281209737062454, 0.3627443313598633, -0.1681215912103653, 0.7094230651855469, 0.11642686277627945, -1.3197869062423706, 0.2428319752216339, 0.3820178210735321, -0.120756596326828, 0.3427616059780121, 0.6172335147857666, 0.39456263184547424, -0.46067455410957336, 0.33173269033432007, -0.011794556863605976, 0.07159740477800369, -0.4417973756790161, -0.0506628192961216, 0.8025936484336853, -0.41970038414001465, -0.011836736463010311, 1.0512824058532715, -0.3584771156311035, -0.960774838924408, 0.3021678924560547, -0.939091145992279, -0.16356198489665985, -0.3932032287120819, 0.3746236264705658, 0.2932701110839844, 0.07306855916976929, 0.1360694169998169, -0.47182220220565796, -0.03308532387018204, -0.2362164556980133, -0.49081090092658997, 0.39565935730934143, -0.09414398670196533, 0.2990511953830719, 0.6875245571136475, 0.6943973302841187, -1.062388300895691, -1.2510483264923096, -0.5869761109352112, -0.22816219925880432, -0.4374963343143463, 0.5053995251655579, -0.5949499607086182, -0.8938833475112915, 1.0112411975860596, 0.5814303755760193, 0.32654017210006714, 0.0034495783038437366, -0.02413325197994709, -0.28427815437316895, 0.7294129133224487, 0.05486756190657616, -0.5080457925796509, -0.19301709532737732, 1.0313376188278198, 1.328505039215088, -0.8305761814117432, 0.24988128244876862, 0.14607369899749756, -0.8143062591552734, 0.7761908173561096, 0.8892380595207214, -0.03881235420703888, 0.39834344387054443, -0.3435027301311493, -0.1040288433432579, -0.14107142388820648, -1.1621888875961304, 0.2767591178417206, 1.169834852218628, 0.6146708726882935, 0.6890660524368286, 0.10244833678007126, 0.5292208194732666, 0.6172884106636047, 0.16201040148735046, 0.25422000885009766, 0.3155001997947693, 0.466285765171051, -0.2850525975227356, 0.33567455410957336, 0.3597372770309448, 0.7594215869903564, -0.4578789472579956, -0.30291682481765747, 0.02763657085597515, 0.5862467288970947, 0.1327841579914093, 0.47642332315444946, 0.9347599148750305, -0.02827216312289238, 0.5590604543685913, 0.28321903944015503, 0.7739744186401367, -0.1637742817401886, -0.6706254482269287, -0.36225318908691406, -0.9083077907562256, -0.10852684080600739, 0.11047681421041489, -0.6075609922409058, -0.22624722123146057, -0.6088003516197205, 0.35186219215393066, 0.07245617359876633, -0.15446531772613525, 1.0120017528533936, 0.6722321510314941, 0.7106565237045288, -0.33148589730262756, -0.8830194473266602, -0.4013385772705078, -0.769314706325531, 0.2330033779144287, -0.5036774277687073, -0.35528451204299927, -0.40806663036346436, -0.2692742943763733, -0.5946998000144958]}, "authors": [{"authorId": "2253623020", "name": "Alicia Golden"}, {"authorId": "1481699378", "name": "Samuel Hsia"}, {"authorId": "2276374742", "name": "Fei Sun"}, {"authorId": "2064056189", "name": "Bilge Acun"}, {"authorId": "2276204019", "name": "Basil Hosmer"}, {"authorId": "2276407491", "name": "Yejin Lee"}, {"authorId": "2253681376", "name": "Zachary DeVito"}, {"authorId": "2276320939", "name": "Jeff Johnson"}, {"authorId": "2266733171", "name": "Gu-Yeon Wei"}, {"authorId": "2300100031", "name": "David Brooks"}, {"authorId": "2253786890", "name": "Carole-Jean Wu"}], "references": [{"paperId": "104b0bb1da562d53cbda87aec79ef6a2827d191a", "title": "Llama 2: Open Foundation and Fine-Tuned Chat Models"}, {"paperId": "88c94b11bd18161d027a28dd758b58698063e029", "title": "A Theory on Adam Instability in Large-Scale Machine Learning"}, {"paperId": "0c9479b118159864774b0c2da089fb63387bb53c", "title": "Accuracy Booster: Enabling 4-bit Fixed-point Arithmetic for DNN Training"}, {"paperId": "540396c31b775039b144e3b6249cb92151e97262", "title": "Improving Deep Neural Network Random Initialization Through Neuronal Rewiring"}, {"paperId": "6ec47bb38331f7a63d40845a6d2d1dd94fafe676", "title": "A PDE-based Explanation of Extreme Numerical Sensitivities and Edge of Stability in Training Neural Networks"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "094ff971d6a8b8ff870946c9b3ce5aa173617bfb", "title": "PaLM: Scaling Language Modeling with Pathways"}, {"paperId": "83474f6510e0b985595f936d233321e131966bae", "title": "A Loss Curvature Perspective on Training Instability in Deep Learning"}, {"paperId": "8d908042f139575d6688c745e94156c9df6eae07", "title": "Understanding the Difficulty of Training Transformers"}, {"paperId": "3a0d81ff7917b16156e11fe812182af82edeaa85", "title": "Statistical Aspects of Wasserstein Distances"}, {"paperId": "204e3073870fae3d05bcbc2f6a8e263d9b72e776", "title": "Attention is All you Need"}]}