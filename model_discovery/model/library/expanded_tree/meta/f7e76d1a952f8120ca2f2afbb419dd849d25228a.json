{"paperId": "f7e76d1a952f8120ca2f2afbb419dd849d25228a", "abstract": "Auto-regressive inference of transformers benefit greatly from Key-Value (KV) caching, but can lead to major memory bottlenecks as model size, batch size, and sequence length grow at scale. We introduce Multi-Layer Key-Value (MLKV) sharing, a novel approach extending KV sharing across transformer layers to reduce memory usage beyond what was possible with Multi-Query Attention (MQA) and Grouped-Query Attention (GQA). Evaluations on various NLP benchmarks and inference metrics using uptrained Pythia-160M variants demonstrate that MLKV significantly reduces memory usage with minimal performance loss, reducing KV cache size down to a factor of 6x compared to MQA. These results highlight MLKV's potential for efficient deployment of transformer models at scale. We provide code at https://github.com/zaydzuhri/pythia-mlkv", "venue": "arXiv.org", "year": 2024, "citationCount": 0, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "Evaluations on various NLP benchmarks and inference metrics using uptrained Pythia-160M variants demonstrate that MLKV significantly reduces memory usage with minimal performance loss, reducing KV cache size down to a factor of 6x compared to MQA."}, "embedding": {"model": "specter_v2", "vector": [0.43162864446640015, 0.6868358850479126, -0.5264794826507568, 0.20152544975280762, -0.578257143497467, -0.40521177649497986, 0.644288957118988, 0.2907446622848511, -0.510463535785675, -0.009071976877748966, 0.3979737162590027, -0.4781368374824524, 0.3101648986339569, 0.2898770868778229, -0.06783682107925415, 0.16814689338207245, -0.6696853637695312, 0.4694611430168152, 0.07966811209917068, -0.14088575541973114, -0.23037347197532654, -0.801388144493103, -0.7508043050765991, 0.19071893393993378, 0.3896443843841553, 0.8149299621582031, 0.21942070126533508, 0.8813613653182983, -0.6155732870101929, 0.44194066524505615, 0.40444034337997437, -0.6469294428825378, -0.036224912852048874, -0.03954998403787613, -0.14749309420585632, -0.40201619267463684, 0.21325884759426117, -0.30029162764549255, -0.2715200185775757, 0.9940546154975891, -0.09831114858388901, -0.08190225064754486, 0.5480806827545166, -1.117331862449646, -0.6829079389572144, 1.2365490198135376, 0.799775242805481, 0.6827660202980042, -0.3966207802295685, -0.67710942029953, 1.7153818607330322, -1.5095510482788086, 0.20561502873897552, 1.2441664934158325, 0.8400442600250244, 0.34008529782295227, -0.30994269251823425, -0.7792916893959045, 0.5952303409576416, 0.6090593934059143, -0.8091353178024292, -0.38380154967308044, -0.480199933052063, 0.2864958345890045, 2.2925608158111572, -0.3533415198326111, 0.3019191026687622, 0.24185581505298615, -0.02061685174703598, 1.515199065208435, -0.22913698852062225, -0.5045526623725891, -0.3305490016937256, 0.22218430042266846, 0.02411566488444805, 0.7394658923149109, -0.42554810643196106, -0.1674993932247162, -0.7728280425071716, -0.6404544115066528, 0.1513109803199768, -0.0790516659617424, -0.1647709161043167, -0.21352411806583405, -0.31554871797561646, 0.7434093952178955, 0.19241845607757568, 0.5478890538215637, -0.307521790266037, 0.3483074903488159, 0.5251250267028809, 0.44045957922935486, 0.09679478406906128, 0.5910214185714722, -0.6266345381736755, 0.3389004170894623, -1.2289444208145142, 0.4122394621372223, 0.2937563955783844, 0.7333149313926697, -0.3996813893318176, 0.1962980329990387, -0.9819572567939758, 0.04987308382987976, 1.3978999853134155, 0.4055757522583008, 0.35267096757888794, -0.6654573082923889, 0.16182781755924225, -0.5967280864715576, 0.102328360080719, -0.3933943212032318, -0.1034456267952919, 0.045256782323122025, -0.5432501435279846, -1.5334680080413818, -0.45975369215011597, 0.35714221000671387, -0.7196770310401917, 0.8239316344261169, -0.2849672734737396, 0.3038313388824463, 0.3821430504322052, 0.23224173486232758, 0.8562671542167664, 0.6513716578483582, 0.4712756872177124, -0.22752904891967773, 1.221365213394165, -0.512335479259491, -0.8481146097183228, -1.0096474885940552, 0.7057324647903442, -0.06861017644405365, -0.0199787188321352, -0.16947229206562042, -1.3496278524398804, -0.4321126937866211, -0.5967884659767151, -0.21879243850708008, -0.3219229280948639, 0.17030876874923706, 0.7943741083145142, 0.22853288054466248, -1.005466341972351, 0.6735991835594177, 0.06590063869953156, -0.05495244264602661, 0.3884834945201874, 0.2822786867618561, 0.1323455572128296, -0.31444844603538513, -1.7103668451309204, 0.5568017959594727, 0.3674963712692261, -0.3591528534889221, -0.34633880853652954, -1.1464561223983765, -1.2406902313232422, 0.15433600544929504, 0.5638080835342407, -0.3101716935634613, 1.4737333059310913, 0.31938040256500244, -1.2500990629196167, 0.636052668094635, -0.5358830690383911, 0.03866702690720558, 0.15492349863052368, -0.10003451257944107, -0.47396790981292725, -0.46536365151405334, -0.0691528171300888, 0.32095780968666077, 0.6424952745437622, 0.21162989735603333, -0.30926433205604553, 0.1510949730873108, -0.4868786334991455, -0.013255594298243523, -0.10581376403570175, 1.024206280708313, -0.5494282245635986, 0.021449575200676918, 0.282011479139328, 0.8278075456619263, -0.0014103723224252462, 0.06408599764108658, -0.5988048911094666, -1.2427910566329956, 0.5667394399642944, -0.4689215421676636, 1.02041757106781, -0.6667267084121704, -0.3761304020881653, -0.16276155412197113, 0.3026944100856781, 0.2247457057237625, -0.5326581001281738, 0.6730671525001526, -0.34809279441833496, 0.3271065652370453, -0.36863619089126587, -1.052520751953125, 0.18072578310966492, -0.11917389184236526, -0.7366457581520081, -0.2688627243041992, 0.1324426531791687, 1.3279731273651123, -0.9180630445480347, -0.22833310067653656, 0.09287145733833313, 0.5580002665519714, -0.8201684355735779, 1.0437803268432617, -0.7012243866920471, 0.029175978153944016, -0.17219272255897522, -0.16353166103363037, -0.08854445070028305, -0.46297353506088257, 0.8673403263092041, -0.7223182916641235, 0.01725492998957634, 0.5749956369400024, -0.38363516330718994, 1.1117815971374512, -0.29198983311653137, 0.3314099609851837, 0.015928806737065315, -0.4783564507961273, 0.04264509305357933, 0.561031699180603, -0.15570025146007538, -0.6811835169792175, 0.15891437232494354, 0.43764033913612366, -0.5711502432823181, 0.3879801332950592, 0.7984123229980469, 0.8764406442642212, -0.2518804669380188, 0.1735730916261673, 0.7279067039489746, -0.05960686132311821, 0.2918526828289032, 0.6065294146537781, 0.8105167150497437, 0.20957010984420776, 0.8897866606712341, -0.07846807688474655, 0.442128986120224, -0.6998999714851379, 0.0662185400724411, 0.5303741693496704, 0.7889849543571472, 0.2968337833881378, 0.8151307702064514, -0.41575440764427185, -0.6928812861442566, 0.2123962789773941, 0.4870067238807678, 1.4340753555297852, -0.41117140650749207, -0.3468729853630066, -0.5719690918922424, -0.09506791830062866, -0.05495535954833031, 0.2611736059188843, -0.3423561155796051, -0.05324786156415939, -0.40377965569496155, -0.9586325287818909, 1.1105835437774658, 0.2702239453792572, 0.6975235939025879, -0.9022960662841797, -0.02897455543279648, -0.11240414530038834, 0.08625593036413193, -1.007825493812561, -0.1533883959054947, 0.6192135214805603, -0.29065608978271484, -0.2982349097728729, 0.18427197635173798, 0.18146052956581116, 0.010288751684129238, -1.0666416883468628, 1.1986392736434937, -0.5456976294517517, -0.2811942994594574, 0.2637392580509186, 0.6760659217834473, -0.5138567090034485, -0.888039767742157, 0.1303187608718872, 0.04383302852511406, -0.3636792004108429, 0.5283116102218628, 0.5672294497489929, 0.05486062169075012, -0.20878617465496063, -0.2404332309961319, 0.039542827755212784, 0.1532464325428009, -0.016059618443250656, 0.7369158864021301, -0.40743783116340637, -0.12305918335914612, -1.2772259712219238, 0.8194840550422668, -0.11417504400014877, -0.8876758813858032, 0.5962842106819153, -1.0138062238693237, -0.24779526889324188, 0.6788553595542908, -0.5838662981987, -0.11091750860214233, -1.0394419431686401, 0.1075073704123497, -0.4270830750465393, 0.04759017005562782, 0.15853072702884674, 0.02767607942223549, 0.5352506041526794, -0.10808730870485306, 0.7455735206604004, 0.36338010430336, -0.16326211392879486, 1.0703333616256714, -0.829477071762085, 0.5729514956474304, 0.4345559775829315, 0.05630255863070488, -0.5194958448410034, -0.027773404493927956, -0.6306586861610413, -0.37184938788414, -0.33851519227027893, 0.018508128821849823, 0.12320085614919662, 0.41396182775497437, -0.7307551503181458, -1.1496204137802124, -0.11890409886837006, -0.9411233067512512, -0.32094869017601013, 0.32413843274116516, -0.3184409737586975, 0.15904898941516876, -1.0974609851837158, -1.5520058870315552, -0.6722646951675415, -0.9470520615577698, -1.0054099559783936, 0.471644788980484, -0.23452940583229065, -0.27642810344696045, -0.729216456413269, -0.0592929869890213, -0.5341339707374573, 0.8610231876373291, -1.0766918659210205, 1.04720938205719, -0.3522579073905945, -0.21571004390716553, 0.020130518823862076, -0.04973163083195686, 0.5585370659828186, -0.5300264358520508, -0.08725506067276001, -0.668279230594635, 0.4266957938671112, -0.6117059588432312, -0.5250022411346436, 0.1550046056509018, 0.48396924138069153, 0.6129226684570312, -0.053938571363687515, -0.6039438247680664, 0.4178057014942169, 1.44558846950531, -1.0262327194213867, 0.05413791909813881, 0.14710521697998047, 1.0090415477752686, -0.22812041640281677, -0.2410857379436493, 0.6032824516296387, 0.4214225113391876, 0.43891945481300354, 0.3754945695400238, 0.2693079113960266, 0.39151623845100403, -0.5394507050514221, 0.5446245074272156, 1.2263543605804443, 0.44204697012901306, -0.2773837149143219, -0.8932554721832275, 0.556803286075592, -1.3033217191696167, -0.6668116450309753, 0.3565666377544403, 0.5989396572113037, 0.7069565057754517, -0.6150335669517517, -0.39765772223472595, -0.14817595481872559, 0.24391452968120575, 0.22991469502449036, -0.6095872521400452, -0.6136247515678406, 0.03823474049568176, 0.652176558971405, 0.7430914044380188, 0.5289366245269775, -0.12474315613508224, 0.8122147917747498, 14.740036010742188, 0.8011448383331299, 0.172657772898674, 0.7377309203147888, 0.22241990268230438, 0.25745314359664917, -0.686998188495636, -0.14270155131816864, -1.7127249240875244, -0.2526310980319977, 1.2273576259613037, 0.18456228077411652, 0.4827233552932739, 0.22648747265338898, -0.14994949102401733, 0.36156702041625977, -0.4775677025318146, 0.4990452527999878, 0.5605514645576477, -1.3218228816986084, 0.3023143708705902, 0.1326463669538498, -0.06682164967060089, 0.67506343126297, 0.7789047956466675, 0.9309543967247009, 0.761660099029541, -0.5865586996078491, 0.27549368143081665, 0.33817097544670105, 0.9972448945045471, 0.08765702694654465, 0.3698928654193878, 0.38430899381637573, -0.9834305644035339, -0.29320552945137024, -0.8495774865150452, -0.9197812676429749, 0.17198337614536285, 0.29586073756217957, -0.9500056505203247, -0.5820655226707458, -0.007436471525579691, 0.7831603288650513, 0.1776518076658249, 0.10537846386432648, -0.3772934079170227, 0.8890546560287476, -0.13270609080791473, 0.18161891400814056, 0.15409718453884125, 0.49591800570487976, -0.06097251549363136, -0.22847004234790802, 0.17541658878326416, -0.1048409566283226, 0.06413611769676208, 0.6106786131858826, -0.6602835059165955, -0.060050636529922485, -0.048013944178819656, -0.3466293513774872, 0.2365756332874298, 1.0465145111083984, 0.5674278140068054, 0.30024611949920654, -0.6011492013931274, 0.5455132126808167, 0.7198490500450134, -0.0934506431221962, -0.32681575417518616, 0.3674893081188202, 0.6216062307357788, -0.693377673625946, 0.44566282629966736, 0.9163438081741333, 0.36727482080459595, -0.3835645616054535, -0.847441554069519, -0.5364241003990173, 0.34826603531837463, -0.7100307941436768, -0.7120301723480225, 0.5163324475288391, -0.3665933310985565, -0.023178216069936752, -0.02045685052871704, -0.8621214032173157, 0.1695367395877838, 0.5721643567085266, -1.4852259159088135, -0.9466551542282104, 0.6440295577049255, -0.11006878316402435, -0.610293984413147, 0.09923810511827469, 1.533121943473816, 0.1430908739566803, -0.07374491542577744, 0.05222724750638008, 0.3314560055732727, 0.09982714802026749, -0.2817005515098572, -0.8530186414718628, 1.1758451461791992, 0.008638645522296429, 0.06219597905874252, 0.09093999862670898, -0.15580116212368011, -0.0956101343035698, -0.8352169990539551, -0.13052816689014435, 0.829007089138031, -1.2341907024383545, -0.1997842639684677, -0.8533800840377808, -1.09201979637146, 0.49780023097991943, 0.398892879486084, -0.08894951641559601, 0.5127366781234741, -0.01242309994995594, -0.6806214451789856, 0.16680321097373962, -0.7588878273963928, -0.13496772944927216, 0.44360578060150146, -0.8433673977851868, -0.0892813503742218, -0.16232672333717346, 0.5155321359634399, -0.9697636365890503, -0.969489336013794, -0.2666938900947571, 0.2724214792251587, 0.2585039734840393, 1.1331220865249634, -0.41594645380973816, 0.45746567845344543, 0.8301059007644653, -0.12183848023414612, -0.6955834031105042, -0.0953470915555954, -0.6556580066680908, -0.5059877038002014, 0.046542875468730927, 1.0252054929733276, -0.39604735374450684, 0.12359506636857986, 0.7384305000305176, 0.5070520043373108, -0.5327937602996826, -0.5699452757835388, -0.049111027270555496, 0.1318483203649521, -0.6200985908508301, 0.4535401165485382, -0.07630413770675659, -0.34036362171173096, 0.10868141800165176, 0.14389294385910034, 0.8757344484329224, -0.11221878230571747, -1.0300028324127197, 0.0923122689127922, -0.33081406354904175, -0.12200900167226791, -0.2515357434749603, -0.49011826515197754, -0.975864589214325, 0.1865096390247345, -1.1790417432785034, -0.057254642248153687, -1.1466286182403564, -0.22881083190441132, 0.1303575038909912, -0.30415862798690796, 0.42968448996543884, 0.09194042533636093, -0.14656800031661987, -0.5037686824798584, -0.5001134276390076, -0.6035076975822449, 0.47974643111228943, 0.7529599070549011, -0.5403198599815369, 0.28037920594215393, -0.24338048696517944, 0.10821551829576492, -0.15617293119430542, 0.3572836220264435, -0.5180836915969849, -0.8994413614273071, -0.9930049180984497, 0.8468354940414429, 0.0722004622220993, 0.07230322808027267, -0.27210620045661926, 0.7726434469223022, 0.6410704851150513, -0.044736701995134354, -0.20131058990955353, 0.29687055945396423, -0.8894179463386536, -0.41950884461402893, 0.35958147048950195, -0.7954350709915161, 0.16243265569210052, 0.35875076055526733, -0.49115514755249023, -0.007463609799742699, 0.6625730991363525, -0.15115368366241455, -1.3166453838348389, -0.9454962015151978, 0.4019054174423218, -0.6025571227073669, 0.38130074739456177, -0.3998376429080963, 0.012941240333020687, -0.8759134411811829, -0.30824989080429077, 0.06484059989452362, 0.47686418890953064, -0.4685904383659363, 0.7415159940719604, 0.47598764300346375, -0.6373807787895203, -0.16280679404735565, 0.43562498688697815, 0.05015391483902931, -0.1674470156431198, 0.3476274311542511, 0.5087504386901855, 0.0509563684463501, 0.549975574016571, 0.3040156364440918, 0.22630642354488373, -1.104655385017395, -0.13895027339458466, 0.6211199164390564, -0.7949480414390564, -0.49845677614212036, 1.0391510725021362, -0.6400330662727356, -1.3551349639892578, 0.0246721263974905, -1.336027979850769, -0.6989156603813171, -0.2936915457248688, 0.6183413863182068, -0.125785693526268, 0.07186567783355713, -0.020440472289919853, -0.698347270488739, -0.0779302641749382, -0.20321685075759888, -0.5092998147010803, 0.6087865829467773, 0.0545964278280735, -0.6433959007263184, 0.5148293972015381, 0.6634938716888428, -0.7773473858833313, -0.3920719027519226, -0.930530846118927, -0.3567447066307068, 0.4127647280693054, 0.6406545042991638, -0.621528685092926, -0.4724792540073395, 0.436208039522171, 0.27960455417633057, 0.10386867076158524, 0.10077773779630661, -0.122158944606781, 0.2876345217227936, 0.9543834924697876, -0.18811683356761932, -0.24731077253818512, -0.800274670124054, 1.1201213598251343, 0.7121498584747314, -0.9649741649627686, 0.3408816456794739, -0.05465511605143547, -0.9024289846420288, 0.7409525513648987, -0.029204372316598892, 0.4401397109031677, 0.785625159740448, -0.033077649772167206, 0.06273887306451797, 0.09192946553230286, -1.1716941595077515, -0.3596799969673157, 0.8791275024414062, 1.0265910625457764, 0.5990566611289978, 0.06771459430456161, 0.5179920792579651, 0.756494402885437, 0.3627168536186218, 0.25698915123939514, 0.18524092435836792, 0.36223888397216797, -0.16792266070842743, -0.1169981136918068, 0.12178774923086166, 1.0850735902786255, -0.9827234745025635, -1.3415027856826782, 0.08658508956432343, 0.5979519486427307, 0.15387511253356934, 0.48997509479522705, 0.731745183467865, 0.2985954284667969, 0.3133184313774109, 0.4324556589126587, 0.4937615990638733, -0.3603135347366333, -0.28206920623779297, -0.5292868614196777, -0.5355985760688782, -0.30138325691223145, -0.14573028683662415, -0.288420170545578, -0.5770717263221741, -0.18033044040203094, 0.24275454878807068, 0.2948783338069916, 0.5190708041191101, 1.31978440284729, 0.5569466352462769, 0.4469420611858368, -0.7270277738571167, 0.0982961431145668, -0.6235825419425964, -1.1580086946487427, -0.2142804116010666, -0.7760790586471558, -0.3247162103652954, -0.010363936424255371, -0.09148026257753372, -0.729964017868042]}, "authors": [{"authorId": "2306265527", "name": "Zayd Muhammad Kawakibi Zuhri"}, {"authorId": "2191731497", "name": "Muhammad Farid Adilazuarda"}, {"authorId": "2257345523", "name": "Ayu Purwarianti"}, {"authorId": "8129718", "name": "Alham Fikri Aji"}], "references": [{"paperId": "8b8a7f1ac390a2394802234d3c539da86c56de66", "title": "Reducing Transformer Key-Value Cache Size with Cross-Layer Attention"}, {"paperId": "6c323c535365e1c7cbfd9703cbec3b5650a3346b", "title": "Model Tells You What to Discard: Adaptive KV Cache Compression for LLMs"}, {"paperId": "fdc53c2c10742464087c0525f77e32604827a21d", "title": "Efficient Streaming Language Models with Attention Sinks"}, {"paperId": "d6eeb2898bd9bd34744194ef543062dda6c4531a", "title": "Scissorhands: Exploiting the Persistence of Importance Hypothesis for LLM KV Cache Compression at Test Time"}, {"paperId": "5ae6fb6b5a3c7df515ff4a82ac9673bae6a8e200", "title": "GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints"}, {"paperId": "be55e8ec4213868db08f2c3168ae666001bea4b8", "title": "Pythia: A Suite for Analyzing Large Language Models Across Training and Scaling"}, {"paperId": "13a0d8bb38f739990c8cd65a44061c6534f17221", "title": "OPT: Open Pre-trained Transformer Language Models"}, {"paperId": "e37018d3cfab9cfc29a7b78404e6c86ea18a907e", "title": "GPT-NeoX-20B: An Open-Source Autoregressive Language Model"}, {"paperId": "4a54d58a4b20e4f3af25cea3c188a12082a95e02", "title": "Transformer Feed-Forward Layers Are Key-Value Memories"}, {"paperId": "044e13d7dd4e0655eb76f0bd00b2c1bdb44e2be3", "title": "Big Bird: Transformers for Longer Sequences"}, {"paperId": "925ad2897d1b5decbea320d07e99afa9110e09b2", "title": "Longformer: The Long-Document Transformer"}, {"paperId": "04f4e55e14150b7c48b0287ba77c7443df76ed45", "title": "PIQA: Reasoning about Physical Commonsense in Natural Language"}, {"paperId": "dc52b09089704ebd6f471177474bc29741c50023", "title": "Fast Transformer Decoding: One Write-Head is All You Need"}, {"paperId": "88bb0a28bb58d847183ec505dda89b63771bb495", "title": "Think you have Solved Question Answering? Try ARC, the AI2 Reasoning Challenge"}, {"paperId": "932a5de79d8a8ebb75ea0c43493450fd9922e738", "title": "Crowdsourcing Multiple Choice Science Questions"}, {"paperId": "204e3073870fae3d05bcbc2f6a8e263d9b72e776", "title": "Attention is All you Need"}, {"paperId": "5ed791f810da580c78df6a052c6b9f2e258f6b0a", "title": "The LAMBADA dataset: Word prediction requiring a broad discourse context"}, {"paperId": null, "title": "2022. Efficiently scaling transformer inference"}, {"paperId": null, "title": "2023. A framework for few-shot language model"}]}