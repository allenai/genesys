{"paperId": "d9e67bb4140cd1703c858b8d09f268cb94ccd355", "abstract": "Transformer-based large language models (LLMs) are now deployed to hundreds of millions of users. LLM inference is commonly performed on batches of sequences that share a prefix, such as few-shot examples or a chatbot system prompt. Decoding in this large-batch setting can be bottlenecked by the attention operation, which reads large key-value (KV) caches from memory and computes inefficient matrix-vector products for every sequence in the batch. In this work, we introduce Hydragen, a hardware-aware exact implementation of attention with shared prefixes. Hydragen computes attention over the shared prefix and unique suffixes separately. This decomposition enables efficient prefix attention by batching queries together across sequences, reducing redundant memory reads and enabling the use of hardware-friendly matrix multiplications. Our method can improve end-to-end CodeLlama-13b throughput by up to 32x against competitive baselines, with speedup growing with the batch size and shared prefix length. Hydragen also enables the use of very long shared contexts: with a large batch size, increasing the prefix length from 1K to 16K tokens decreases Hydragen throughput by less than 15%, while the throughput of baselines drops by over 90%. Hydragen generalizes beyond simple prefix-suffix decomposition and can be applied to tree-based prompt sharing patterns, allowing us to further reduce inference time on competitive programming problems by 55%.", "venue": "arXiv.org", "year": 2024, "citationCount": 11, "influentialCitationCount": 1, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "Hydragen is introduced, a hardware-aware exact implementation of attention with shared prefixes that can improve end-to-end CodeLlama-13b throughput by up to 32x and reduce inference time on competitive programming problems by 55%."}, "embedding": {"model": "specter_v2", "vector": [0.1660875380039215, 0.4069959223270416, -0.4322482645511627, 0.05621033534407616, -0.492531418800354, -0.27228793501853943, 0.7939010858535767, 0.1555764228105545, -0.40637946128845215, -0.5160909295082092, 0.5143648386001587, -0.6380927562713623, 0.808779239654541, 0.2732880115509033, -0.47911909222602844, 0.3042840361595154, -0.8196603655815125, 0.3067973554134369, 0.262466162443161, -0.20086613297462463, -0.0314568467438221, -0.7637895345687866, -1.2857441902160645, 0.4019036889076233, 0.12835289537906647, 0.4940226674079895, 0.48423072695732117, 0.8710698485374451, -0.6716945171356201, 0.9424123764038086, 0.3939305245876312, -0.3539258539676666, 0.03258229419589043, 0.014116447418928146, -0.5180898904800415, -0.3629331886768341, 0.1327173113822937, -0.4748745560646057, -0.3016127943992615, 0.7781679630279541, -0.2183445394039154, 0.10012394934892654, 0.1510443538427353, -0.8798246383666992, -0.16244415938854218, 1.1963003873825073, 0.5467564463615417, 0.5713361501693726, -0.13716427981853485, -0.14120599627494812, 1.4735558032989502, -1.575632095336914, 0.5267229080200195, 1.2592008113861084, 0.5504828095436096, 0.18888697028160095, -0.0016833978006616235, -0.3439376950263977, 0.7714270949363708, 0.46377015113830566, -1.093641757965088, -0.39055630564689636, -0.4962499141693115, 0.04451243206858635, 2.148836612701416, -0.2258417159318924, 0.10197411477565765, 0.3260142207145691, -0.14200429618358612, 1.4820879697799683, -0.33914607763290405, -0.9635482430458069, -0.11539701372385025, -0.07476463913917542, 0.12564648687839508, 0.8240910172462463, -0.6402990221977234, -0.06349310278892517, -0.6120409965515137, -0.22941820323467255, 0.14166395366191864, 0.16633164882659912, 0.39124464988708496, 0.019474083557724953, -0.3576124608516693, 0.6776437759399414, -0.06870780140161514, 0.7079522013664246, -0.12387426197528839, 0.47063133120536804, 0.5896540880203247, 0.27260276675224304, -0.08655523508787155, 0.3657352924346924, -0.12467427551746368, -0.12291710078716278, -0.844249963760376, 0.4965556561946869, 0.30932775139808655, 1.0903745889663696, -0.2460724413394928, -0.03591754660010338, -0.9125871062278748, 0.08129051327705383, 1.095794677734375, 0.21896608173847198, 0.21055194735527039, -1.0078402757644653, -0.01525513269007206, -0.7946934103965759, 0.08060212433338165, -0.38928231596946716, -0.07350195944309235, -0.0058084456250071526, -0.1543419063091278, -1.2503975629806519, -0.252507746219635, -0.03232178837060928, -0.216057687997818, 0.6001452803611755, -0.0669800415635109, 0.35249701142311096, 0.07560991495847702, 0.29028016328811646, 0.6371483206748962, 0.7884685397148132, 0.20859205722808838, 0.041490159928798676, 1.005346417427063, -0.9861839413642883, -0.5084277987480164, -1.3295451402664185, 1.280269980430603, -0.3016880452632904, 0.20584969222545624, -0.40823861956596375, -1.4365830421447754, -0.7439528107643127, -0.7286761403083801, -0.1302725225687027, -0.4915146231651306, 0.06881202012300491, 0.98331618309021, 0.026779431849718094, -0.9218262434005737, 0.400717169046402, -0.2319605052471161, -0.2126447558403015, 0.22763559222221375, 0.005964197218418121, 0.40906545519828796, -0.859174907207489, -1.2686617374420166, 0.2655651569366455, -0.1054505780339241, -0.6274566054344177, -0.05725226551294327, -0.7816550135612488, -1.1888850927352905, 0.015047263354063034, 0.6160673499107361, 0.11277801543474197, 1.9425692558288574, 0.21220558881759644, -1.279706597328186, 0.6620754599571228, -0.3225977420806885, 0.0019580842927098274, 0.10549010336399078, -0.08061298727989197, -0.4000638723373413, -0.6093460917472839, -0.04811090975999832, 0.6300981044769287, 0.3271477222442627, 0.38312196731567383, -0.4299711585044861, 0.4500771164894104, -0.19616901874542236, -0.08036645501852036, 0.23887252807617188, 1.4100143909454346, -0.6392658948898315, 0.4541206657886505, -0.16084039211273193, 0.8098979592323303, -0.4066854417324066, -0.0858328714966774, -0.2802315950393677, -0.9349885582923889, 0.7883855104446411, 0.06564464420080185, 1.0368766784667969, -1.023760199546814, -0.8003061413764954, -0.26431339979171753, -0.008016024716198444, 0.05663652718067169, -0.6665134429931641, 0.8236396908760071, -0.1461508721113205, 0.1948527842760086, -0.0073731099255383015, -1.0384758710861206, 0.14829404652118683, -0.1535118967294693, -0.6605427861213684, -0.20652493834495544, -0.019848404452204704, 1.0520284175872803, -0.9301533699035645, -0.45880013704299927, -0.007083583623170853, 0.001196821453049779, -1.3568499088287354, 1.5590589046478271, -0.8564634323120117, -0.0071331229992210865, -0.028310468420386314, -0.21456265449523926, -0.18844780325889587, -0.6160815954208374, 0.8072077035903931, -0.2795660197734833, -0.7225850224494934, 0.5350115299224854, -0.31595414876937866, 1.3618993759155273, -0.3559134900569916, 0.25974148511886597, 0.1671358048915863, -0.5527938008308411, 0.18713726103305817, 0.2953632175922394, -0.4606190025806427, -0.708046019077301, 0.3504682183265686, 0.8001941442489624, -0.4513486325740814, -0.05992298200726509, 0.6866664290428162, 0.984363317489624, -0.2622958719730377, 0.14129745960235596, 0.45718562602996826, -0.15337854623794556, 0.39883655309677124, 0.6802617311477661, 1.0018116235733032, 0.3529145121574402, 0.5526752471923828, 0.10975832492113113, 0.33372846245765686, -0.46666306257247925, -0.3182923495769501, 0.7643170952796936, 0.8520673513412476, 0.5146031379699707, 0.6331270933151245, -0.6558510661125183, -0.5706738829612732, 0.7427091002464294, 0.6935808658599854, 1.634600281715393, -0.012505155988037586, -0.38985663652420044, -0.8604781627655029, -0.10844413191080093, -0.3166588246822357, 0.25331494212150574, 0.10168643295764923, -0.032326195389032364, -0.8635984063148499, -0.44511303305625916, 0.8769469261169434, 0.3874083161354065, 0.6721251010894775, -0.6929771304130554, -0.39014148712158203, -0.17046314477920532, -0.028541281819343567, -1.1500345468521118, -0.5932512283325195, 0.3252347707748413, -0.1379309743642807, 0.0031706748995929956, 0.3156391382217407, -0.41631969809532166, -0.02887406013906002, -0.6428757309913635, 0.9159966707229614, -0.10312726348638535, -0.4729077219963074, 0.15619996190071106, 0.5643718242645264, -0.38513344526290894, -0.9659683108329773, 0.1947672814130783, -0.07097737491130829, -0.23576651513576508, 0.47092223167419434, 0.3310762941837311, 0.22517551481723785, -0.07728452235460281, -0.07826726138591766, 0.5082510709762573, 0.1714446246623993, -0.0407436229288578, 0.6423640251159668, -1.0339469909667969, -0.3535401225090027, -0.9314255714416504, 0.36991652846336365, -0.1356002390384674, -0.7640327215194702, 0.15007330477237701, -0.5767500996589661, -0.39192256331443787, 0.6487571001052856, -0.8065312504768372, -0.1464519202709198, -0.8755250573158264, -0.2297728806734085, -0.24396036565303802, -0.26578542590141296, 0.28662681579589844, 0.21655341982841492, 0.4747593104839325, 0.11519312858581543, 0.6784648299217224, 0.6775515675544739, -0.4241839349269867, 0.996860921382904, -0.44158393144607544, 0.8134262561798096, 0.08382996171712875, -0.18859708309173584, -0.37639516592025757, -0.04349564388394356, -0.6527203321456909, -0.27129217982292175, -0.4057919979095459, 0.010836630128324032, -0.32656311988830566, 0.18410347402095795, -0.5750954151153564, -1.0777175426483154, -0.005194021388888359, -1.5099070072174072, -0.5987411737442017, 0.20523598790168762, -0.304934561252594, -0.3072255551815033, -0.8429378867149353, -1.3304733037948608, -0.5405794382095337, -0.44317173957824707, -1.0662095546722412, 0.40149447321891785, -0.30234694480895996, -0.5827836394309998, -0.3218882381916046, 0.08245359361171722, -0.7623727917671204, 0.9947984218597412, -0.9423114657402039, 0.9265318512916565, -0.34349435567855835, -0.43579521775245667, -0.21182231605052948, 0.19274619221687317, 0.18086232244968414, -0.7086689472198486, 0.17993630468845367, -0.4379856586456299, 0.46878060698509216, -0.5359368324279785, -0.41159915924072266, -0.46509039402008057, 0.1380532830953598, 0.5977257490158081, -0.21528537571430206, -0.7083655595779419, 0.1297345906496048, 1.2679369449615479, -0.6322001218795776, 0.10692134499549866, 0.10037092119455338, 0.917074978351593, 0.04303637519478798, 0.03237888589501381, 0.8245693445205688, 0.22406473755836487, 0.7292221188545227, 0.3283521831035614, 0.06618794798851013, 0.20099219679832458, -0.4789925217628479, 0.7380730509757996, 1.5548958778381348, 0.6557947397232056, 0.17923372983932495, -0.9923454523086548, 0.5832349061965942, -1.3266000747680664, -0.6903387904167175, 0.3362845778465271, 0.35876786708831787, 0.5142262578010559, -0.6942189335823059, -0.10663430392742157, -0.5409770011901855, 0.44199153780937195, 0.29606127738952637, -0.13064859807491302, -0.856737494468689, 0.19653327763080597, 0.44731569290161133, 0.1401122659444809, 0.6313119530677795, 0.001185110886581242, 0.7460474967956543, 14.743786811828613, 1.0301469564437866, -0.07020553946495056, 0.7405992746353149, 0.49322834610939026, 0.23855972290039062, -0.22128833830356598, -0.2109491229057312, -1.466596245765686, -0.3320665955543518, 1.6765635013580322, 0.16924287378787994, 0.5351702570915222, 0.4536391794681549, -0.07774622738361359, 0.32628536224365234, -0.6292274594306946, 0.5640063285827637, 0.2862524688243866, -1.78916335105896, -0.15919369459152222, -0.03983904421329498, -0.048813238739967346, 0.7805395722389221, 0.6697077751159668, 1.05985426902771, 0.845602810382843, -0.46701207756996155, 0.836333692073822, 0.08426766842603683, 1.1334260702133179, -0.08156966418027878, 0.4142349362373352, 0.7020263075828552, -0.8510384559631348, -0.21342165768146515, -0.45911288261413574, -1.4399844408035278, 0.3557988405227661, -0.026552150025963783, -0.8060380816459656, -0.7529155611991882, -0.25756198167800903, 0.794424831867218, 0.4537220597267151, 0.21277762949466705, 0.11867081373929977, 0.6550877690315247, -0.07750634849071503, -0.3339005708694458, 0.3583969175815582, 0.5467397570610046, -0.08421845734119415, 0.2577802538871765, 0.1164465919137001, -0.007409217301756144, 0.2517254054546356, 0.664311408996582, -0.3137979507446289, 0.16352710127830505, -0.5006073117256165, -0.20529279112815857, 0.43618667125701904, 0.6801275610923767, 0.6691817045211792, 0.03531859815120697, -0.975077211856842, 0.37242087721824646, 0.7324349284172058, -0.2018977701663971, -0.2033894658088684, 0.2490442544221878, 0.5564990043640137, -0.4879871904850006, 0.5165149569511414, 0.7221738696098328, 0.2848319113254547, -0.21279948949813843, -0.903235137462616, -0.8095309734344482, 0.1360923945903778, -0.6521629691123962, -0.4925924837589264, 0.6481052041053772, -0.16722531616687775, -0.403876930475235, -0.30792370438575745, -0.7452426552772522, -0.2300657480955124, 0.3310333490371704, -0.925016462802887, -0.5478590130805969, 0.5415588021278381, -0.3651781678199768, -0.44992727041244507, 0.4946915805339813, 1.527551293373108, 0.2141290009021759, -0.18160365521907806, -0.11873763054609299, 0.19109958410263062, -0.006326448172330856, -0.4316767156124115, -0.6431302428245544, 1.2332412004470825, 0.4048726260662079, -0.15052923560142517, 0.26841071248054504, 0.20692722499370575, 0.19035793840885162, -0.9709352254867554, -0.14246103167533875, 0.8586226105690002, -0.9749056100845337, -0.16203121840953827, -1.038509726524353, -0.8174558281898499, 0.5001959800720215, 0.5909715294837952, 0.04591433331370354, 0.26702627539634705, -0.04055638611316681, -0.6809958219528198, -0.04831370711326599, -0.5489673018455505, 0.4149427115917206, 0.6079130172729492, -0.787889838218689, 0.1318773478269577, -0.1514333039522171, 0.869953453540802, -1.2083970308303833, -0.6952412128448486, -0.5549958348274231, 0.24302656948566437, 0.10953395068645477, 0.7932780981063843, -0.19240452349185944, 0.9119131565093994, 0.9932523369789124, -0.37259551882743835, -0.429303914308548, 0.23062796890735626, -0.9998660683631897, -0.37523555755615234, 0.06402210891246796, 0.805354118347168, -0.22734518349170685, -0.020277146250009537, 0.8378608822822571, 0.25727182626724243, -0.7401542067527771, -0.38073039054870605, -0.4287989139556885, 0.15864022076129913, -0.7428960800170898, 0.6888090372085571, -0.07088682800531387, 0.42083242535591125, 0.17483246326446533, 0.11312760412693024, 0.4693634510040283, -0.3641234040260315, -0.7144650220870972, 0.651975691318512, 0.07909152656793594, -0.4000733494758606, -0.2940276861190796, -0.43609723448753357, -1.5403761863708496, -0.1445470154285431, -1.0692676305770874, 0.46711206436157227, -0.603263258934021, -0.32582566142082214, 0.1238107830286026, 0.08553614467382431, 0.14068704843521118, 0.4173065423965454, -0.5358409881591797, -0.564115047454834, -0.6967769265174866, -0.9462618827819824, 0.49636968970298767, 0.4421863257884979, -0.4561602473258972, 0.5001664161682129, -0.3847680389881134, 0.08721445500850677, -0.024586297571659088, 0.229164257645607, -0.411816269159317, -0.3570505976676941, -1.0364396572113037, 0.40026235580444336, 0.2216138243675232, -0.07442299276590347, -0.6053751707077026, 0.6062064170837402, 0.36413663625717163, -0.809074342250824, -0.021738065406680107, 0.013519820757210255, -0.6562446355819702, -0.3351761996746063, 0.404293954372406, -0.7909236550331116, 0.27707716822624207, 0.39027130603790283, -0.8393685817718506, -0.013169331476092339, 0.698610782623291, -0.22853904962539673, -1.141304850578308, -0.987463116645813, 0.21864841878414154, -1.065399169921875, 0.32714390754699707, -0.6878227591514587, 0.18779543042182922, -0.9329755306243896, -0.5177911520004272, 0.3758777678012848, 0.18593724071979523, -0.17098456621170044, 0.8537670373916626, 0.13328669965267181, -0.8875603079795837, 0.18916210532188416, 0.1674744188785553, 0.12391510605812073, -0.04763512313365936, 0.4217149615287781, 0.8539832830429077, -0.18951743841171265, 0.43032029271125793, 0.29582101106643677, 0.1504630446434021, -1.1772750616073608, 0.30315864086151123, 0.5627836585044861, -0.5275077223777771, -0.4567257761955261, 1.0870894193649292, -0.5936819314956665, -0.9225839972496033, 0.02432399056851864, -1.4264230728149414, -0.30322742462158203, -0.9012567400932312, 0.8896417617797852, -0.12211403250694275, 0.07074900716543198, -0.022569846361875534, -0.6921066641807556, -0.08380575478076935, -0.24668137729167938, -0.4308624565601349, 0.28447669744491577, -0.05908983573317528, -0.6630660891532898, 0.47633007168769836, 1.1215983629226685, -0.47704488039016724, -0.30291223526000977, -0.8865996599197388, -0.37999847531318665, 0.33227235078811646, 0.08790455013513565, -0.22136689722537994, -0.03478678688406944, 0.7028471827507019, 0.18444237112998962, 0.08705008774995804, -0.3346056044101715, 0.26509448885917664, 0.3289373219013214, 0.837004542350769, 0.0512222982943058, -0.28857266902923584, -0.5713327527046204, 1.3270289897918701, 0.814665675163269, -0.7967290878295898, -0.2158457338809967, -0.11981216818094254, -0.6595393419265747, 0.47246450185775757, 0.20819060504436493, 0.3064427077770233, 0.7081619501113892, 0.23245397210121155, 0.2851561903953552, 0.07201029360294342, -1.273741602897644, -0.21684736013412476, 0.25579696893692017, 0.8376943469047546, 0.5834619998931885, 0.2904180586338043, 0.1628914177417755, 0.9046770334243774, 0.26190468668937683, 0.26623591780662537, 0.3531862199306488, 0.7714434266090393, -0.3288891613483429, -0.14159947633743286, 0.1291244477033615, 0.714207649230957, -0.7881903052330017, -1.0603587627410889, 0.36971092224121094, 0.5142815113067627, 0.04624828323721886, 0.6314291954040527, 1.0573760271072388, 0.07441926747560501, 0.43671292066574097, 0.28649434447288513, 0.5091531872749329, -0.6935676336288452, -0.16418121755123138, -0.4353238046169281, -0.4097932279109955, -0.5006764531135559, 0.17664599418640137, -0.6448248624801636, -0.7774336338043213, -0.47551968693733215, 0.3927660286426544, 0.17177732288837433, 0.04518017917871475, 1.4269788265228271, 0.7224606871604919, 0.1634185016155243, -0.41413772106170654, -0.36389270424842834, -0.5436140298843384, -0.9090710282325745, 0.10724369436502457, -0.6651233434677124, -0.44522255659103394, 0.10658206790685654, 0.0734516978263855, -0.3650037944316864]}, "authors": [{"authorId": "50875781", "name": "Jordan Juravsky"}, {"authorId": "2283198901", "name": "Bradley Brown"}, {"authorId": "2283134957", "name": "Ryan Ehrlich"}, {"authorId": "2259931128", "name": "Daniel Y. Fu"}, {"authorId": "2259934664", "name": "Christopher R'e"}, {"authorId": "1861312", "name": "Azalia Mirhoseini"}], "references": [{"paperId": "eb95c327260725498404eb43ec370d419b8d92c7", "title": "SGLang: Efficient Execution of Structured Language Model Programs"}, {"paperId": "5c104f905fcacf390270f619f232a2ba4eb873f2", "title": "FlashFFTConv: Efficient Convolutions for Long Sequences with Tensor Cores"}, {"paperId": "83b90f4a0ae4cc214eb3cc140ccfef9cd99fac05", "title": "Efficient Memory Management for Large Language Model Serving with PagedAttention"}, {"paperId": "aade40af0d85b0b4fe15c97f6222d5c2e4d6d9b3", "title": "Graph of Thoughts: Solving Elaborate Problems with Large Language Models"}, {"paperId": "104b0bb1da562d53cbda87aec79ef6a2827d191a", "title": "Llama 2: Open Foundation and Fine-Tuned Chat Models"}, {"paperId": "823ca4778e1027f2f0b356df051d762dcecaaba0", "title": "FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning"}, {"paperId": "5ae6fb6b5a3c7df515ff4a82ac9673bae6a8e200", "title": "GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints"}, {"paperId": "2f3822eb380b5e753a6d579f31dfc3ec4c4a0820", "title": "Tree of Thoughts: Deliberate Problem Solving with Large Language Models"}, {"paperId": "42a14d824caa3348046eb34c37e2ab7985faa7a3", "title": "High-throughput Generative Inference of Large Language Models with a Single GPU"}, {"paperId": "c022f75b00d795c6297d6a9ea948856ea4d365a1", "title": "DeepSpeed- Inference: Enabling Efficient Inference of Transformer Models at Unprecedented Scale"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "5f19ae1135a9500940978104ec15a5b8751bc7d2", "title": "Self-Consistency Improves Chain of Thought Reasoning in Language Models"}, {"paperId": "5cbe278b65a81602a864184bbca37de91448a5f5", "title": "Competition-level code generation with AlphaCode"}, {"paperId": "53c3940f35b8b45d55ed49056282e1961954513d", "title": "Self-attention Does Not Need $O(n^2)$ Memory"}, {"paperId": "1ccd031f28dccfb226f6c0c588c93a97a50bf95f", "title": "Measuring Coding Challenge Competence With APPS"}, {"paperId": "90abbc2cf38462b954ae1b772fac9532e2ccd8b0", "title": "Language Models are Few-Shot Learners"}, {"paperId": "dc52b09089704ebd6f471177474bc29741c50023", "title": "Fast Transformer Decoding: One Write-Head is All You Need"}, {"paperId": "8fc2dbe634afc6777f968c8128d1ab0c2b8f56a4", "title": "[War and peace]."}, {"paperId": "3d473cbb7a377cf960abff31748a1a39bb6c7d7c", "title": "Skeleton-of-Thought: Large Language Models Can Do Parallel Decoding"}, {"paperId": "9d7a75601e0e50dd68d40cfb8ef0e891dad797a6", "title": "Orca: A Distributed Serving System for Transformer-Based Generative Models"}, {"paperId": "0639baa6dfb35d962e46eb0c38763d769ffb0946", "title": "Models"}, {"paperId": "9405cc0d6169988371b2755e573cc28650d14dfe", "title": "Language Models are Unsupervised Multitask Learners"}, {"paperId": null, "title": "vLLM without Detokenization: We disable incremental detokenization in vLLM (accomplished by commenting out one line in the vLLM codebase), which we observed to improve throughput"}, {"paperId": null, "title": "Openai\u2019s chatgpt now has 100 million weekly active users"}, {"paperId": null, "title": "Scaling language"}, {"paperId": null, "title": "HuggingFace"}]}