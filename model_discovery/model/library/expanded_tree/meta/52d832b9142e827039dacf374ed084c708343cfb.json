{"paperId": "52d832b9142e827039dacf374ed084c708343cfb", "abstract": "Neighborhood attention reduces the cost of self attention by restricting each token's attention span to its nearest neighbors. This restriction, parameterized by a window size and dilation factor, draws a spectrum of possible attention patterns between linear projection and self attention. Neighborhood attention, and more generally sliding window attention patterns, have long been bounded by infrastructure, particularly in higher-rank spaces (2-D and 3-D), calling for the development of custom kernels, which have been limited in either functionality, or performance, if not both. In this work, we first show that neighborhood attention can be represented as a batched GEMM problem, similar to standard attention, and implement it for 1-D and 2-D neighborhood attention. These kernels on average provide 895% and 272% improvement in full precision latency compared to existing naive kernels for 1-D and 2-D neighborhood attention respectively. We find certain inherent inefficiencies in all unfused neighborhood attention kernels that bound their performance and lower-precision scalability. We also developed fused neighborhood attention; an adaptation of fused dot-product attention kernels that allow fine-grained control over attention across different spatial axes. Known for reducing the quadratic time complexity of self attention to a linear complexity, neighborhood attention can now enjoy a reduced and constant memory footprint, and record-breaking half precision latency. We observe that our fused kernels successfully circumvent some of the unavoidable inefficiencies in unfused implementations. While our unfused GEMM-based kernels only improve half precision performance compared to naive kernels by an average of 496% and 113% in 1-D and 2-D problems respectively, our fused kernels improve naive kernels by an average of 1607% and 581% in 1-D and 2-D problems respectively.", "venue": "arXiv.org", "year": 2024, "citationCount": 1, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "Fused neighborhood attention is developed; an adaptation of fused dot-product attention kernels that allow fine-grained control over attention across different spatial axes that can now enjoy a reduced and constant memory footprint, and record-breaking half precision latency."}, "embedding": {"model": "specter_v2", "vector": [-0.1683652102947235, 0.47244226932525635, -0.7776240706443787, 0.10046281665563583, -0.5332645177841187, 0.3126797676086426, 0.7362906336784363, 0.28816714882850647, -0.49455496668815613, -0.5058033466339111, 0.7590585350990295, 0.36387568712234497, 0.634443461894989, -0.1724066138267517, -0.21654492616653442, 0.0003584435908123851, -0.9001020789146423, -0.08457781374454498, 0.33202940225601196, -0.3515377342700958, 0.5288684368133545, -0.678277850151062, -1.7708693742752075, 0.6547762155532837, 0.48814359307289124, 0.5566761493682861, -0.01637186110019684, 0.7197583913803101, -0.2146124392747879, 0.18881340324878693, 0.20001643896102905, 0.5215508937835693, 0.35249418020248413, 0.2793198525905609, -0.5194235444068909, -0.35270941257476807, 0.6832948327064514, -0.28839990496635437, -0.4208955466747284, 0.7607464790344238, -0.1290161907672882, 0.6080277562141418, -0.013390379026532173, -0.4847547113895416, -0.49413812160491943, 0.9641377329826355, 0.010230756364762783, 0.8320083618164062, -0.557219386100769, -0.5563721060752869, 1.2005395889282227, -1.5337179899215698, 0.39103424549102783, 1.1875441074371338, 0.048961322754621506, -0.027462445199489594, -0.47033682465553284, 0.04429975524544716, 0.7216230034828186, 0.3566455841064453, -1.0255616903305054, -0.7936636209487915, -0.3946426808834076, -0.06823219358921051, 2.090475559234619, -0.19888374209403992, -0.1627964973449707, -0.28736141324043274, 0.18697340786457062, 1.3002592325210571, 0.07307279855012894, -0.8770774602890015, -0.08195991814136505, 0.05163666978478432, 0.9639114737510681, 0.503980278968811, -0.33097243309020996, 0.4443035423755646, -1.2161394357681274, -0.284127414226532, 0.39266538619995117, -0.02845579944550991, 0.32965531945228577, -0.2831716239452362, -0.39603739976882935, 0.5314465165138245, 0.30426931381225586, 0.5780009031295776, -0.20239023864269257, 1.0864393711090088, 0.4524940848350525, 0.20797136425971985, 0.3713054358959198, 0.13902126252651215, 0.4234965443611145, 0.09553135186433792, -0.8881123065948486, 0.19778157770633698, -0.18882612884044647, 0.9823026657104492, 0.4662620425224304, 0.27465301752090454, -1.0780385732650757, -0.11040801554918289, 0.946740984916687, 0.04419322311878204, 0.19838739931583405, -0.45731621980667114, -0.24180729687213898, -0.4766913950443268, -0.006897175218909979, -0.41453373432159424, -0.004026927053928375, -0.2587861120700836, -0.7525598406791687, -0.5507831573486328, -0.36626553535461426, 0.498473584651947, -0.6070543527603149, 0.15122616291046143, 0.15486016869544983, 0.26166999340057373, -0.049653250724077225, 0.6010895371437073, 0.8841559290885925, 0.3247113525867462, -0.09718801826238632, 0.32540571689605713, 1.4030232429504395, -1.3435235023498535, -0.4398527443408966, -0.6391038298606873, 0.9441568851470947, -0.9149758815765381, 0.06538517028093338, -0.5148993730545044, -1.255409598350525, -1.0964220762252808, -0.8896985650062561, -0.07430855184793472, -0.7496339678764343, 0.29022514820098877, 1.2359014749526978, -0.1440969705581665, -1.1971412897109985, 0.9815757870674133, -0.7723769545555115, -0.17120647430419922, 0.30281054973602295, 0.1921621412038803, 0.24874861538410187, -0.09818718582391739, -0.957313060760498, 0.16917859017848969, -0.008957614190876484, -0.5117772221565247, -0.40061941742897034, -0.845093846321106, -0.9374210238456726, 0.06019725278019905, 0.47338274121284485, -0.1701371818780899, 1.273880124092102, 0.2511349618434906, -0.7209751009941101, 0.8179464340209961, -0.4828204810619354, -0.030407223850488663, 0.10913638770580292, -0.39568933844566345, -0.5328508615493774, -0.7051475048065186, 0.10385497659444809, 0.6023116111755371, 0.629128634929657, -0.19187664985656738, -0.2788489758968353, -0.24819886684417725, -0.2829713821411133, 0.1418212652206421, -0.44465866684913635, 0.9157490134239197, -0.662601888179779, -0.13717912137508392, 0.3458980619907379, 0.5244179964065552, -0.06367089599370956, -0.34848642349243164, -0.2130686342716217, -1.1993811130523682, 1.0569180250167847, 0.8841244578361511, 1.0676957368850708, -1.2847920656204224, -1.1048271656036377, -0.16083523631095886, 0.09975282102823257, 0.03283834457397461, -0.6970449686050415, 0.5069212317466736, -0.30372121930122375, 0.05989515036344528, 0.47259214520454407, -0.5852674245834351, -0.03577505797147751, -0.7303533554077148, -0.9199000597000122, -0.03227487951517105, -0.2297169268131256, 0.9767425656318665, -0.974033534526825, 0.0770108550786972, -0.4201867878437042, 0.5676775574684143, -0.8791903853416443, 1.0850145816802979, -0.479809045791626, -0.03157268837094307, -0.2176494300365448, -0.3882562220096588, 0.29693421721458435, -0.6835591793060303, 0.043351802974939346, -0.6993963122367859, -0.55963534116745, 0.6433071494102478, -0.6594180464744568, 1.155112862586975, -0.18053275346755981, 0.4798929691314697, 0.3601861000061035, -0.1302369087934494, 0.3397025465965271, 0.12346585094928741, -0.23616908490657806, -0.47837477922439575, 0.129513218998909, 0.039139218628406525, -0.6969874501228333, 0.5512605309486389, 1.4762587547302246, 1.9082878828048706, -0.10151134431362152, 0.7246870398521423, 0.02712474763393402, 0.008081707172095776, 0.3537255525588989, 0.4090893864631653, 0.9834829568862915, 0.4931672215461731, 0.2857290506362915, -0.4604060649871826, -0.15267479419708252, -0.12926602363586426, -0.20292019844055176, 0.8754379153251648, 0.6931106448173523, 0.5400372743606567, 0.1827613264322281, -1.1606248617172241, -0.5448619723320007, 0.1540345698595047, 0.307827353477478, 1.894429087638855, 0.0018947029020637274, -0.07637639343738556, -0.5741966962814331, -0.3312247395515442, -0.2148994505405426, -0.4124295115470886, -0.615677535533905, -0.06914255023002625, -0.8860287666320801, -1.2057019472122192, 0.4470253586769104, 0.6430760025978088, 1.2262248992919922, -0.5639193058013916, -0.9290767908096313, -0.4422917664051056, 0.9148611426353455, -0.5128214955329895, -0.7070830464363098, 0.593151867389679, -0.533942699432373, -0.10708142817020416, 0.3363979756832123, -0.16675271093845367, 0.33129778504371643, 0.14691033959388733, 1.2018879652023315, -0.016677921637892723, -0.6273512244224548, 0.026598675176501274, 0.0666487067937851, -0.42659541964530945, -0.003315326292067766, 0.6708129048347473, 0.21080535650253296, -0.552967369556427, 0.6917219161987305, 0.4736780822277069, -0.3459387421607971, 0.10765577107667923, -0.450238436460495, -0.11815190315246582, 0.1938655823469162, 0.367165207862854, 0.8153749108314514, -0.0989442691206932, -0.15888436138629913, -1.2513105869293213, 0.7208203673362732, 0.21867671608924866, -0.4162532091140747, -0.252140611410141, -0.9163290858268738, -0.28309133648872375, -0.11170849204063416, -0.7109642624855042, -0.3059707283973694, -0.6449995636940002, 0.6819212436676025, -0.19153591990470886, -0.3358136713504791, -0.33006158471107483, 0.4052995443344116, -0.20401152968406677, 0.6901686191558838, 0.2290865033864975, 0.5656524300575256, 0.0036009338218718767, 0.8465487957000732, -0.7799917459487915, 0.7544339895248413, -0.12261233478784561, -0.08670493960380554, 0.45745375752449036, -0.19324982166290283, -0.941150426864624, -0.37405192852020264, -0.37794727087020874, -0.09731877595186234, 0.15302729606628418, 0.23288819193840027, -0.7817255258560181, -1.1830511093139648, -0.1002172976732254, -1.1754095554351807, -0.4732415974140167, 0.06531029939651489, -0.06662432849407196, -0.17607057094573975, -1.1220022439956665, -1.4187421798706055, -0.35653549432754517, -1.004683017730713, -1.022720217704773, 0.4345400929450989, 0.1247154176235199, -0.48883917927742004, -0.10018813610076904, -0.03129585087299347, -0.943006157875061, 1.480891227722168, -0.8344410061836243, 0.4966985583305359, -0.1866675317287445, -0.8859634399414062, -0.17207273840904236, -0.33442172408103943, -0.17742326855659485, -0.37654250860214233, 0.11671788990497589, -0.7708589434623718, 0.1501481980085373, -0.23573100566864014, -0.07816894352436066, 0.487564355134964, 0.30833593010902405, 0.48154306411743164, 0.06292679905891418, -1.0160372257232666, 0.24982726573944092, 1.4332270622253418, -0.6957355737686157, 0.24393513798713684, 0.331283837556839, 0.8594315648078918, 0.18473172187805176, 0.29348307847976685, 0.7285740375518799, 0.2274043709039688, 0.5855275988578796, 0.5209992527961731, -0.2744100093841553, -0.4712788164615631, 0.1777772605419159, 0.3347151279449463, 1.1833274364471436, 0.4308321177959442, 0.3828757405281067, -0.8438611626625061, 1.076812505722046, -1.5488567352294922, -0.6243925094604492, 0.3117597997188568, 0.859330952167511, 0.011819740757346153, -0.5896687507629395, -0.14091810584068298, -0.5596424341201782, 0.7146808505058289, 0.5099765062332153, -0.41597604751586914, -0.630045473575592, 0.08202240616083145, 0.3435439169406891, 0.5142434239387512, 0.49191197752952576, -0.5737807750701904, 0.9518954157829285, 14.691479682922363, 1.0062084197998047, 0.24571621417999268, 0.5123783946037292, 0.8808048963546753, 0.0347154438495636, -0.0716511458158493, 0.14752347767353058, -1.7327378988265991, -0.33990052342414856, 0.5443068146705627, 0.3197876513004303, 0.46862003207206726, 0.4732889235019684, 0.043202728033065796, -0.175007626414299, -0.6528737545013428, 0.2956545054912567, 0.43136152625083923, -1.5555907487869263, 0.06642889231443405, 0.29735586047172546, 0.6183450222015381, 0.4535776376724243, 0.9975220561027527, 0.4713629484176636, 0.8545893430709839, -0.3645877540111542, -0.19453202188014984, 0.4239603281021118, 0.765341579914093, -0.22761110961437225, 0.27457165718078613, -0.16383545100688934, -0.998730480670929, 0.12196522951126099, -0.7079338431358337, -1.5199956893920898, -0.0822068527340889, 0.5464168787002563, -0.32824277877807617, -0.8048218488693237, 0.016402797773480415, 0.2664567828178406, 0.30877768993377686, 0.4953724145889282, 0.28443169593811035, -0.2489168345928192, -0.01575920544564724, -0.0906030535697937, 0.06321123987436295, 0.9032034277915955, -0.0944443792104721, 0.04162713140249252, 0.09127529710531235, 0.19327454268932343, 0.20589497685432434, 0.4117335379123688, -0.21411670744419098, -0.1129448413848877, -0.2044515460729599, 0.1232726126909256, 0.17420537769794464, 1.0508770942687988, 0.4869667589664459, 0.09515517204999924, -0.43604958057403564, 0.3230539858341217, 0.6852737069129944, -0.12602780759334564, -0.15312093496322632, -0.3902846574783325, 0.7610563635826111, -0.19300366938114166, 0.16604547202587128, 0.5907720327377319, -0.5674325823783875, -0.32476961612701416, -1.028632402420044, -0.3034631013870239, 0.3008043169975281, -0.23182420432567596, -0.5605407953262329, 1.1749637126922607, -0.36072590947151184, -0.6167231798171997, 0.2546926736831665, -0.7787068486213684, -0.720902681350708, 0.27111366391181946, -0.7755888104438782, -0.47434002161026, 0.21686646342277527, -0.6984120011329651, -0.7198452949523926, 0.23622241616249084, 1.234505295753479, -0.08743086457252502, -0.12045323848724365, 0.12493755668401718, 0.09545427560806274, -0.08070585131645203, 0.4857978820800781, -0.6539531350135803, 1.1402736902236938, 0.19636410474777222, -0.302213579416275, 0.48898956179618835, 0.02224287949502468, -0.062410593032836914, -1.1323115825653076, -0.06859602779150009, 0.5424458980560303, -0.8242308497428894, -0.32610151171684265, -0.21762485802173615, -0.7299479842185974, 0.2985241413116455, 0.7847190499305725, 0.45425087213516235, 0.1993434578180313, 0.39997804164886475, -0.707258403301239, -0.21230602264404297, -0.3928951919078827, 0.24110147356987, 0.5497380495071411, -0.7196574807167053, -0.13805806636810303, -0.18822230398654938, 0.3291262090206146, -1.3566691875457764, -0.956326425075531, -0.28842633962631226, 0.2917470633983612, -0.27656370401382446, 1.0153603553771973, -0.26999586820602417, 0.8373267650604248, 0.5062780380249023, -0.04927557334303856, -0.6533584594726562, -0.040772877633571625, -0.7252220511436462, -0.5086025595664978, 0.4011934995651245, 0.37809324264526367, -0.1094820499420166, 0.9335052967071533, 0.8357046246528625, 0.1874505877494812, -0.5015939474105835, -0.20683187246322632, -0.19196316599845886, -0.18924441933631897, -0.4018498659133911, 0.6635449528694153, 0.22570239007472992, 0.426626592874527, -0.10893189162015915, 0.46781423687934875, 0.48473724722862244, 0.1629834920167923, -0.07265276461839676, 0.8499664664268494, -0.007676700595766306, -0.1577383577823639, -0.6809566617012024, -0.4894144833087921, -1.6215219497680664, -0.30615872144699097, -0.9990095496177673, 0.14423240721225739, -0.6401076912879944, -0.46359243988990784, -0.11133535206317902, -0.18005400896072388, 0.05197591707110405, 0.0413936972618103, 0.06574410200119019, -0.7603366374969482, -0.4865352511405945, -0.8395001888275146, 0.5641629695892334, 0.8366058468818665, -0.5399231910705566, -0.193284809589386, -0.2437426596879959, -0.24587397277355194, 0.329200804233551, 0.3852747082710266, -0.42165377736091614, -0.14073219895362854, -1.462135910987854, 0.3039880096912384, -0.12271659821271896, -0.15230171382427216, -0.6680039763450623, 1.3151744604110718, 0.6508696675300598, 0.04550788924098015, -0.6277621388435364, 0.1527898609638214, -0.2907823622226715, -0.7231149077415466, 0.15134480595588684, -0.6997431516647339, 0.33337920904159546, 0.32807639241218567, -0.5010546445846558, -0.2856646180152893, 1.1792787313461304, -0.3327418565750122, -0.992451548576355, -1.0050686597824097, 0.23285603523254395, -0.4035071134567261, 0.18426568806171417, -0.38562560081481934, -0.10620608180761337, -1.7417261600494385, -0.18278279900550842, -0.3028889000415802, 0.3637663424015045, 0.030700698494911194, 0.9128280282020569, 0.20255610346794128, -1.4751864671707153, 0.022685125470161438, 0.2564961016178131, 0.12950600683689117, 0.07610584795475006, 0.8191114664077759, 0.5222347378730774, -0.11767423897981644, 0.4114069640636444, 0.1472277045249939, 0.03889887034893036, -0.7213189005851746, 0.31994378566741943, -0.11296617984771729, -0.3392200469970703, -0.10681557655334473, 0.8685621619224548, -0.37983816862106323, -0.7099254131317139, 0.07075557112693787, -0.9080453515052795, -0.25402921438217163, -0.06486353278160095, 1.07912015914917, 0.9561303853988647, 0.10371658951044083, -0.23187731206417084, -0.7364622950553894, 0.2525629699230194, -0.6115891337394714, -0.35654154419898987, 0.3132641017436981, -0.09533999860286713, -0.9219992160797119, 0.1455269604921341, 0.6249615550041199, -0.30056238174438477, -0.5465146899223328, -1.0555260181427002, -0.3208751082420349, -0.16077637672424316, 0.6261135339736938, 0.24061720073223114, -0.5172512531280518, 0.6344217658042908, 0.6781277060508728, 0.5575257539749146, -0.0583677738904953, -0.18728125095367432, 0.2785538136959076, 0.6192224621772766, -0.10317566990852356, -0.9081198573112488, -0.6620357632637024, 1.3656235933303833, 0.6338555812835693, -0.6597283482551575, 0.436866819858551, -0.23603196442127228, -0.20730511844158173, 0.6198216676712036, 0.9780938029289246, -0.2596108913421631, 1.1703351736068726, 0.08438284695148468, 0.4160989820957184, -0.035653095692396164, -1.2086504697799683, -0.6308287382125854, 0.6812540292739868, 0.9680207967758179, 0.8163897395133972, 0.17953722178936005, 0.02174687758088112, 0.34892040491104126, 0.39623332023620605, -0.21632824838161469, 0.19126774370670319, 0.47212111949920654, -0.43311527371406555, -0.05702636018395424, -0.3169412612915039, 0.7967796325683594, -0.6182591915130615, -0.7516010403633118, 0.5542798638343811, 0.6499602794647217, 0.10535018146038055, 0.6647523641586304, 1.5080211162567139, -0.2810560166835785, 0.19139620661735535, -0.2706230580806732, 0.32243144512176514, -0.6775902509689331, -0.6216609477996826, 0.10121501237154007, -0.519284725189209, -0.3919355869293213, 0.15205800533294678, -0.5065649151802063, -0.42989498376846313, -0.5220104455947876, 0.12401480972766876, 0.041279517114162445, 0.2269861400127411, 0.48255378007888794, 1.1507694721221924, 0.6653832197189331, -0.33645370602607727, -0.7412486672401428, -0.27969029545783997, -0.7809238433837891, 0.13442952930927277, -0.7576513886451721, -0.3225174844264984, 0.18399260938167572, 0.012932615354657173, -0.5695182681083679]}, "authors": [{"authorId": "2855934", "name": "Ali Hassani"}, {"authorId": "2239205654", "name": "Wen-Mei Hwu"}, {"authorId": "2290372879", "name": "Humphrey Shi"}], "references": [{"paperId": "db633c6b1c286c0386f0078d8a2e6224e03a6227", "title": "Mistral 7B"}, {"paperId": "823ca4778e1027f2f0b356df051d762dcecaaba0", "title": "FlashAttention-2: Faster Attention with Better Parallelism and Work Partitioning"}, {"paperId": "736973165f98105fec3729b7db414ae4d80fcbeb", "title": "Scalable Diffusion Models with Transformers"}, {"paperId": "b9f25fa090ebde1d144fda33f510c08910479b19", "title": "StyleNAT: Giving Each Head a New Perspective"}, {"paperId": "a883336e5c2e9f46f5012343227a6be4671c9ca0", "title": "Dilated Neighborhood Attention Transformer"}, {"paperId": "87c5b281fa43e6f27191b20a8dd694eda1126336", "title": "FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness"}, {"paperId": "ad7bcec33f5206d4f28687a6a5a950de67010651", "title": "Neighborhood Attention Transformer"}, {"paperId": "53c3940f35b8b45d55ed49056282e1961954513d", "title": "Self-attention Does Not Need $O(n^2)$ Memory"}, {"paperId": "b6382a7351c0c595f91472ac71d3b2d87b3c4844", "title": "ViViT: A Video Vision Transformer"}, {"paperId": "91e8117e7ebc966bc76de2cb52ec717d2acdb1a4", "title": "Scaling Local Self-Attention for Parameter Efficient Visual Backbones"}, {"paperId": "268d347e8a55b5eb82fb5e7d2f800e33c75ab18a", "title": "An Image is Worth 16x16 Words: Transformers for Image Recognition at Scale"}, {"paperId": "044e13d7dd4e0655eb76f0bd00b2c1bdb44e2be3", "title": "Big Bird: Transformers for Longer Sequences"}, {"paperId": "925ad2897d1b5decbea320d07e99afa9110e09b2", "title": "Longformer: The Long-Document Transformer"}, {"paperId": "3c8a456509e6c0805354bd40a35e3f2dbf8069b1", "title": "PyTorch: An Imperative Style, High-Performance Deep Learning Library"}, {"paperId": "d6dccb5d71fbb6f5765f89633ba3a8e6809a720d", "title": "Stand-Alone Self-Attention in Vision Models"}, {"paperId": "21da617a0f79aabf94272107184606cefe90ab75", "title": "Generating Long Sequences with Sparse Transformers"}, {"paperId": "ec1f582446aa24f3f0920123ee6f05feea0b5e0a", "title": "Online normalizer calculation for softmax"}, {"paperId": "1db9bd18681b96473f3c82b21edc9240b44dc329", "title": "Image Transformer"}, {"paperId": "204e3073870fae3d05bcbc2f6a8e263d9b72e776", "title": "Attention is All you Need"}, {"paperId": "2c03df8b48bf3fa39054345bafabfeff15bfd11d", "title": "Deep Residual Learning for Image Recognition"}, {"paperId": "abd1c342495432171beb7ca8fd9551ef13cbd0ff", "title": "ImageNet classification with deep convolutional neural networks"}]}