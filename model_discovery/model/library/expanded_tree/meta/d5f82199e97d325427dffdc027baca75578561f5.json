{"paperId": "d5f82199e97d325427dffdc027baca75578561f5", "abstract": "The memory and computational demands of Key-Value (KV) cache present significant challenges for deploying long-context language models. Previous approaches attempt to mitigate this issue by selectively dropping tokens, which irreversibly erases critical information that might be needed for future queries. In this paper, we propose a novel compression technique for KV cache that preserves all token information. Our investigation reveals that: i) Most attention heads primarily focus on the local context; ii) Only a few heads, denoted as retrieval heads, can essentially pay attention to all input tokens. These key observations motivate us to use separate caching strategy for attention heads. Therefore, we propose RazorAttention, a training-free KV cache compression algorithm, which maintains a full cache for these crucial retrieval heads and discards the remote tokens in non-retrieval heads. Furthermore, we introduce a novel mechanism involving a\"compensation token\"to further recover the information in the dropped tokens. Extensive evaluations across a diverse set of large language models (LLMs) demonstrate that RazorAttention achieves a reduction in KV cache size by over 70% without noticeable impacts on performance. Additionally, RazorAttention is compatible with FlashAttention, rendering it an efficient and plug-and-play solution that enhances LLM inference efficiency without overhead or retraining of the original model.", "venue": "", "year": 2024, "citationCount": 0, "influentialCitationCount": 0, "openAccessPdf": null, "tldr": {"model": "tldr@v2.0.0", "text": "RazorAttention is proposed, a training-free KV cache compression algorithm, which maintains a full cache for these crucial retrieval heads and discards the remote tokens in non-retrieval heads and introduces a novel mechanism involving a \"compensation token\" to further recover the information in the dropped tokens."}, "embedding": {"model": "specter_v2", "vector": [-0.07578964531421661, 0.052233461290597916, -0.9313250184059143, -0.007896996103227139, -0.5864138603210449, 0.10321801155805588, 0.37338146567344666, 0.029986213892698288, -0.8707283735275269, -0.39138737320899963, 0.7224684357643127, -0.23553210496902466, 0.33734098076820374, 0.2899194657802582, -0.25080129504203796, 0.019251694902777672, -1.0157296657562256, 0.15550115704536438, 0.1567763388156891, -0.06155797094106674, -0.1036694273352623, -0.6503350734710693, -1.3635543584823608, 0.06096639111638069, 0.53183913230896, 0.7561295628547668, 0.04223860800266266, 1.0109857320785522, -0.4398573637008667, 0.43970564007759094, 0.6131289005279541, -0.11390818655490875, -0.22270874679088593, 0.33883190155029297, -0.3604218661785126, -0.5914715528488159, 0.24169591069221497, -0.5587548613548279, -0.7580013275146484, 0.43430113792419434, -0.11678212881088257, 0.40168118476867676, 0.22995886206626892, -0.7607502341270447, -0.2549091875553131, 0.7356569170951843, 0.5865097045898438, 0.8282984495162964, -0.5810363292694092, -0.599899172782898, 1.4554774761199951, -1.6764025688171387, 0.034786541014909744, 1.1293673515319824, 0.459567129611969, 0.3280789256095886, -0.1542203575372696, -0.18972960114479065, 0.9820846319198608, 0.19163431227207184, -1.1166017055511475, -0.6175096035003662, -0.3018617033958435, 0.24540886282920837, 1.9811338186264038, 0.14416807889938354, 0.19803877174854279, 0.32187193632125854, 0.09044940769672394, 1.6244688034057617, -0.5838908553123474, -0.9241823554039001, -0.031779348850250244, -0.015082775615155697, 0.5689971446990967, 0.5845369100570679, -0.408925861120224, 0.07489080727100372, -0.7626791000366211, -0.4681817293167114, 0.018649887293577194, 0.13173139095306396, -0.010690176859498024, -0.10487496852874756, 0.26253893971443176, 0.7851259112358093, 0.3342951536178589, 0.7098498344421387, -0.16997185349464417, 1.0250720977783203, 0.5735997557640076, -0.11672385782003403, 0.5711131691932678, -0.03504832088947296, -0.15075427293777466, -0.04330657050013542, -1.326489806175232, 0.6716011762619019, -0.03473459929227829, 0.8523783683776855, -0.45100852847099304, 0.2678350806236267, -0.9215570688247681, 0.3369614779949188, 1.2417887449264526, 0.2732599973678589, 0.4372026324272156, -0.5948260426521301, 0.05233700945973396, -1.0296175479888916, 0.0881754606962204, -0.2613990604877472, -0.0864429697394371, -0.33593517541885376, -0.5331457853317261, -1.5045884847640991, -0.7777409553527832, 0.3927087187767029, -0.6514982581138611, 0.6895001530647278, -0.09847027063369751, 0.4373805820941925, 0.0310205090790987, 0.38318949937820435, 0.7266779541969299, 0.7669230103492737, 0.48567330837249756, -0.1332729607820511, 0.8308199644088745, -0.9727254509925842, -0.5009235143661499, -1.2149068117141724, 0.9362667798995972, -0.027310850098729134, 0.6211947798728943, -0.24159806966781616, -1.1723310947418213, -0.7920995950698853, -0.5409975051879883, -0.07545778155326843, -0.6104652285575867, -0.06711359322071075, 0.9689190983772278, 0.01951976679265499, -1.1896328926086426, 0.6447687745094299, -0.20815646648406982, 0.15632453560829163, 0.2891959846019745, 0.2789715528488159, 0.43586063385009766, -0.5350754857063293, -1.474710464477539, 0.15737856924533844, -0.07482876628637314, -0.7155650854110718, 0.10164441913366318, -0.7672538757324219, -1.0745255947113037, 0.15179449319839478, 0.4829874038696289, -0.40111061930656433, 1.6449222564697266, 0.1475868821144104, -0.7406574487686157, 0.30862075090408325, -0.711846113204956, 0.2928246557712555, -0.05660345032811165, -0.7421451210975647, -0.5244541168212891, -0.28285518288612366, -0.25306782126426697, 0.5047764182090759, 0.7187744975090027, -0.3165932893753052, -0.46368998289108276, 0.14006084203720093, -0.3575702905654907, 0.11410240828990936, -0.21194326877593994, 0.817420482635498, -1.1268717050552368, -0.14143556356430054, 0.22817672789096832, 0.5876175761222839, 0.18317911028862, -0.1695239096879959, -0.16814717650413513, -1.0297545194625854, 0.9502353668212891, -0.12143384665250778, 1.6222432851791382, -0.8538545966148376, -0.8466231226921082, -0.1406722068786621, -0.12295354157686234, 0.06301099807024002, -0.38668301701545715, 0.4856337010860443, 0.015759531408548355, 0.3545876145362854, -0.022224891930818558, -1.1091490983963013, 0.09001390635967255, -0.08411276340484619, -1.0834031105041504, -0.47874900698661804, -0.042234621942043304, 1.2575820684432983, -0.8578507900238037, -0.20554524660110474, -0.22178231179714203, 0.362953245639801, -1.0426251888275146, 1.4792817831039429, -0.5726305842399597, 0.04252165928483009, -0.13606588542461395, 0.028890151530504227, 0.05202536657452583, -0.14533421397209167, 0.36227279901504517, -0.2623332440853119, -0.23356516659259796, 0.4555445909500122, 0.05994662642478943, 0.7724772691726685, -0.5511670708656311, 0.2863864600658417, -0.045753490179777145, -0.10032374411821365, -0.29765650629997253, 0.3935296833515167, -0.2932218611240387, -0.4755798280239105, 0.17502616345882416, 0.561168909072876, -0.9508958458900452, 0.2425100952386856, 1.3317272663116455, 0.9638569951057434, -0.6830398440361023, -0.054987117648124695, 0.3058881163597107, -0.1312352567911148, 0.1947108656167984, 0.733299970626831, 0.4857715964317322, 0.5594937801361084, 0.20730134844779968, 0.1617681235074997, 0.3285871744155884, -0.7214083075523376, -0.1853356510400772, 0.7615272402763367, 0.858473539352417, 0.670306921005249, 0.29241594672203064, -0.48926684260368347, -0.41897836327552795, 0.451535701751709, 0.5455768704414368, 1.8978228569030762, -0.12784457206726074, -0.46869930624961853, -0.7098510265350342, -0.2537090480327606, -0.12825965881347656, 0.27298134565353394, -0.20861701667308807, -0.4142061769962311, -0.7937973737716675, -0.8668088316917419, 1.074256181716919, 0.6229982376098633, 0.7548476457595825, -0.571672260761261, -0.30800095200538635, -0.31669631600379944, 0.04479134455323219, -0.6883848309516907, -0.7112905979156494, 0.6624543070793152, -0.7010819315910339, 0.25772958993911743, 0.2409473955631256, -0.01268311869353056, -0.1567504107952118, -0.44465669989585876, 1.1106901168823242, 0.13110245764255524, -0.1585845649242401, 0.35539597272872925, 0.38931381702423096, -0.44947052001953125, -0.7156105041503906, 0.10451407730579376, 0.4037780165672302, -0.5872043967247009, 0.6199747323989868, 0.7902879118919373, -0.076076939702034, -0.3629967272281647, -0.5066305994987488, 0.04958527535200119, 0.006923471111804247, 0.058276232331991196, 0.8958869576454163, -0.6150433421134949, -0.27015554904937744, -1.220458745956421, 0.8059226870536804, -0.025728726759552956, -0.39283880591392517, 0.16819226741790771, -0.9627284407615662, -0.3958800733089447, 0.7174717783927917, -0.6018865704536438, -0.21876224875450134, -1.2045774459838867, 0.08484112471342087, -0.5527563095092773, -0.013228225521743298, 0.30822890996932983, 0.2319003939628601, 0.38696232438087463, -0.4944629967212677, 0.8841152191162109, 0.0032540515530854464, -0.5824700593948364, 0.8527825474739075, -0.6214369535446167, 0.7434078454971313, 0.13570041954517365, -0.12233482301235199, -0.2721959948539734, -0.4501330554485321, -0.9068050980567932, 0.025721225887537003, -0.7307461500167847, -0.23378583788871765, -0.28681880235671997, -0.16886065900325775, -0.5463365316390991, -0.4354289174079895, -0.11006976664066315, -0.8777638673782349, -0.2030089795589447, 0.17485186457633972, -0.20637519657611847, -0.13095185160636902, -1.022382378578186, -1.464430570602417, -0.6225406527519226, -1.0264980792999268, -0.8042158484458923, 0.46332573890686035, -0.16235774755477905, -0.3968731760978699, -0.5298407673835754, -0.03585829958319664, -0.5993818640708923, 1.1309378147125244, -1.187186598777771, 1.2997170686721802, 0.31229323148727417, -0.14140193164348602, -0.2897986173629761, 0.17123709619045258, 0.4178386628627777, -0.7235366702079773, 0.21011991798877716, -1.1030421257019043, 0.16189323365688324, -0.47375839948654175, -0.07491058856248856, 0.4381066858768463, 0.5278130769729614, 0.8524608612060547, -0.38099122047424316, -0.7161919474601746, 0.567898154258728, 1.4791574478149414, -0.7315996885299683, -0.022451039403676987, -0.15003421902656555, 1.0435733795166016, -0.15809038281440735, -0.05489495024085045, 0.62129807472229, 0.22380368411540985, 0.5910956859588623, 0.29847604036331177, -0.21267811954021454, 0.02505626156926155, -0.5490472912788391, 0.4658685326576233, 2.210387706756592, 0.3308616876602173, -0.2584838569164276, -0.6496047377586365, 0.5837621092796326, -1.3631254434585571, -0.5153311491012573, 0.7042409181594849, 0.9096361398696899, 0.3470025360584259, -0.6084137558937073, -0.24610261619091034, -0.34821248054504395, 0.10957048833370209, 0.5636032819747925, -0.41290199756622314, -0.9308974146842957, 0.2473919838666916, 0.43867334723472595, 0.37871527671813965, 0.6609183549880981, -0.4784511625766754, 0.95533287525177, 14.56117057800293, 1.1145191192626953, -0.2125912606716156, 0.6978961825370789, 0.5912423133850098, 0.0994330421090126, -0.5052642822265625, -0.19760200381278992, -1.4397457838058472, -0.10338053852319717, 1.656882405281067, 0.14757384359836578, 0.019238870590925217, 0.3363979756832123, 0.21032311022281647, 0.03782431781291962, -0.07771959900856018, 0.5510615110397339, 0.5809458494186401, -1.0292613506317139, 0.41259270906448364, 0.07462261617183685, -0.2342509925365448, 0.5220102667808533, 1.0272953510284424, 1.1060899496078491, 0.4558238983154297, -0.48420897126197815, 0.6703552603721619, 0.18188105523586273, 1.1206055879592896, -0.30959993600845337, 0.38415002822875977, 0.5035260915756226, -0.8858988285064697, -0.22793644666671753, -0.6535524725914001, -0.9442632794380188, 0.2620260417461395, 0.031917016953229904, -0.48146042227745056, -0.6529915928840637, -0.12260439991950989, 0.3696494698524475, -0.034930113703012466, 0.3242708742618561, 0.01879814825952053, 1.0323307514190674, -0.2196456491947174, 0.10703607648611069, 0.5626804232597351, 0.6464220285415649, 0.07400316745042801, 0.1843680888414383, -0.06580213457345963, 0.06393080949783325, -0.027131514623761177, 0.37882328033447266, -0.5753417015075684, -0.05537236109375954, -0.3284164369106293, 0.1448248326778412, 0.16422094404697418, 0.5387473702430725, 0.6016570329666138, 0.029510781168937683, -0.6529055833816528, 0.4031834304332733, 0.6580127477645874, 0.18881234526634216, -0.4608043432235718, 0.133016899228096, 0.5941895246505737, -0.26564934849739075, 0.2764303386211395, 0.6753988265991211, 0.13433125615119934, -0.5211595296859741, -0.6950793862342834, -0.15485292673110962, 0.23818711936473846, -0.79292893409729, -0.39361268281936646, 0.9593601226806641, 0.2213936448097229, -0.19221359491348267, -0.08560403436422348, -0.34325161576271057, -0.20239074528217316, 0.2685909569263458, -1.294671654701233, -0.5650928020477295, 0.5860341787338257, -0.4062460958957672, -0.5276325941085815, 0.5844619274139404, 1.4377225637435913, 0.2741473317146301, -0.4031061828136444, 0.3297014534473419, 0.6917755007743835, -0.13872329890727997, -0.438933402299881, -0.6069700717926025, 0.9232694506645203, 0.27476754784584045, -0.002727299928665161, 0.37921497225761414, 0.0026587964966893196, -0.024079378694295883, -0.929542601108551, -0.48290908336639404, 0.853020966053009, -0.7915425896644592, -0.8964968919754028, -0.8816519975662231, -1.2069053649902344, 0.12546782195568085, 0.31293612718582153, 0.001055983710102737, 0.4915241301059723, 0.31133541464805603, -0.5444839000701904, -0.08454115688800812, -0.5315484404563904, 0.1271771937608719, 0.46149539947509766, -0.6288761496543884, -0.04605722054839134, -0.27817270159721375, 0.7453044056892395, -0.9123395681381226, -0.42407965660095215, -0.3376072943210602, 0.11735601723194122, 0.013067095540463924, 0.9566251039505005, -0.2777571976184845, 0.5555172562599182, 1.10175359249115, -0.42139846086502075, -0.7979143261909485, -0.13077504932880402, -0.5096573829650879, -0.6100132465362549, 0.13251765072345734, 0.5661184191703796, 0.11520156264305115, 0.25515225529670715, 1.293688178062439, 0.4058113992214203, -0.7608282566070557, -0.6596866250038147, -0.21530833840370178, 0.3469018340110779, -0.8733641505241394, 0.4739302694797516, -0.41290098428726196, 0.14777405560016632, -0.05598009377717972, 0.26883527636528015, 0.38122671842575073, -0.2789756655693054, -0.8635677099227905, 0.28551411628723145, 0.01676749996840954, 0.046692442148923874, -0.12401501089334488, -0.2953439950942993, -1.5136799812316895, -0.04444834962487221, -0.7694909572601318, 0.0978424921631813, -0.572166919708252, -0.13644959032535553, -0.2635968327522278, -0.2972530722618103, 0.01316846814006567, 0.033957891166210175, -0.1858503371477127, -0.3354177474975586, -0.2935903072357178, -0.9550135135650635, 0.8532225489616394, 0.457820326089859, -0.3629671037197113, 0.08194777369499207, -0.1038273498415947, 0.23344473540782928, 0.2206023782491684, 0.2810262441635132, -0.4782557785511017, -0.7135230898857117, -1.3264306783676147, 0.08973757177591324, -0.15493500232696533, -0.07442067563533783, -0.5757327675819397, 0.5709095597267151, 0.36996620893478394, -0.20324291288852692, -0.11277561634778976, 0.5181288123130798, -0.789968729019165, -0.5561403036117554, 0.2411840856075287, -0.7678554058074951, 0.49771347641944885, 0.3646817207336426, -0.4558175504207611, -0.40735289454460144, 0.7493095397949219, -0.11961988359689713, -1.0107568502426147, -1.0611028671264648, 0.4616081714630127, -0.8930831551551819, 0.14254911243915558, -0.7174142599105835, 0.009851890616118908, -0.9780756235122681, -0.6444189548492432, 0.21790237724781036, 0.15053541958332062, -0.14240311086177826, 1.1081613302230835, 0.7819713354110718, -1.115715742111206, 0.17131654918193817, 0.6235630512237549, 0.016532883048057556, 0.1768493503332138, 0.6662821769714355, 0.4075353443622589, -0.2983127236366272, 0.9704892039299011, 0.7601856589317322, 0.2245345115661621, -1.4184565544128418, 0.14740531146526337, 0.3225577771663666, -0.4439745843410492, -0.4425133764743805, 1.1989275217056274, -0.35140058398246765, -0.8160430192947388, 0.10319660604000092, -1.6131373643875122, -0.6916673183441162, -0.6474303603172302, 0.8785712122917175, 0.055670738220214844, 0.21110817790031433, -0.6086546778678894, -0.7735257744789124, -0.014361245557665825, -0.327115535736084, -0.574306845664978, 0.439782053232193, -0.3579483926296234, -0.42520952224731445, 0.5255370140075684, 1.1057257652282715, -0.6286131143569946, -0.5742602944374084, -0.7763687968254089, -0.3168034851551056, -0.21864497661590576, 0.8080925345420837, -0.26525622606277466, -0.35576701164245605, 0.6903321146965027, 0.40030935406684875, -0.01244969479739666, 0.1473858505487442, -0.13508109748363495, 0.7079672813415527, 0.4412650763988495, 0.19386042654514313, -0.7108736038208008, -0.979807436466217, 1.3587334156036377, 1.014721155166626, -0.6157798767089844, 0.40155619382858276, 0.24526163935661316, -0.7122084498405457, 0.5856151580810547, 0.5383100509643555, 0.22155506908893585, 0.9891024231910706, 0.06155765801668167, 0.31324926018714905, 0.15726220607757568, -1.5449508428573608, -0.05162652209401131, 0.721723735332489, 0.914699375629425, 0.7798557877540588, 0.33133256435394287, 0.28931015729904175, 1.0072877407073975, 0.37629133462905884, 0.2875198423862457, 0.28521642088890076, 0.7951080799102783, -0.4602259397506714, -0.08331897854804993, -0.09016060084104538, 0.9806383848190308, -1.057550311088562, -1.2798610925674438, 0.37401777505874634, 0.6954751014709473, 0.09251973778009415, 0.4326007664203644, 1.0672802925109863, -0.054431166499853134, 0.3057386875152588, 0.4832670986652374, 0.3250732421875, -0.6175302863121033, -0.3628278076648712, -0.0027755810879170895, -0.6422710418701172, -0.06419877707958221, 0.26436343789100647, -0.19303211569786072, -0.42962348461151123, -0.6862995624542236, 0.009836147539317608, 0.3306732475757599, 0.06643722206354141, 0.7846433520317078, 0.6514748930931091, 0.33094900846481323, -0.571872889995575, -0.2913876473903656, -0.4500690996646881, -0.9107201099395752, -0.4824439287185669, -0.5297581553459167, -0.26920706033706665, 0.035061661154031754, 0.02762898989021778, -0.49724990129470825]}, "authors": [{"authorId": "2312668682", "name": "Hanlin Tang"}, {"authorId": null, "name": "Yang Lin"}, {"authorId": "2313021663", "name": "Jing Lin"}, {"authorId": "2312408262", "name": "Qingsen Han"}, {"authorId": "2312579700", "name": "Shikuan Hong"}, {"authorId": "2312435704", "name": "Yiwu Yao"}, {"authorId": "2312678806", "name": "Gongyi Wang"}], "references": [{"paperId": "2f96229c404a5cbd0c0d06492f5ea3d6bfcf50d2", "title": "PyramidInfer: Pyramid KV Cache Compression for High-throughput LLM Inference"}, {"paperId": "3fd5bc3077d04965eaa3498372c39bbdd09d55e4", "title": "Leave No Context Behind: Efficient Infinite Context Transformers with Infini-attention"}, {"paperId": "d53fe76bd2795a19ddf52d012917782f6f6f2c1e", "title": "Griffin: Mixing Gated Linear Recurrences with Local Attention for Efficient Language Models"}, {"paperId": "f288e2238ac8725baa7ca9874bbc3fed1e89a632", "title": "Data Engineering for Scaling Language Models to 128K Context"}, {"paperId": "b085968c4362fb286ad6c5ef71a5db9630da0498", "title": "KVQuant: Towards 10 Million Context Length LLM Inference with KV Cache Quantization"}, {"paperId": "fdc53c2c10742464087c0525f77e32604827a21d", "title": "Efficient Streaming Language Models with Attention Sinks"}, {"paperId": "c96297261467b5daa2d01227496a70d444602434", "title": "Baichuan 2: Open Large-scale Language Models"}, {"paperId": "e586a4591ba0303b769f2c07cbddaf1899cb72e4", "title": "H2O: Heavy-Hitter Oracle for Efficient Generative Inference of Large Language Models"}, {"paperId": "6bd3ee1ca608bc66a490f63f2fb107d79b44f3e2", "title": "LLM-QAT: Data-Free Quantization Aware Training for Large Language Models"}, {"paperId": "d6eeb2898bd9bd34744194ef543062dda6c4531a", "title": "Scissorhands: Exploiting the Persistence of Importance Hypothesis for LLM KV Cache Compression at Test Time"}, {"paperId": "026b3396a63ed5772329708b7580d633bb86bec9", "title": "RWKV: Reinventing RNNs for the Transformer Era"}, {"paperId": "5ae6fb6b5a3c7df515ff4a82ac9673bae6a8e200", "title": "GQA: Training Generalized Multi-Query Transformer Models from Multi-Head Checkpoints"}, {"paperId": "42a14d824caa3348046eb34c37e2ab7985faa7a3", "title": "High-throughput Generative Inference of Large Language Models with a Single GPU"}, {"paperId": "2c994fadbb84fb960d8306ee138dbeef41a5b323", "title": "SmoothQuant: Accurate and Efficient Post-Training Quantization for Large Language Models"}, {"paperId": "3f6243097a58e386aea1215fed4f372dee07a100", "title": "Outlier Suppression: Pushing the Limit of Low-bit Transformer Language Models"}, {"paperId": "9ca329408813d209b1dcb36936f7f9cba82506bd", "title": "Train Short, Test Long: Attention with Linear Biases Enables Input Length Extrapolation"}, {"paperId": "dc52b09089704ebd6f471177474bc29741c50023", "title": "Fast Transformer Decoding: One Write-Head is All You Need"}, {"paperId": "10eda4521c032adabaa8e70d6569e17370b29dcd", "title": "Root Mean Square Layer Normalization"}, {"paperId": "21da617a0f79aabf94272107184606cefe90ab75", "title": "Generating Long Sequences with Sparse Transformers"}, {"paperId": "81051b830a4f5606106765902a51ba281c9230f9", "title": "Outlier Suppression+: Accurate quantization of large language models by equivalent and optimal shifting and scaling"}, {"paperId": null, "title": ": Generalized models and efficient algorithms through structured state space"}, {"paperId": null, "title": "Model tells you"}, {"paperId": null, "title": "Dynamic kv cache compression based on pyramidal information"}, {"paperId": null, "title": "Linear-time"}, {"paperId": null, "title": "Kivi : Plug-and-play 2bit kv cache quantization with streaming asymmetric quantization"}, {"paperId": null, "title": "Low-bit quantization for"}, {"paperId": null, "title": "Needle In A Haystack - Pressure Testing"}, {"paperId": null, "title": "Retrieval head mechanistically explains"}]}